<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQÂéªÈáçÂ∑•ÂÖ∑</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .step {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: #3498db;
            background: #f8f9ff;
        }

        .step.completed {
            border-color: #27ae60;
            background: #f0f8f0;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: #e0e0e0;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step.active .step-number {
            background: #3498db;
        }

        .step.completed .step-number {
            background: #27ae60;
        }

        .step-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .upload-section {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }

        .upload-section.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .file-input {
            display: none;
        }

        .upload-btn, .process-btn, .download-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 10px;
        }

        .upload-btn:hover, .process-btn:hover, .download-btn:hover {
            background: #2980b9;
        }

        .process-btn {
            background: #27ae60;
            width: 100%;
            padding: 15px;
            font-size: 18px;
        }

        .process-btn:hover {
            background: #229954;
        }

        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .download-btn {
            background: #e74c3c;
        }

        .download-btn:hover {
            background: #c0392b;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
            display: none;
        }

        .progress-bar {
            display: none;
            width: 100%;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .log-section {
            display: none;
            margin-top: 20px;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }

        .error {
            color: #e74c3c;
            background: #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: #d5f4e6;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }

        .merge-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        .merge-item {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            font-size: 0.9em;
        }

        .merge-item:last-child {
            border-bottom: none;
        }

        .merge-question {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .merge-models {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 11px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .processing-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã FAQÂéªÈáçÂ∑•ÂÖ∑</h1>
        <p class="subtitle">Excel ‚Üí JSON ‚Üí ÂéªÈáçÂêàÂπ∂ ‚Üí Excel ‰∏ÄÁ´ôÂºèÂ§ÑÁêÜ</p>
        
        <!-- Ê≠•È™§1: ‰∏ä‰º†ExcelÊñá‰ª∂ -->
        <div class="step active" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">‰∏ä‰º†ExcelÊñá‰ª∂</div>
            </div>
            <div class="upload-section" id="uploadSection">
                <h3>üìÅ ÈÄâÊã©ÊàñÊãñÊãΩExcelÊñá‰ª∂</h3>
                <p>ÊîØÊåÅ .xlsx, .xls Ê†ºÂºè</p>
                <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    ÈÄâÊã©Êñá‰ª∂
                </button>
            </div>
            <div class="file-info" id="fileInfo">
                <div id="fileName"></div>
                <div id="fileSize"></div>
            </div>
            
            <!-- Â∑•‰ΩúË°®ÈÄâÊã© -->
            <div id="sheetSelection" class="hidden" style="margin-top: 15px;">
                <label>ÈÄâÊã©Â∑•‰ΩúË°®: </label>
                <select id="sheetSelect" onchange="loadSelectedSheet()">
                </select>
            </div>
        </div>

        <!-- Ê≠•È™§2: Êï∞ÊçÆÈ¢ÑËßà‰∏éÂ§ÑÁêÜ -->
        <div class="step" id="step2">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Êï∞ÊçÆÈ¢ÑËßà‰∏éÂ§ÑÁêÜ</div>
            </div>
            <div class="stats" id="originalStats">
                <div class="stat-card">
                    <div class="stat-number" id="originalCount">0</div>
                    <div class="stat-label">ÂéüÂßãÊù°ÁõÆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="originalFields">0</div>
                    <div class="stat-label">Â≠óÊÆµÊï∞Èáè</div>
                </div>
            </div>
            <button class="process-btn" id="processBtn" disabled onclick="startProcessing()">
                üîÑ ÂºÄÂßãÂ§ÑÁêÜÊï∞ÊçÆ
            </button>
        </div>

        <!-- Ê≠•È™§3: Â§ÑÁêÜÁªìÊûú -->
        <div class="step" id="step3">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Â§ÑÁêÜÁªìÊûú</div>
            </div>
            <div class="stats" id="processedStats">
                <div class="stat-card">
                    <div class="stat-number" id="processedCount">0</div>
                    <div class="stat-label">Â§ÑÁêÜÂêéÊù°ÁõÆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="reducedCount">0</div>
                    <div class="stat-label">ÂáèÂ∞ëÊù°ÁõÆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="reductionRate">0%</div>
                    <div class="stat-label">ÂéãÁº©Áéá</div>
                </div>
            </div>
            
            <div class="merge-details hidden" id="mergeDetails"></div>
        </div>

        <!-- Ê≠•È™§4: ‰∏ãËΩΩÁªìÊûú -->
        <div class="step" id="step4">
            <div class="step-header">
                <div class="step-number">4</div>
                <div class="step-title">‰∏ãËΩΩÂ§ÑÁêÜÁªìÊûú</div>
            </div>
            <div style="text-align: center;">
                <button class="download-btn" id="downloadBtn" disabled onclick="downloadExcel()">
                    üì• ‰∏ãËΩΩÂ§ÑÁêÜÂêéÁöÑExcelÊñá‰ª∂
                </button>
            </div>
        </div>

        <!-- ËøõÂ∫¶Êù° -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Êó•ÂøóÂå∫Âüü -->
        <div class="log-section" id="logSection"></div>
    </div>

    <!-- Â§ÑÁêÜ‰∏≠ÈÅÆÁΩ© -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="spinner"></div>
            <h3>Ê≠£Âú®Â§ÑÁêÜÊï∞ÊçÆ...</h3>
            <p id="processingStatus">ËØ∑Á®çÂÄô</p>
        </div>
    </div>

    <script>
        let originalData = null;
        let processedData = null;
        let workbook = null;
        let currentFileName = '';

        // Êñá‰ª∂ÊãñÊãΩÂ§ÑÁêÜ
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Â§ÑÁêÜ‰∏ä‰º†ÁöÑÊñá‰ª∂
        function handleFile(file) {
            hideMessages();
            
            // È™åËØÅÊñá‰ª∂Á±ªÂûã
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                showError('ËØ∑ÈÄâÊã©ExcelÊ†ºÂºèÁöÑÊñá‰ª∂Ôºà.xlsx Êàñ .xlsÔºâÔºÅ');
                return;
            }

            currentFileName = file.name.replace(/\.(xlsx|xls)$/i, '');

            // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
            document.getElementById('fileName').innerHTML = `<strong>Êñá‰ª∂ÂêçÔºö</strong>${file.name}`;
            document.getElementById('fileSize').innerHTML = `<strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${formatFileSize(file.size)}`;
            document.getElementById('fileInfo').style.display = 'block';

            showProgress(0);
            logMessage(`ÂºÄÂßãËØªÂèñÊñá‰ª∂: ${file.name}`);

            // ËØªÂèñExcelÊñá‰ª∂
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateProgress(25);
                    
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    updateProgress(50);
                    
                    // ÊòæÁ§∫Â∑•‰ΩúË°®ÈÄâÊã©
                    populateSheetSelection();
                    document.getElementById('sheetSelection').classList.remove('hidden');
                    
                    // ÈªòËÆ§Âä†ËΩΩÁ¨¨‰∏Ä‰∏™Â∑•‰ΩúË°®
                    if (workbook.SheetNames.length > 0) {
                        loadSheet(workbook.SheetNames[0]);
                    }
                    
                    updateProgress(100);
                    setTimeout(() => {
                        hideProgress();
                        showSuccess('ExcelÊñá‰ª∂ËØªÂèñÊàêÂäüÔºÅ');
                        completeStep(1);
                        activateStep(2);
                        document.getElementById('processBtn').disabled = false;
                        logMessage('ExcelÊñá‰ª∂Ëß£ÊûêÂÆåÊàê');
                    }, 500);
                } catch (error) {
                    hideProgress();
                    showError('ExcelÊñá‰ª∂Ëß£ÊûêÈîôËØØÔºö' + error.message);
                    logMessage(`Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
                }
            };

            reader.onerror = function() {
                hideProgress();
                showError('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºÅ');
            };

            reader.readAsArrayBuffer(file);
        }

        // Â°´ÂÖÖÂ∑•‰ΩúË°®ÈÄâÊã©‰∏ãÊãâÊ°Ü
        function populateSheetSelection() {
            const sheetSelect = document.getElementById('sheetSelect');
            sheetSelect.innerHTML = '';
            
            workbook.SheetNames.forEach((sheetName, index) => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                if (index === 0) option.selected = true;
                sheetSelect.appendChild(option);
            });
        }

        // Âä†ËΩΩÈÄâ‰∏≠ÁöÑÂ∑•‰ΩúË°®
        function loadSelectedSheet() {
            const sheetSelect = document.getElementById('sheetSelect');
            const selectedSheet = sheetSelect.value;
            if (selectedSheet) {
                loadSheet(selectedSheet);
            }
        }

        // Âä†ËΩΩÊåáÂÆöÂ∑•‰ΩúË°®
        function loadSheet(sheetName) {
            if (!workbook || !workbook.Sheets[sheetName]) {
                showError('Â∑•‰ΩúË°®‰∏çÂ≠òÂú®Ôºö' + sheetName);
                return;
            }

            try {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: ''
                });

                if (jsonData.length === 0) {
                    throw new Error('Â∑•‰ΩúË°®‰∏∫Á©∫');
                }

                // ÊèêÂèñË°®Â§¥
                const headers = jsonData[0].map(header => String(header || ''));
                
                // ËΩ¨Êç¢Êï∞ÊçÆ‰∏∫ÂØπË±°Ê†ºÂºè
                originalData = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const record = {};
                    
                    for (let j = 0; j < headers.length; j++) {
                        const value = row[j];
                        record[headers[j]] = value !== undefined ? String(value) : '';
                    }
                    
                    // Âè™Ê∑ªÂä†ÈùûÁ©∫Ë°å
                    const hasData = Object.values(record).some(val => val.trim() !== '');
                    if (hasData) {
                        originalData.push(record);
                    }
                }

                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                document.getElementById('originalCount').textContent = originalData.length;
                document.getElementById('originalFields').textContent = headers.length;
                
                logMessage(`Â∑•‰ΩúË°®Âä†ËΩΩÂÆåÊàê: ${sheetName}, ${originalData.length} Êù°ËÆ∞ÂΩï`);

            } catch (error) {
                showError('Âä†ËΩΩÂ∑•‰ΩúË°®Â§±Ë¥•Ôºö' + error.message);
            }
        }

        // ÂºÄÂßãÂ§ÑÁêÜÊï∞ÊçÆ
        function startProcessing() {
            if (!originalData || originalData.length === 0) {
                showError('Ê≤°ÊúâÂèØÂ§ÑÁêÜÁöÑÊï∞ÊçÆ');
                return;
            }

            showProcessingOverlay();
            document.getElementById('processingStatus').textContent = 'Ê≠£Âú®Â§ÑÁêÜFAQÊï∞ÊçÆ...';
            
            setTimeout(() => {
                processFAQData();
            }, 100);
        }

        // Â§ÑÁêÜFAQÊï∞ÊçÆ
        function processFAQData() {
            try {
                logMessage('ÂºÄÂßãÂ§ÑÁêÜFAQÊï∞ÊçÆ...');
                
                // ÂéªÊéâindexÂ≠óÊÆµ
                let cleanedData = originalData.map(item => {
                    const cleaned = { ...item };
                    if ('index' in cleaned) {
                        delete cleaned.index;
                    }
                    if ('Index' in cleaned) {
                        delete cleaned.Index;
                    }
                    return cleaned;
                });

                logMessage('Â∑≤ÁßªÈô§indexÂ≠óÊÆµ');

                // Êåâanswer+questionËøõË°åÂàÜÁªÑ
                const grouped = {};
                const mergeDetails = [];

                cleanedData.forEach((item, index) => {
                    try {
                        const faqContent = JSON.parse(item.faq);
                        const key = `${faqContent.answer.trim()}|||${faqContent.question.trim()}`;
                        
                        if (!grouped[key]) {
                            grouped[key] = [];
                        }
                        
                        grouped[key].push({
                            model: faqContent.model.trim().replace(/\s+/g, ''),
                            answer: faqContent.answer.trim(),
                            question: faqContent.question.trim()
                        });
                    } catch (error) {
                        logMessage(`Ëß£ÊûêÁ¨¨ ${index + 1} Êù°ËÆ∞ÂΩïÊó∂Âá∫Èîô: ${error.message}`);
                    }
                });

                logMessage('Êï∞ÊçÆÂàÜÁªÑÂÆåÊàê');

                // ÂêàÂπ∂Áõ∏ÂêåÁöÑÊù°ÁõÆ
                processedData = [];
                let mergedCount = 0;

                Object.entries(grouped).forEach(([key, items]) => {
                    // Â∞ÜÊâÄÊúâmodelÂ≠óÊÆµÊåâÈÄóÂè∑ÂàÜÂâ≤ÔºåÁÑ∂ÂêéÂêàÂπ∂ÂéªÈáç
                    const allModels = [];
                    items.forEach(item => {
                        const modelList = item.model.replace(/\s+/g, '').split(',').filter(m => m.trim() !== '');
                        allModels.push(...modelList);
                    });
                    const models = [...new Set(allModels)].sort();
                    const mergedModel = models.join(',');
                    
                    const faqJson = `{"answer":${JSON.stringify(items[0].answer)},"model":${JSON.stringify(mergedModel)},"question":${JSON.stringify(items[0].question)}}`;
                    
                    processedData.push({
                        faq: faqJson
                    });

                    if (models.length > 1) {
                        mergedCount++;
                        mergeDetails.push({
                            question: items[0].question,
                            models: models,
                            mergedModel: mergedModel,
                            count: items.length
                        });
                    }
                });

                // ÊåâÈóÆÈ¢òÊéíÂ∫è
                processedData.sort((a, b) => {
                    const aQuestion = JSON.parse(a.faq).question;
                    const bQuestion = JSON.parse(b.faq).question;
                    return aQuestion.localeCompare(bQuestion);
                });

                // Êõ¥Êñ∞ÁªìÊûúÁªüËÆ°
                const originalCount = originalData.length;
                const finalCount = processedData.length;
                const reducedCount = originalCount - finalCount;
                const reductionRate = ((reducedCount / originalCount) * 100).toFixed(1);

                document.getElementById('processedCount').textContent = finalCount;
                document.getElementById('reducedCount').textContent = reducedCount;
                document.getElementById('reductionRate').textContent = reductionRate + '%';

                // ÊòæÁ§∫ÂêàÂπ∂ËØ¶ÊÉÖ
                if (mergeDetails.length > 0) {
                    const mergeDetailsContainer = document.getElementById('mergeDetails');
                    let detailsHtml = '<h4>üîó ÂêàÂπ∂ËØ¶ÊÉÖ</h4>';
                    mergeDetails.slice(0, 10).forEach(detail => {
                        detailsHtml += `
                            <div class="merge-item">
                                <div class="merge-question">${detail.question.substring(0, 80)}...</div>
                                <div class="merge-models">ÂêàÂπ∂Ê®°Âûã: ${detail.mergedModel}</div>
                                <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                    ÂéüÂßã ${detail.count} Êù°ËÆ∞ÂΩï ‚Üí ÂêàÂπ∂‰∏∫ 1 Êù°ËÆ∞ÂΩï
                                </div>
                            </div>
                        `;
                    });
                    if (mergeDetails.length > 10) {
                        detailsHtml += `<div style="text-align: center; color: #666; margin-top: 10px;">ËøòÊúâ ${mergeDetails.length - 10} Êù°ÂêàÂπ∂ËÆ∞ÂΩï...</div>`;
                    }
                    mergeDetailsContainer.innerHTML = detailsHtml;
                    mergeDetailsContainer.classList.remove('hidden');
                }

                hideProcessingOverlay();
                showSuccess(`Â§ÑÁêÜÂÆåÊàêÔºÅÂéüÂßã ${originalCount} Êù° ‚Üí Â§ÑÁêÜÂêé ${finalCount} Êù°ÔºåÂáèÂ∞ë ${reducedCount} Êù° (${reductionRate}%)`);
                
                completeStep(2);
                completeStep(3);
                activateStep(4);
                document.getElementById('downloadBtn').disabled = false;
                
                logMessage(`Êï∞ÊçÆÂ§ÑÁêÜÂÆåÊàê: ÂéüÂßã${originalCount}Êù° ‚Üí Â§ÑÁêÜÂêé${finalCount}Êù°`);

            } catch (error) {
                hideProcessingOverlay();
                showError('Â§ÑÁêÜÊï∞ÊçÆÊó∂Âá∫ÈîôÔºö' + error.message);
                logMessage(`Â§ÑÁêÜÂ§±Ë¥•: ${error.message}`);
            }
        }

        // ‰∏ãËΩΩExcelÊñá‰ª∂
        function downloadExcel() {
            if (!processedData || processedData.length === 0) {
                showError('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÊï∞ÊçÆ');
                return;
            }

            try {
                showProcessingOverlay();
                document.getElementById('processingStatus').textContent = 'Ê≠£Âú®ÁîüÊàêExcelÊñá‰ª∂...';

                setTimeout(() => {
                    // ÂàõÂª∫Â∑•‰ΩúÁ∞ø
                    const wb = XLSX.utils.book_new();
                    
                    // Â∞ÜJSONËΩ¨Êç¢‰∏∫Â∑•‰ΩúË°®
                    const ws = XLSX.utils.json_to_sheet(processedData);
                    
                    // Ê∑ªÂä†Â∑•‰ΩúË°®Âà∞Â∑•‰ΩúÁ∞ø
                    XLSX.utils.book_append_sheet(wb, ws, 'ProcessedFAQ');
                    
                    // ÁîüÊàêExcelÊñá‰ª∂Âπ∂‰∏ãËΩΩ
                    const excelFileName = `${currentFileName}_processed_${new Date().getTime()}.xlsx`;
                    XLSX.writeFile(wb, excelFileName);
                    
                    hideProcessingOverlay();
                    showSuccess(`‚úÖ ExcelÊñá‰ª∂Â∑≤ÁîüÊàêÂπ∂‰∏ãËΩΩ: ${excelFileName}`);
                    completeStep(4);
                    
                    logMessage(`ExcelÊñá‰ª∂‰∏ãËΩΩÂÆåÊàê: ${excelFileName}`);
                }, 1000);

            } catch (error) {
                hideProcessingOverlay();
                showError('ÁîüÊàêExcelÊñá‰ª∂Â§±Ë¥•Ôºö' + error.message);
                logMessage(`ExcelÁîüÊàêÂ§±Ë¥•: ${error.message}`);
            }
        }

        // Ê≠•È™§ÁÆ°ÁêÜ
        function activateStep(stepNumber) {
            document.getElementById(`step${stepNumber}`).classList.add('active');
        }

        function completeStep(stepNumber) {
            const step = document.getElementById(`step${stepNumber}`);
            step.classList.remove('active');
            step.classList.add('completed');
        }

        // ËøõÂ∫¶Êù°
        function showProgress(percent = 0) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.display = 'block';
            updateProgress(percent);
        }

        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // Â§ÑÁêÜ‰∏≠ÈÅÆÁΩ©
        function showProcessingOverlay() {
            document.getElementById('processingOverlay').style.display = 'flex';
        }

        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').style.display = 'none';
        }

        // Ê∂àÊÅØÂ§ÑÁêÜ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = '‚ùå ' + message;
            document.querySelector('.container').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = '‚úÖ ' + message;
            document.querySelector('.container').appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function hideMessages() {
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
        }

        // Êó•ÂøóÂ§ÑÁêÜ
        function logMessage(message) {
            const logSection = document.getElementById('logSection');
            logSection.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            logSection.innerHTML += `[${timestamp}] ${message}\n`;
            logSection.scrollTop = logSection.scrollHeight;
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>

