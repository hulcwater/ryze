<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zendesk Â∑•ÂçïÁ≥ªÁªü - ÂÆ¢ÊúçÂ∑•ÂçïËæÖÂä©ÂõûÂ§çÂ∑•ÂÖ∑ÊºîÁ§∫</title>
  <style>
    :root {
      --primary-color: #6366f1; /* Indigo 500 */
      --primary-hover: #4f46e5; /* Indigo 600 */
      --bg-color: #f3f4f6; /* Gray 100 */
      --card-bg: #ffffff;
      --text-main: #111827; /* Gray 900 */
      --text-secondary: #6b7280; /* Gray 500 */
      --border-color: #e5e7eb; /* Gray 200 */
      --success-color: #10b981; /* Emerald 500 */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius-md: 8px;
      --radius-lg: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.5;
      overflow: hidden;
    }

    /* È°∂ÈÉ®Ê†áÁ≠æÊ†è */
    .top-tabs {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 0 20px;
      display: flex;
      align-items: center;
      height: 48px;
    }

    .tab-item {
      padding: 8px 16px;
      background: #fff;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-item.active {
      color: #03363d;
      border-bottom-color: #03363d;
    }

    .tab-item .close-icon {
      opacity: 0.5;
      cursor: pointer;
    }

    .tab-item .close-icon:hover {
      opacity: 1;
    }

    .add-tab {
      padding: 8px;
      color: #666;
      cursor: pointer;
      font-size: 18px;
    }

    /* Èù¢ÂåÖÂ±ëÂØºËà™ */
    .breadcrumb {
      background: #fff;
      padding: 12px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .breadcrumb-item {
      color: #666;
    }

    .breadcrumb-item.active {
      color: #03363d;
      font-weight: 500;
    }

    .badge-new {
      background: #28a745;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    /* ‰∏ªÂÆπÂô® */
    .main-container {
      display: flex;
      height: calc(100vh - 96px);
    }

    /* Â∑¶‰æßÂØºËà™Ê†è */
    .sidebar {
      width: 64px;
      background: #03363d;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 0;
      gap: 24px;
    }

    .sidebar-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .sidebar-icon:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .sidebar-logo {
      margin-top: auto;
      font-size: 24px;
      font-weight: bold;
      color: #fff;
    }

    /* ‰∏≠Â§ÆÂ∑¶‰æßÈù¢Êùø - Â∑•ÂçïËØ¶ÊÉÖ */
    .left-panel {
      width: 400px;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
    }

    .field-group {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .field-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .field-value {
      font-size: 14px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .field-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 14px;
    }

    .link-action {
      color: #03363d;
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: #e8f4f8;
      color: #03363d;
      border-radius: 12px;
      font-size: 12px;
    }

    .tag-remove {
      cursor: pointer;
      opacity: 0.6;
    }

    .tag-remove:hover {
      opacity: 1;
    }

    /* Âè≥‰æß‰∏ªÈù¢Êùø - ÂØπËØùÂå∫Âüü */
    .right-panel {
      flex: 1;
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .conversation-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .conversation-title {
      font-size: 18px;
      font-weight: 600;
      color: #03363d;
      margin-bottom: 8px;
    }

    .conversation-meta {
      font-size: 13px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      margin-left: auto;
    }

    .header-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      cursor: pointer;
      color: #666;
    }

    .header-icon:hover {
      background: #f0f0f0;
    }

    .conversation-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message-item {
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .message-author {
      font-weight: 500;
      font-size: 14px;
      color: #333;
    }

    .message-time {
      font-size: 12px;
      color: #999;
    }

    .message-bubble {
      background: #e8f4f8;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      max-width: 600px;
    }

    /* ÂõûÂ§çÂå∫Âüü */
    .reply-area {
      border-top: 1px solid #e0e0e0;
      background: #fff;
    }

    /* Â∑•ÂÖ∑ÂåÖÈù¢Êùø - Âè≥‰æßÊäΩÂ±â */
    .toolkit-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 720px;
      height: 100vh;
      background: var(--bg-color);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(100%);
    }

    .toolkit-panel.show {
      transform: translateX(0);
    }

    .toolkit-header {
      padding: 16px 24px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toolkit-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toolkit-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
      font-size: 20px;
    }

    .toolkit-close:hover {
      background: #f3f4f6;
      color: var(--text-main);
    }

    /* TabÂØºËà™ */
    .tab-nav {
      display: flex;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 0 16px;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--primary-color);
    }

    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-icon {
      font-size: 16px;
    }

    .toolkit-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* TabÂÜÖÂÆπ */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Â∑•ÂÖ∑Ê†è */
    .reply-toolbar {
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8f9fa;
    }

    .toolbar-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      color: #666;
      font-size: 16px;
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: #e0e0e0;
    }

    .toolbar-btn.active {
      background: #03363d;
      color: #fff;
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: #e0e0e0;
      margin: 0 4px;
    }

    .toolbar-btn-special {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 12px;
      padding: 6px 12px;
      width: auto;
      height: auto;
      border-radius: 4px;
      font-weight: 500;
    }

    .toolbar-btn-special:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* ÂõûÂ§çËæìÂÖ•Âå∫Âüü */
    .reply-input-area {
      padding: 12px;
    }

    .reply-type {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #666;
    }

    .reply-type-select {
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }

    .reply-to {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #666;
    }

    .reply-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 12px;
    }

    .reply-textarea:focus {
      outline: none;
      border-color: #03363d;
    }

    /* ‰ø°ÊÅØÂå∫Âùó */
    .info-section {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title .icon {
      font-size: 18px;
    }

    .info-card {
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
    }

    /* ‰ø°ÊÅØË°åÊ†∑Âºè */
    .info-row {
      display: flex;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 12px;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 90px;
      flex-shrink: 0;
    }

    .info-value {
      font-size: 14px;
      color: var(--text-main);
      flex: 1;
      font-weight: 500;
      word-break: break-all;
    }

    .info-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-main);
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #f9fafb;
    }

    .info-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Âú∫ÊôØ‰ø°ÊÅØ */
    .scenario-badge {
      display: inline-block;
      padding: 6px 12px;
      background: #eef2ff;
      color: var(--primary-color);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .scenario-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Âª∫ËÆÆÂÜÖÂÆπ */
    .node-recommendation {
      padding: 12px;
      background: #eef2ff;
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--primary-color);
      line-height: 1.6;
      border-left: 3px solid var(--primary-color);
      font-weight: 500;
      margin-bottom: 16px;
    }

    /* Âä®‰ΩúÈÄâÈ°π */
    .action-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .action-item {
      padding: 14px 16px;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    .action-item:hover {
      border-color: var(--primary-color);
      background: #f5f3ff;
    }

    .action-item.selected {
      border-color: var(--primary-color);
      background: #eef2ff;
      box-shadow: 0 0 0 1px var(--primary-color);
    }

    .action-item input[type="radio"] {
      margin: 0;
      accent-color: var(--primary-color);
      width: 16px;
      height: 16px;
    }

    .action-item label {
      flex: 1;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    /* ÈÇÆ‰ª∂ÁºñËæëÂô® */
    .email-editor {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .email-editor:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .email-preview {
      min-height: 150px;
      max-height: 300px;
      overflow-y: auto;
      padding: 16px;
      background: #f8fafc;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-main);
      white-space: pre-wrap;
    }

    .email-textarea {
      width: 100%;
      min-height: 300px;
      padding: 16px;
      border: none;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      line-height: 1.6;
      color: var(--text-main);
      background: #fff;
    }

    .email-textarea:focus {
      outline: none;
    }

    .email-toolbar {
      padding: 10px 16px;
      background: #f9fafb;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ‰ø°ÊÅØË°åÊ†∑Âºè */
    .info-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-size: 13px;
      color: #666;
      min-width: 100px;
      flex-shrink: 0;
    }

    .info-value {
      font-size: 13px;
      color: #333;
      flex: 1;
    }

    .info-input {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
    }

    .info-input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ‰∫ßÂìÅÂàóË°® */
    .product-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: #fff;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .product-item:last-child {
      margin-bottom: 0;
    }

    .product-image {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      object-fit: cover;
      background: #f0f0f0;
    }

    .product-info {
      flex: 1;
    }

    .product-model {
      font-weight: 600;
      font-size: 13px;
      color: #333;
      margin-bottom: 4px;
    }

    .product-name {
      font-size: 12px;
      color: #666;
    }

    .edit-btn {
      margin-left: auto;
      padding: 4px 8px;
      background: #f0f0f0;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      transition: all 0.2s;
    }

    .edit-btn:hover {
      background: #e0e0e0;
      color: #333;
    }

    .edit-mode {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      height: auto;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #666;
      border: 1px solid #e0e0e0;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
      color: #333;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title .icon {
      font-size: 16px;
    }

    .action-section {
      margin-top: 24px;
    }

    /* Ë°®Ê†ºÊ†∑Âºè */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th {
      background: #f9fafb;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.05em;
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .data-table td {
      padding: 12px 16px;
      color: var(--text-main);
      border-bottom: 1px solid var(--border-color);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background: #f9fafb;
    }

    .empty-state {
      padding: 32px 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      background: #f9fafb;
      border-radius: var(--radius-md);
      border: 1px dashed var(--border-color);
    }

    .info-section {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .main-content {
      display: flex;
      flex-direction: column;
      /* gap: 8px; */
    }

    .quick-reply-content,
    .customer-info-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .email-placeholder {
      color: #999;
      text-align: center;
      padding: 40px 20px;
    }

    .email-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #667eea;
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background: #5568d3;
    }

    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: #fff;
    }

    .btn-success:hover:not(:disabled) {
      background: #218838;
    }

    /* Âä†ËΩΩÁä∂ÊÄÅ */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 12px;
      color: #666;
    }

    .hidden {
      display: none !important;
    }

    /* ÊªöÂä®Êù°Ê†∑Âºè */
    .conversation-content::-webkit-scrollbar,
    .toolkit-panel::-webkit-scrollbar {
      width: 6px;
    }

    .conversation-content::-webkit-scrollbar-track,
    .toolkit-panel::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .conversation-content::-webkit-scrollbar-thumb,
    .toolkit-panel::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }
    /* Âø´Êç∑Â§ÑÁêÜ - ‰∏§‰∏™Âõ∫ÂÆöÊ®°Âùó */
    .quick-process-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #f8fafc; /*Á®çÂæÆÁÅ∞‰∏ÄÁÇπÁöÑËÉåÊôØÔºåÁ™ÅÂá∫Âç°ÁâáÊÑü*/
      overflow-y: auto;
      /* padding: 16px;  */
      gap: 16px; /* Â¢ûÂä†Ê®°ÂùóÈó¥Ë∑ù */
    }

    /* ÂàÜÊûêÊ®°Âùó */
    .analysis-module {
      padding: 24px; /* Â¢ûÂä†ÂÜÖËæπË∑ù */
      background: #fff;
      border-radius: 12px; /* ÂúÜËßíÂ¢ûÂä† */
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Ê∑ªÂä†ËΩªÂæÆÈò¥ÂΩ± */
      border: 1px solid #e5e7eb;
      /* border-bottom: 1px solid #e5e7eb;  ÁßªÈô§ÂéüÊù•ÁöÑÂ∫ïÈÉ®ËæπÊ°ÜÔºåÊîπÁî®Âç°ÁâáÊ†∑Âºè */
    }

    .module-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px; /* Â¢ûÂä†Ê†áÈ¢ò‰∏ãËæπË∑ù */
    }

    .module-title {
      font-size: 18px; /* Â¢ûÂ§ßÊ†áÈ¢òÂ≠óÂè∑ */
      font-weight: 700; /* Âä†Á≤ó */
      color: #111827;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .analysis-btn {
      padding: 10px 20px; /* Â¢ûÂ§ßÊåâÈíÆÂÜÖËæπË∑ù */
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px; /* Â¢ûÂ§ßÂúÜËßí */
      font-size: 15px; /* Â¢ûÂ§ßÂ≠óÂè∑ */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3); /* Â¢ûÂä†ÊåâÈíÆÈò¥ÂΩ± */
    }

    .analysis-btn:hover {
      opacity: 0.95;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(102, 126, 234, 0.4);
    }

    .analysis-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .analysis-result {
      /* border-top: 1px solid #f3f4f6; 
      padding-top: 20px; */
      margin-top: 12px;
    }

    .analysis-result.hidden {
      display: none;
    }

    .result-section {
      margin-bottom: 24px; /* Â¢ûÂä†ÊÆµËêΩÈó¥Ë∑ù */
    }

    .result-section:last-child {
      margin-bottom: 0;
    }

    .result-label {
      font-size: 14px; /* Â¢ûÂ§ßÊ†áÁ≠æÂ≠óÂè∑ */
      font-weight: 600;
      color: #4b5563; /* Á®çÂæÆÊ∑±‰∏ÄÁÇπÁöÑÁÅ∞Ëâ≤ */
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: space-between;
    }

    .regenerate-btn {
      background: #fff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 6px 10px; /* Â¢ûÂ§ßÊåâÈíÆ */
      cursor: pointer;
      font-size: 14px;
      color: #6b7280;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .regenerate-btn:hover {
      background: #f9fafb;
      border-color: #6b7280;
      color: #111827;
    }

    .result-value {
      font-size: 15px; /* Â¢ûÂ§ßÂÜÖÂÆπÂ≠óÂè∑ */
      color: #1f2937;
      line-height: 1.6;
    }

    .result-badge {
      display: inline-block;
      padding: 6px 14px; /* Â¢ûÂ§ßÂæΩÁ´†ÂÜÖËæπË∑ù */
      background: #eff6ff;
      color: #2563eb;
      border-radius: 20px; /* Êõ¥ÂúÜÊ∂¶ */
      font-size: 13px;
      font-weight: 600;
      margin-right: 10px;
    }

    .extracted-info-box {
      background: #f9fafb; /* Êõ¥Ê∑°ÁöÑËÉåÊôØ */
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 0px 16px 0px 16px;
      margin-top: 12px;
    }

    .info-item {
      display: flex;
      padding: 10px 0; /* Â¢ûÂä†Ë°åÈó¥Ë∑ù */
      border-bottom: 1px solid #e5e7eb;
      align-items: baseline; /* ÂØπÈΩêÊñπÂºè */
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-item-label {
      font-size: 14px;
      color: #6b7280;
      min-width: 100px; /* Â¢ûÂä†Ê†áÁ≠æÂÆΩÂ∫¶ */
      font-weight: 500;
    }

    .info-item-value {
      font-size: 14px;
      color: #111827;
      flex: 1;
      font-weight: 500;
    }

    .suggestion-box {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 1px 2px rgba(251, 191, 36, 0.1);
    }

    .suggestion-box .result-label {
      color: #b45309;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .suggestion-box .result-value {
      color: #92400e;
      font-size: 14px;
    }

    /* ÁºñËæë‰ø°ÊÅØÂºπÁ™óÊ†∑Âºè */
    .edit-info-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }

    .edit-info-modal-content {
      background-color: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .edit-info-modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .edit-info-modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
    }

    .edit-info-modal-close {
      font-size: 28px;
      font-weight: bold;
      color: #9ca3af;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s;
      padding: 4px;
    }

    .edit-info-modal-close:hover {
      color: #111827;
    }

    .edit-info-modal-tabs {
      display: flex;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      padding: 0;
    }

    .edit-tab-btn {
      flex: 1;
      padding: 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .edit-tab-btn:hover {
      color: #667eea;
      background: #f3f4f6;
    }

    .edit-tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: #fff;
      font-weight: 600;
    }

    .edit-info-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .edit-tab-content {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .edit-field-group {
      margin-bottom: 20px;
    }

    .edit-field-group:last-child {
      margin-bottom: 0;
    }

    .edit-field-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .edit-field-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .edit-field-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .edit-fields-container {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .edit-info-modal-footer {
      padding: 20px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .edit-info-btn {
      transition: all 0.2s;
      margin-bottom: 8px;
      padding: 6px 12px !important;
      font-size: 13px !important;
      min-width: 90px;
      text-align: center;
    }

    .edit-info-btn:hover {
      background: #5568d3 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    }

    .update-history-btn {
      transition: all 0.2s;
      margin-bottom: 8px;
      padding: 6px 12px !important;
      font-size: 13px !important;
      min-width: 90px;
      text-align: center;
    }

    .update-history-btn:hover {
      background: #059669 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    /* ÈÇÆ‰ª∂ÂéÜÂè≤ÂºπÁ™óÊ†∑Âºè */
    .email-history-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }

    .email-history-modal-content {
      background-color: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .email-history-modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .email-history-filter {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    
    .email-history-filter > div {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .email-history-filter input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .email-history-filter select {
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    
    .email-history-feedback {
      cursor: pointer;
      color: #6366f1;
      font-weight: 500;
    }
    
    .email-history-feedback:hover {
      text-decoration: underline;
    }

    .email-history-modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
    }

    .email-history-modal-close {
      font-size: 28px;
      font-weight: bold;
      color: #9ca3af;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s;
      padding: 4px;
    }

    .email-history-modal-close:hover {
      color: #111827;
    }

    .email-history-modal-body {
      padding: 0;
      overflow-y: auto;
      flex: 1;
    }

    .email-history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .email-history-table th {
      background: #f9fafb;
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .email-history-table td {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      color: #374151;
      vertical-align: top;
    }

    .email-history-table tr:hover {
      background: #f9fafb;
    }

    .email-history-content {
      max-width: 350px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      color: #6366f1;
      font-weight: 500;
    }

    .email-history-content:hover {
      text-decoration: underline;
    }

    .email-history-status {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .email-history-status.yes {
      background: #d1fae5;
      color: #065f46;
    }

    .email-history-status.no {
      background: #fee2e2;
      color: #991b1b;
    }

    .email-history-empty {
      text-align: center;
      padding: 60px;
      color: #9ca3af;
      font-size: 15px;
    }

    /* Êõ¥Êñ∞ÂéÜÂè≤Ê†∑Âºè */
    .update-log {
      font-size: 12px;
      line-height: 1.6;
      color: #374151;
      word-break: break-word;
    }

    .update-type-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .update-type-badge.ai-update {
      background: #dbeafe;
      color: #1e40af;
    }

    .update-type-badge.manual-update {
      background: #fef3c7;
      color: #92400e;
    }

    /* ÈÇÆ‰ª∂ÂõûÂ§çÊ®°Âùó */
    .email-module {
      padding: 24px; /* Â¢ûÂä†ÂÜÖËæπË∑ù */
      background: #fff;
      border-radius: 12px; /* ÂúÜËßíÂ¢ûÂä† */
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Ê∑ªÂä†ËΩªÂæÆÈò¥ÂΩ± */
      border: 1px solid #e5e7eb;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .actions-container {
      /* margin-bottom: 24px; */
    }

    .action-group {
      margin-bottom: 24px;
    }

    .action-group-title {
      font-size: 15px; /* Â¢ûÂ§ßÂ≠óÂè∑ */
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
      /* padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb; */
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .action-group-title.recommended {
      color: #6366f1;
      border-bottom-color: #6366f1;
      cursor: default;
    }

    .action-group-title .toggle-icon {
      font-size: 12px;
      color: #6b7280;
      transition: transform 0.2s;
      margin-left: 8px;
    }

    .action-group-title:hover:not(.recommended) {
      color: #6366f1;
    }

    .action-group.collapsed .actions-grid {
      display: none;
    }

    .action-group.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Â¢ûÂ§ßÂç°ÁâáÊúÄÂ∞èÂÆΩÂ∫¶ */
      gap: 12px; /* Â¢ûÂ§ßÈó¥Ë∑ù */
      margin-top: 16px;
    }

    .action-card {
      padding: 16px; /* Â¢ûÂ§ßÂÜÖËæπË∑ù */
      background: #fff;
      border: 1px solid #e5e7eb; /* ËæπÊ°ÜÂèòÁªÜ */
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 14px; /* Â¢ûÂ§ßÂ≠óÂè∑ */
      color: #374151;
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .action-card:hover {
      border-color: #6366f1;
      background: #f5f3ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(99, 102, 241, 0.15); /* Â¢ûÂº∫Èò¥ÂΩ± */
    }

    .action-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
      box-shadow: none;
    }

    .action-card.selected {
      border-color: #6366f1;
      background: #eef2ff;
      box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
      color: #4f46e5;
      font-weight: 600;
    }

    .email-preview-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      margin-top: 16px;
    }

    .email-preview-container.hidden {
      display: none;
    }

    .email-preview {
      flex: 1;
      background: #f9fafb; /* Á®çÂæÆÁÅ∞‰∏ÄÁÇπÁöÑËÉåÊôØÔºåÊ®°ÊãüËæìÂÖ•Ê°Ü */
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 20px; /* Â¢ûÂ§ßÂÜÖËæπË∑ù */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px; /* Â¢ûÂ§ßÂ≠óÂè∑ */
      color: #1f2937;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.6;
      resize: vertical;
      min-height: 250px; /* Â¢ûÂ§ßÊúÄÂ∞èÈ´òÂ∫¶ */
    }
    
    .email-preview:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      background: #fff;
    }

    .email-actions {
      display: flex;
      gap: 12px; /* Â¢ûÂ§ßÈó¥Ë∑ù */
      margin-top: 20px;
    }

    .email-action-btn {
      padding: 10px 20px; /* Â¢ûÂ§ßÊåâÈíÆ */
      background: #fff;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px; /* Â¢ûÂ§ßÂ≠óÂè∑ */
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .email-action-btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
      transform: translateY(-1px);
    }

    .email-action-btn.primary {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
      box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
    }

    .email-action-btn.primary:hover {
      background: #4f46e5;
      box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
    }

    .warning-box {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #92400e;
      box-shadow: 0 1px 2px rgba(251, 191, 36, 0.1);
    }

    .warning-box .warning-title {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-box ul {
      margin: 6px 0 0 0;
      padding-left: 20px;
    }

    .warning-box li {
      margin: 4px 0;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ÈÇÆ‰ª∂ÂèçÈ¶àÊ†∑Âºè */
    .email-feedback-container {
      margin-top: 16px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .feedback-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .feedback-label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .feedback-buttons {
      display: flex;
      gap: 8px;
    }

    .feedback-btn {
      padding: 8px 14px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      color: #374151;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .feedback-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .feedback-btn-usable:hover {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }

    .feedback-btn-unusable:hover {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }

    .feedback-btn.active {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }

    .feedback-btn-usable.active {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    .feedback-btn-unusable.active {
      background: #ef4444;
      border-color: #ef4444;
      color: white;
    }

    .feedback-input-container {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    .feedback-input-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .feedback-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      color: #111827;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
      box-sizing: border-box;
    }

    .feedback-input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .feedback-submit-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: flex-end;
    }

    .feedback-submit-btn {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      color: #374151;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .feedback-submit-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .feedback-submit-btn.primary {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }

    .feedback-submit-btn.primary:hover {
      background: #4f46e5;
    }
  </style>
</head>
<body>
  <!-- È°∂ÈÉ®Ê†áÁ≠æÊ†è -->
  <div class="top-tabs">
    <div class="tab-item active">
      Device disconnected #262815
      <span class="close-icon">√ó</span>
    </div>
    <div class="add-tab">+</div>
    <div style="margin-left: auto; padding: 0 12px; color: #666; font-size: 13px;">Add</div>
  </div>

  <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
  <div class="breadcrumb">
    <span class="breadcrumb-item">Organization (create)</span>
    <span>Saqib</span>
    <span class="breadcrumb-item active">NEW Incident #262815</span>
  </div>

  <!-- ‰∏ªÂÆπÂô® -->
  <div class="main-container">
    <!-- Â∑¶‰æßÂØºËà™Ê†è -->
    <div class="sidebar">
      <div class="sidebar-icon">üè†</div>
      <div class="sidebar-icon">üìÑ</div>
      <div class="sidebar-icon">üë•</div>
      <div class="sidebar-icon">üè¢</div>
      <div class="sidebar-icon">üìä</div>
      <div class="sidebar-icon">‚öôÔ∏è</div>
      <div class="sidebar-icon">üöÄ</div>
      <div class="sidebar-logo">Z</div>
    </div>

    <!-- ‰∏≠Â§ÆÂ∑¶‰æßÈù¢Êùø - Â∑•ÂçïËØ¶ÊÉÖ -->
    <div class="left-panel">
      <div class="panel-header">
        <div class="field-group">
          <div class="field-label">Requester</div>
          <div class="field-value">
            <span>Saqib</span>
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Assignee*</div>
          <div class="field-value">
            <span class="link-action">take it</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">
            Followers
            <span style="color: #999; font-size: 11px;">‚ÑπÔ∏è</span>
          </div>
          <div class="field-value">
            <span class="link-action">follow</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Tags</div>
          <div class="tags-container">
            <span class="tag">dreo-app <span class="tag-remove">√ó</span></span>
            <span class="tag">ios <span class="tag-remove">√ó</span></span>
            <span class="tag">north_american_server <span class="tag-remove">√ó</span></span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Country</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Model</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Orders#</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Order date</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">ÈóÆÈ¢òÂàÜÁ±ª</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Â§áÊ≥®</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">SKU</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Provided Troubleshooting</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Troubleshooting Effective</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Need RMA</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Shipping Address</div>
          <div class="field-value">
            <input type="text" class="field-input" placeholder="">
          </div>
        </div>
        <div class="field-group">
          <div class="field-value">
            <span class="link-action">Apply macro</span>
            <span style="color: #999;">‚ñº</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Âè≥‰æß‰∏ªÈù¢Êùø - ÂØπËØùÂå∫Âüü -->
    <div class="right-panel">
      <div class="conversation-header">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <div class="conversation-title" id="ticketTitle">Device disconnected due to unknown cause. Unable to connect WiFi</div>
            <div class="conversation-meta">
              <span>Via mobile SDK</span>
            </div>
          </div>
          <div class="header-actions">
            <div class="header-icon">üîç</div>
            <div class="header-icon">üîÑ</div>
            <div class="header-icon">‚ãØ</div>
          </div>
        </div>
      </div>

      <div class="conversation-content">
        <div class="message-item">
          <div class="message-avatar">üë§</div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-author">Saqib</span>
              <span style="color: #999;">‚Ü©</span>
              <span class="message-time">44 minutes ago</span>
            </div>
            <div class="message-bubble" id="ticketDescription">
              Device disconnected due to unknown cause. Unable to connect WiFi
            </div>
          </div>
        </div>
      </div>

      <!-- ÂõûÂ§çÂå∫Âüü -->
      <div class="reply-area">
        <!-- Â∑•ÂÖ∑ÂåÖÈù¢Êùø - Âè≥‰æßÊäΩÂ±â -->
        <div id="toolkitPanel" class="toolkit-panel">
          <div class="toolkit-header">
            <div class="toolkit-title">
              <span>üîß</span>
              ÂÆ¢ÊúçÂ∑•ÂçïËæÖÂä©ÂõûÂ§çÂ∑•ÂÖ∑
            </div>
            <div class="toolkit-close" id="closeToolkitBtn">√ó</div>
          </div>

          <!-- TabÂØºËà™ -->
          <div class="tab-nav">
            <button class="tab-btn active" data-tab="quick-reply">
              <span class="tab-icon">‚ö°</span>
              <span>Âø´Êç∑Â§ÑÁêÜ</span>
            </button>
            <button class="tab-btn" data-tab="ticket-info">
              <span class="tab-icon">üìã</span>
              <span>Â∑•Âçï‰ø°ÊÅØ</span>
            </button>
            <button class="tab-btn" data-tab="customer-info">
              <span class="tab-icon">üë§</span>
              <span>ÂÆ¢Êà∑‰ø°ÊÅØ</span>
            </button>
          </div>

          <div class="toolkit-content">
            <!-- Â∑•Âçï‰ø°ÊÅØ Tab -->
            <div id="ticket-info-tab" class="tab-content">
              <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
              <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <div class="loading-text">Ê≠£Âú®ÂàÜÊûêÂ∑•Âçï...</div>
              </div>

              <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
              <div id="mainContent" class="main-content hidden">
                <!-- Â∑•ÂçïÂú∫ÊôØ -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üìã</span>
                    Â∑•ÂçïÂú∫ÊôØ
                    <button class="edit-btn" id="editScenarioBtn">ÁºñËæë</button>
                  </h3>
                  <div id="scenarioInfo" class="info-card">
                    <div class="scenario-badge" id="scenarioBadge">ËØÜÂà´‰∏≠...</div>
                    <div class="scenario-desc" id="scenarioDetails"></div>
                    <!-- ÁºñËæëÁä∂ÊÄÅ -->
                    <div id="scenarioEditMode" class="edit-mode" style="display: none;">
                      <div class="info-row">
                        <span class="info-label">Âú∫ÊôØÔºö</span>
                        <select id="editScenario" class="info-input">
                          <option value="ÂîÆÂâçÂí®ËØ¢">ÂîÆÂâçÂí®ËØ¢</option>
                          <option value="ËÆ¢ÂçïÈóÆÈ¢ò">ËÆ¢ÂçïÈóÆÈ¢ò</option>
                          <option value="‰∫ßÂìÅÈóÆÈ¢ò">‰∫ßÂìÅÈóÆÈ¢ò</option>
                          <option value="ÂîÆÂêéÊúçÂä°">ÂîÆÂêéÊúçÂä°</option>
                        </select>
                      </div>
                      <div class="info-row">
                        <span class="info-label">Â≠êÂú∫ÊôØÔºö</span>
                        <select id="editSubScenario" class="info-input"></select>
                      </div>
                      <div class="edit-actions">
                        <button class="btn btn-primary btn-small" id="saveScenarioBtn">‰øùÂ≠ò</button>
                        <button class="btn btn-secondary btn-small" id="cancelScenarioBtn">ÂèñÊ∂à</button>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- ËÆ¢Âçï‰ø°ÊÅØ -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üì¶</span>
                    ËÆ¢Âçï‰ø°ÊÅØ
                    <button class="edit-btn" id="editOrderBtn">ÁºñËæë</button>
                  </h3>
                  <div class="info-card">
                    <div class="info-row">
                      <span class="info-label">Ë¥≠‰π∞Ê∏†ÈÅìÔºö</span>
                      <span id="orderChannel" class="info-value">-</span>
                      <input type="text" id="editOrderChannel" class="info-input" style="display: none;" placeholder="ËæìÂÖ•Ë¥≠‰π∞Ê∏†ÈÅì">
                    </div>
                    <div class="info-row">
                      <span class="info-label">ËÆ¢ÂçïÂè∑Ôºö</span>
                      <span id="orderNumber" class="info-value">-</span>
                      <input type="text" id="editOrderNumber" class="info-input" style="display: none;" placeholder="ËæìÂÖ•ËÆ¢ÂçïÂè∑">
                    </div>
                    <div class="info-row">
                      <span class="info-label">ËÆ¢ÂçïÊó•ÊúüÔºö</span>
                      <span id="orderDate" class="info-value">-</span>
                      <input type="date" id="editOrderDate" class="info-input" style="display: none;" placeholder="ÈÄâÊã©ËÆ¢ÂçïÊó•Êúü">
                    </div>
                    <div class="info-row">
                      <span class="info-label">ËÆ¢Âçï‰∫ßÂìÅÔºö</span>
                      <div id="orderProducts" class="info-value">-</div>
                      <input type="text" id="editOrderProducts" class="info-input" style="display: none;" placeholder="ËæìÂÖ•ËÆ¢Âçï‰∫ßÂìÅÔºåÂ§ö‰∏™Áî®ÈÄóÂè∑ÂàÜÈöî">
                    </div>
                    <!-- ÁºñËæëÁä∂ÊÄÅÊåâÈíÆ -->
                    <div id="orderEditActions" class="edit-actions" style="display: none;">
                      <button class="btn btn-primary btn-small" id="saveOrderBtn">‰øùÂ≠ò</button>
                      <button class="btn btn-secondary btn-small" id="cancelOrderBtn">ÂèñÊ∂à</button>
                    </div>
                  </div>
                </section>

                <!-- ‰∫ßÂìÅ‰ø°ÊÅØ -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üõçÔ∏è</span>
                    ‰∫ßÂìÅ‰ø°ÊÅØ
                    <button class="edit-btn" id="editProductsBtn">ÁºñËæë</button>
                  </h3>
                  <div id="productsList" class="info-card">
                    <!-- ‰∫ßÂìÅÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                  </div>
                </section>

                <!-- Áâ©ÊµÅ‰ø°ÊÅØ -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üöö</span>
                    Áâ©ÊµÅ‰ø°ÊÅØ
                    <button class="edit-btn" id="editLogisticsBtn">ÁºñËæë</button>
                  </h3>
                  <div class="info-card">
                    <div class="info-row">
                      <span class="info-label">Áâ©ÊµÅÊâøËøêÂïÜÔºö</span>
                      <span id="logisticsCarrierDisplay" class="info-value">-</span>
                      <input type="text" id="logisticsCarrier" class="info-input" style="display: none;" placeholder="ËæìÂÖ•Áâ©ÊµÅÊâøËøêÂïÜ">
                    </div>
                    <div class="info-row">
                      <span class="info-label">Áâ©ÊµÅÂçïÂè∑Ôºö</span>
                      <span id="logisticsNumberDisplay" class="info-value">-</span>
                      <input type="text" id="logisticsNumber" class="info-input" style="display: none;" placeholder="ËæìÂÖ•Áâ©ÊµÅÂçïÂè∑">
                    </div>
                    <div class="info-row">
                      <span class="info-label">ÂΩìÂâçÁä∂ÊÄÅÔºö</span>
                      <span id="logisticsStatusDisplay" class="info-value">-</span>
                      <input type="text" id="logisticsStatus" class="info-input" style="display: none;" placeholder="ËæìÂÖ•ÂΩìÂâçÁä∂ÊÄÅ">
                    </div>
                    <!-- ÁºñËæëÁä∂ÊÄÅÊåâÈíÆ -->
                    <div id="logisticsEditActions" class="edit-actions" style="display: none;">
                      <button class="btn btn-primary btn-small" id="saveLogisticsBtn">‰øùÂ≠ò</button>
                      <button class="btn btn-secondary btn-small" id="cancelLogisticsBtn">ÂèñÊ∂à</button>
                    </div>
                  </div>
                </section>
              </div>
            </div>

            <!-- Âø´Êç∑Â§ÑÁêÜ Tab -->
            <div id="quick-reply-tab" class="tab-content active">
              <div class="quick-process-container">
                <!-- ÂàÜÊûêÊ®°Âùó -->
                <div class="analysis-module">
                  <div class="module-header">
                    <div class="module-title">
                      <span>üîç</span>
                      <span>Â∑•ÂçïÂàÜÊûê</span>
                    </div>
                    <button class="analysis-btn" id="analysisBtn" onclick="startNewAnalysis()">
                      <span>‚ú®</span>
                      <span>‰∏ÄÈîÆÂàÜÊûê</span>
                    </button>
                  </div>

                  <div style="display: none; margin-left: 8px;" id="analysisActionButtons">
                    <button class="edit-info-btn" id="editInfoBtn" onclick="openEditInfoModal()" style="background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">
                      ‚úèÔ∏è ÁºñËæë‰ø°ÊÅØ
                    </button>
                    <button class="update-history-btn" id="updateHistoryBtn" onclick="showUpdateHistory()" style="background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                      üìú Êõ¥Êñ∞ÂéÜÂè≤
                    </button>
                  </div>
                  <div class="analysis-result hidden" id="analysisResult">
                    <!-- Â∑•Âçï‰ø°ÊÅØÊèêÂèñ -->
                    <div class="result-section">
                      <div class="result-label">
                        Â∑•Âçï‰ø°ÊÅØ
                        
                      </div>
                      <div class="result-value">
                        <span class="result-badge" id="scenarioBadgeQuick">Êú™ÂàÜÊûê</span>
                        <span id="scenarioDetailsQuick"></span>
                      </div>
                      
                      <div class="extracted-info-box">
                        <div class="info-item">
                          <div class="info-item-label">üì¶ ËÆ¢ÂçïÂè∑Ôºö</div>
                          <div class="info-item-value" id="extractedOrderNumber">-</div>
                        </div>
                        <div class="info-item">
                          <div class="info-item-label">üõí Ë¥≠‰π∞Ê∏†ÈÅìÔºö</div>
                          <div class="info-item-value" id="extractedChannel">-</div>
                        </div>
                        <div class="info-item">
                          <div class="info-item-label">üìÖ ËÆ¢ÂçïÊó•ÊúüÔºö</div>
                          <div class="info-item-value" id="extractedOrderDate">-</div>
                        </div>
                        <div class="info-item">
                          <div class="info-item-label">üõçÔ∏è ‰∫ßÂìÅÂûãÂè∑Ôºö</div>
                          <div class="info-item-value" id="extractedProduct">-</div>
                        </div>
                      </div>
                    </div>

                    <!-- Â§ÑÁêÜÂª∫ËÆÆ -->
                    <div class="suggestion-box">
                      <div class="result-label">üí° Â§ÑÁêÜÂª∫ËÆÆ</div>
                      <div class="result-value" id="suggestionText">-</div>
                    </div>
                  </div>
                </div>

                <!-- ÈÇÆ‰ª∂ÂõûÂ§çÊ®°Âùó -->
                <div class="email-module">
                  <div class="module-header">
                    <div class="module-title">
                      <span>‚úâÔ∏è</span>
                      <span>ÈÇÆ‰ª∂ÂõûÂ§ç</span>
                    </div>
                  </div>

                  <!-- Âä®‰ΩúÈÄâÊã© -->
                  <div class="actions-container" id="actionsContainer">
                    <div class="action-group">
                      <div class="actions-grid">
                        <div class="action-card disabled">ËØ∑ÂÖàÂÆåÊàêÂ∑•ÂçïÂàÜÊûê</div>
                      </div>
                    </div>
                  </div>

                  <!-- ÈÇÆ‰ª∂È¢ÑËßà -->
                  <div class="email-preview-container hidden" id="emailPreviewContainer">
                    <div class="result-label">
                      <span>ÈÇÆ‰ª∂È¢ÑËßà</span>
                      <button class="regenerate-btn" onclick="regenerateEmail()" title="ÈáçÊñ∞ÁîüÊàêÈÇÆ‰ª∂">
                        <span>üîÑ</span>
                      </button>
                    </div>
                    
                    <textarea class="email-preview" id="emailPreview"></textarea>
                    
                    <div class="email-actions">
                      <button class="email-action-btn primary" onclick="sendEmail()">
                        <span>üì§</span>
                        <span>ÂèëÈÄÅ</span>
                      </button>
                      <button class="email-action-btn" onclick="copyEmail()">
                        <span>üìã</span>
                        <span>Â§çÂà∂</span>
                      </button>
                      <button class="email-action-btn" onclick="showEmailHistory()">
                        <span>üìú</span>
                        <span>ÈÇÆ‰ª∂ÂéÜÂè≤</span>
                      </button>
                    </div>

                    <!-- ÈÇÆ‰ª∂ÂèçÈ¶àÂå∫Âüü -->
                    <div class="email-feedback-container hidden" id="emailFeedbackContainer">
                      <div class="feedback-header">
                        <div class="feedback-label">ÈÇÆ‰ª∂Ë¥®ÈáèÂèçÈ¶à</div>
                        <div class="feedback-buttons">
                          <button class="feedback-btn feedback-btn-usable" onclick="markEmailUsable()">
                            <span>üëç</span>
                            <span>ÂèØÁî®</span>
                          </button>
                          <button class="feedback-btn feedback-btn-unusable" onclick="markEmailUnusable()">
                            <span>üëé</span>
                            <span>‰∏çÂèØÁî®</span>
                          </button>
                        </div>
                      </div>
                      <div class="feedback-input-container hidden" id="feedbackInputContainer">
                        <label class="feedback-input-label">ËØ∑Â°´ÂÜôËØ¶ÁªÜÂèçÈ¶àÔºö</label>
                        <textarea 
                          class="feedback-input" 
                          id="feedbackInput" 
                          placeholder="ËØ∑ËØ¶ÁªÜËØ¥ÊòéÈÇÆ‰ª∂‰∏çÂèØÁî®ÁöÑÂéüÂõ†Ôºå‰æãÂ¶ÇÔºöÂÜÖÂÆπ‰∏çÂáÜÁ°Æ„ÄÅËØ≠Ê∞î‰∏çÂêàÈÄÇ„ÄÅÁº∫Â∞ëÂÖ≥ÈîÆ‰ø°ÊÅØÁ≠â..."
                          rows="4"
                        ></textarea>
                        <div class="feedback-submit-buttons">
                          <button class="feedback-submit-btn primary" onclick="submitFeedback()">
                            <span>Êèê‰∫§ÂèçÈ¶à</span>
                          </button>
                          <button class="feedback-submit-btn" onclick="cancelFeedback()">
                            <span>ÂèñÊ∂à</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ÂÆ¢Êà∑‰ø°ÊÅØ Tab -->
            <div id="customer-info-tab" class="tab-content">
              <div class="customer-info-content">
                <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üë§</span>
                    Âü∫Êú¨‰ø°ÊÅØ
                  </h3>
                  <div class="info-card">
                    <div class="info-row">
                      <span class="info-label">Áî®Êà∑ÂêçÔºö</span>
                      <span id="customerName" class="info-value">-</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">ÈÇÆÁÆ±Ôºö</span>
                      <span id="customerEmail" class="info-value">-</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">DREOË¥¶Âè∑IDÔºö</span>
                      <span id="customerDreoId" class="info-value">-</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Customer IDÔºö</span>
                      <span id="customerId" class="info-value">-</span>
                    </div>
                  </div>
                </section>

                <!-- ÂéÜÂè≤ËÆ¢Âçï -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üì¶</span>
                    ÂéÜÂè≤ËÆ¢Âçï
                  </h3>
                  <div id="orderHistory" class="table-container">
                    <!-- Ë°®Ê†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                  </div>
                </section>

                <!-- IoTËÆæÂ§á -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üì±</span>
                    IoTËÆæÂ§á
                  </h3>
                  <div id="iotDevices" class="table-container">
                    <!-- Ë°®Ê†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                  </div>
                </section>

                <!-- ÂéÜÂè≤Â∑•Âçï -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üé´</span>
                    ÂéÜÂè≤Â∑•Âçï
                  </h3>
                  <div id="ticketHistory" class="table-container">
                    <!-- Ë°®Ê†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                  </div>
                </section>

                <!-- ÂéÜÂè≤Êç¢Ë¥ß -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üîÑ</span>
                    ÂéÜÂè≤Êç¢Ë¥ß
                  </h3>
                  <div id="exchangeHistory" class="table-container">
                    <!-- Ë°®Ê†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                  </div>
                </section>

                <!-- ÂéÜÂè≤ÈÄÄÊ¨æ -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üí∞</span>
                    ÂéÜÂè≤ÈÄÄÊ¨æ
                  </h3>
                  <div id="refundHistory" class="table-container">
                    <!-- Ë°®Ê†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                  </div>
                </section>

                <!-- Ë¥®‰øù‰ø°ÊÅØ -->
                <section class="info-section">
                  <h3 class="section-title">
                    <span class="icon">üõ°Ô∏è</span>
                    Ë¥®‰øù‰ø°ÊÅØ
                  </h3>
                  <div id="warrantyInfo" class="table-container">
                    <!-- Ë°®Ê†ºÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>

        <!-- Â∑•ÂÖ∑Ê†è -->
        <div class="reply-toolbar">
          <button class="toolbar-btn" title="Á≤ó‰Ωì">B</button>
          <button class="toolbar-btn" title="Êñú‰Ωì">I</button>
          <button class="toolbar-btn" title="‰∏ãÂàíÁ∫ø">U</button>
          <button class="toolbar-btn" title="ÊñáÂ≠óÈ¢úËâ≤">A</button>
          <button class="toolbar-btn" title="Ë°®ÊÉÖ">üòä</button>
          <div class="toolbar-divider"></div>
          <button class="toolbar-btn" title="ÈôÑ‰ª∂">üìé</button>
          <button class="toolbar-btn" title="ÈìæÊé•">üîó</button>
          <button class="toolbar-btn" title="Áü•ËØÜÂ∫ì">üìö</button>
          <div class="toolbar-divider"></div>
          <!-- ÂÆ¢ÊúçÂ∑•ÂçïËæÖÂä©ÂõûÂ§çÂ∑•ÂÖ∑ÊåâÈíÆ -->
          <button id="openToolkitBtn" class="toolbar-btn toolbar-btn-special" title="ÂÆ¢ÊúçÂ∑•ÂçïËæÖÂä©ÂõûÂ§çÂ∑•ÂÖ∑">
            üîß ÂÆ¢ÊúçÂ∑•ÂçïËæÖÂä©ÂõûÂ§çÂ∑•ÂÖ∑
          </button>
        </div>

        <!-- ÂõûÂ§çËæìÂÖ•Âå∫Âüü -->
        <div class="reply-input-area">
          <div class="reply-type">
            <span>Public reply</span>
            <span style="color: #999;">‚ñº</span>
          </div>
          <div class="reply-to">
            <span>To</span>
            <span>üë§</span>
            <span>Saqib</span>
            <span style="color: #999; cursor: pointer;">‚úèÔ∏è</span>
          </div>
          <textarea id="replyTextarea" class="reply-textarea" placeholder="ËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπ..."></textarea>
          <div style="display: flex; justify-content: flex-end; gap: 8px;">
            <span style="color: #666; font-size: 12px; cursor: pointer;">CC</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Â∫îÁî®Áä∂ÊÄÅ
    let appState = {
      ticketId: '262815',
      ticketData: {
        id: '262815',
        subject: 'Device disconnected due to unknown cause. Unable to connect WiFi',
        description: 'Device disconnected due to unknown cause. Unable to connect WiFi',
        requester: { name: 'Saqib' }
      },
      scenario: null,
      subScenario: null,
      processNode: null,
      selectedAction: null,
      generatedEmail: null,
      actionEmails: {}, // Â≠òÂÇ®ÊØè‰∏™Âä®‰ΩúÂØπÂ∫îÁöÑÈÇÆ‰ª∂ÂÜÖÂÆπÔºåkey‰∏∫action.id
      emailHistory: [], // ÈÇÆ‰ª∂ÂéÜÂè≤ÔºàÂåÖÊã¨AIÁîüÊàêÂíåÊâãÂä®‰øÆÊîπÔºâ
      currentHistoryId: undefined, // ÂΩìÂâçÈÇÆ‰ª∂ÂéÜÂè≤ÁöÑID
      updateHistory: [], // Êõ¥Êñ∞ÂéÜÂè≤ÔºàÂåÖÊã¨ÂàÜÊûêÂíåÊâãÂä®ÁºñËæëÔºâ
      orderInfo: {
        channel: null,
        orderNumber: null,
        orderDate: null,
        products: []
      },
      products: [],
      logistics: {
        carrier: null,
        number: null,
        status: null
      },
      customerInfo: null
    };

    // ÊºîÁ§∫ÂÆ¢Êà∑Êï∞ÊçÆ
    const demoCustomerData = {
      name: 'John Doe',
      email: 'john.doe@example.com',
      dreoId: 'DREO123456',
      customerId: 'CUST789012',
      orders: [
        { orderNumber: 'ORD001', products: 'DR-HTF001S', amount: '$89.99', store: 'Amazon', date: '2024-01-15' },
        { orderNumber: 'ORD002', products: 'DR-HTF002', amount: '$129.99', store: 'DREOÂÆòÁΩë', date: '2024-02-20' },
        { orderNumber: 'ORD003', products: 'DR-HTF001S, DR-HTF002', amount: '$219.98', store: 'Walmart', date: '2024-03-10' }
      ],
      iotDevices: [
        { sn: 'SN001234', model: 'DR-HTF001S', category: 'IoT', firstConnect: '2024-01-20', lastConnect: '2024-03-15', lastControl: '2024-03-15', sharedAccounts: 'user2@example.com' },
        { sn: 'SN005678', model: 'DR-HTF002', category: 'IoT', firstConnect: '2024-02-25', lastConnect: '2024-03-14', lastControl: '2024-03-14', sharedAccounts: '-' }
      ],
      ticketHistory: [
        { ticketId: '#262814', title: '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢' },
        { ticketId: '#262815', title: 'ËÆæÂ§áËøûÊé•ÈóÆÈ¢ò' },
        { ticketId: '#260000', title: 'ÈÄÄË¥ßÁî≥ËØ∑' }
      ],
      exchangeHistory: [
        { model: 'DR-HTF001S', rma: 'RMA001' },
        { model: 'DR-HTF002', rma: 'RMA002' }
      ],
      refundHistory: [
        { model: 'DR-HTF001S', returnNumber: 'RET001' },
        { model: 'DR-HTF002', returnNumber: 'RET002' }
      ],
      warrantyInfo: [
        { model: 'DR-HTF001S', channelType: 'Á∫ø‰∏ä', salesChannel: 'Amazon', category: 'IoT', startDate: '2024-01-15', endDate: '2025-01-15', submitDate: '2024-01-15' },
        { model: 'DR-HTF002', channelType: 'Á∫ø‰∏ä', salesChannel: 'DREOÂÆòÁΩë', category: 'IoT', startDate: '2024-02-20', endDate: '2025-02-20', submitDate: '2024-02-20' }
      ]
    };

    // Âú∫ÊôØÈÖçÁΩÆÊï∞ÊçÆÔºàÁÆÄÂåñÁâàÔºåÁî®‰∫éÊºîÁ§∫Ôºâ
    const scenarioConfig = {
      'ÂîÆÂâçÂí®ËØ¢': {
        '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢': {
          nodes: [
            { id: 'check_content', name: 'Ê£ÄÊü•Â∑•ÂçïÂÜÖÂÆπ', description: 'ÂàÜÊûêÂ∑•ÂçïÔºåÂà§Êñ≠ÊòØÂê¶ÂåÖÂê´‰∫ßÂìÅ‰ø°ÊÅØÂíåÂäüËÉΩ/ÂèÇÊï∞‰ø°ÊÅØ' },
            { id: 'extract_info', name: 'ÊèêÂèñ‰∫ßÂìÅ‰ø°ÊÅØ', description: '‰ªéÂ∑•Âçï‰∏≠ÊèêÂèñ‰∫ßÂìÅÁõ∏ÂÖ≥‰ø°ÊÅØ' },
            { id: 'query_kb', name: 'Êü•ËØ¢Áü•ËØÜÂ∫ì', description: 'Âú®Áü•ËØÜÂ∫ì‰∏≠ÊêúÁ¥¢Áõ∏ÂÖ≥‰∫ßÂìÅ‰ø°ÊÅØ' },
            { id: 'organize_info', name: 'Êï¥ÁêÜ‰∫ßÂìÅÂäüËÉΩÂèÇÊï∞ËØ¥Êòé', description: 'Êï¥ÁêÜÂíåÊ†ºÂºèÂåñÁü•ËØÜÂ∫ì‰∏≠ÁöÑ‰ø°ÊÅØ' },
            { id: 'send_email', name: 'ÂèëÈÄÅÂõûÂ§çÈÇÆ‰ª∂', description: 'ÂèëÈÄÅ‰∫ßÂìÅÂäüËÉΩÂèÇÊï∞ÂëäÁü•ÈÇÆ‰ª∂' }
          ],
          actions: [
            { id: 'ask_info', name: 'ËØ¢ÈóÆ‰∫ßÂìÅ‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'provide_info', name: 'Êèê‰æõ‰∫ßÂìÅ‰ø°ÊÅØ', icon: 'üì¶', template: 2 }
          ]
        },
        'ÊúçÂä°ÊîøÁ≠ñÂí®ËØ¢': {
          nodes: [
            { id: 'analyze_type', name: 'ÂàÜÊûêÂí®ËØ¢Á±ªÂûã', description: 'ÂàÜÊûêÁî®Êà∑Âí®ËØ¢ÁöÑÂÖ∑‰ΩìÊîøÁ≠ñÁ±ªÂûã' },
            { id: 'query_policy', name: 'Êü•ËØ¢ÊîøÁ≠ñÁü•ËØÜÂ∫ì', description: 'Âú®Áü•ËØÜÂ∫ì‰∏≠Êü•ËØ¢Áõ∏ÂÖ≥ÊîøÁ≠ñ‰ø°ÊÅØ' },
            { id: 'extract_policy', name: 'ÊèêÂèñÊîøÁ≠ñÂÜÖÂÆπ', description: '‰ªéÁü•ËØÜÂ∫ì‰∏≠ÊèêÂèñÁõ∏ÂÖ≥ÊîøÁ≠ñÂÜÖÂÆπ' },
            { id: 'organize_policy', name: 'Êï¥ÁêÜÊîøÁ≠ñËØ¥Êòé', description: 'Êï¥ÁêÜÂíåÊ†ºÂºèÂåñÊîøÁ≠ñ‰ø°ÊÅØ' },
            { id: 'send_email', name: 'ÂèëÈÄÅÂõûÂ§çÈÇÆ‰ª∂', description: 'ÂèëÈÄÅÊîøÁ≠ñÂëäÁü•ÈÇÆ‰ª∂' }
          ],
          actions: [
            { id: 'provide_policy', name: 'Êèê‰æõÊîøÁ≠ñËØ¥Êòé', icon: 'üìã', template: 1 }
          ]
        }
      },
      'ËÆ¢ÂçïÈóÆÈ¢ò': {
        'ÈúÄÂèñÊ∂àËÆ¢Âçï': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíåÁâ©ÊµÅ‰ø°ÊÅØ' },
            { id: 'check_channel', name: 'Âà§Êñ≠Ë¥≠‰π∞Ê∏†ÈÅì', description: 'Âà§Êñ≠ÊòØÂê¶‰∏∫ÂÆòÁΩëËÆ¢Âçï' },
            { id: 'check_shipment', name: 'Ê£ÄÊü•ÂèëË¥ßÁä∂ÊÄÅ', description: 'Âà§Êñ≠ËÆ¢ÂçïÊòØÂê¶Â∑≤ÂèëË¥ß' },
            { id: 'process_cancel', name: 'Â§ÑÁêÜÂèñÊ∂àËØ∑Ê±Ç', description: 'ÊâßË°åÂèñÊ∂àËÆ¢ÂçïÊàñÂçèÂïÜ‰øùÁïô' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'guide_platform', name: 'ÂºïÂØºÂπ≥Âè∞Âí®ËØ¢', icon: 'üîó', template: 2 },
            { id: 'cancel_order', name: 'ÂèñÊ∂àËÆ¢Âçï', icon: '‚úÖ', template: 3 }
          ]
        },
        'Âí®ËØ¢ËÆ¢ÂçïÁâ©ÊµÅ': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíåÁâ©ÊµÅ‰ø°ÊÅØ' },
            { id: 'check_channel', name: 'Âà§Êñ≠Ë¥≠‰π∞Ê∏†ÈÅì', description: 'Âà§Êñ≠ÊòØÂê¶‰∏∫ÂÆòÁΩëËÆ¢Âçï' },
            { id: 'query_logistics', name: 'Êü•ËØ¢Áâ©ÊµÅ‰ø°ÊÅØ', description: 'Êü•ËØ¢ËÆ¢ÂçïÁâ©ÊµÅÁä∂ÊÄÅ' },
            { id: 'inform_customer', name: 'ÂëäÁü•ÂÆ¢Êà∑', description: 'ÂëäÁü•Áî®Êà∑Áâ©ÊµÅ‰ø°ÊÅØ' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'guide_platform', name: 'ÂºïÂØºÂπ≥Âè∞Âí®ËØ¢', icon: 'üîó', template: 2 },
            { id: 'inform_logistics', name: 'ÂëäÁü•Áâ©ÊµÅ‰ø°ÊÅØ', icon: 'üöö', template: 3 }
          ]
        },
        'ÂåÖË£π‰∏¢Â§±': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíåÁâ©ÊµÅ‰ø°ÊÅØ' },
            { id: 'check_channel', name: 'Âà§Êñ≠Ë¥≠‰π∞Ê∏†ÈÅì', description: 'Âà§Êñ≠ÊòØÂê¶‰∏∫ÂÆòÁΩëËÆ¢Âçï' },
            { id: 'check_delivery', name: 'Ê£ÄÊü•‰∫§‰ªòÁä∂ÊÄÅ', description: 'Ê£ÄÊü•Áâ©ÊµÅÊòæÁ§∫Áä∂ÊÄÅ' },
            { id: 'process_lost', name: 'Â§ÑÁêÜ‰∏¢Â§±', description: 'Ë°•ÂèëÊàñÈÄÄÊ¨æÂ§ÑÁêÜ' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'guide_platform', name: 'ÂºïÂØºÂπ≥Âè∞Âí®ËØ¢', icon: 'üîó', template: 2 },
            { id: 'request_new_address', name: 'ËØ∑Ê±ÇÊñ∞Âú∞ÂùÄ', icon: 'üìç', template: 3 },
            { id: 'negotiate_refund', name: 'ÂçèÂïÜÈÄÄÊ¨æ', icon: 'üí∞', template: 5 }
          ]
        },
        'Ë¥≠‰π∞ÂêéÂèëÁé∞ÂÖ∂‰ªñÊ∏†ÈÅìÊõ¥‰æøÂÆú': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ' },
            { id: 'verify_price', name: 'Ê†∏ÂÆû‰ª∑Ê†º', description: 'Ê†∏ÂØπ‰ªòÊ¨æÈáëÈ¢ùÂíåÊ∏†ÈÅì‰ª∑Ê†º' },
            { id: 'process_refund', name: 'Â§ÑÁêÜÂ∑Æ‰ª∑', description: 'ÂõûÂ§çÈÄÄÂ∑Æ‰ª∑ÈÇÆ‰ª∂' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'refund_difference', name: 'ÈÄÄÂ∑Æ‰ª∑', icon: 'üí∞', template: 2 }
          ]
        }
      },
      'ÂîÆÂêéÊúçÂä°': {
        'Âª∂‰øùÊó∂Èïø‰∏çÁ¨¶': {
          nodes: [
            { id: 'verify_warranty', name: 'Ê†∏ÂÆûÂª∂‰øù‰ø°ÊÅØ', description: 'Ê†∏ÂÆûÂª∂‰øùÊó∂Èïø' },
            { id: 'correct_warranty', name: '‰øÆÊ≠£Âª∂‰øùÊó∂Èïø', description: '‰øÆÊ≠£Âª∂‰øùÊó∂Èïø' }
          ],
          actions: [
            { id: 'correct_warranty', name: '‰øÆÊ≠£Âª∂‰øùÊó∂Èïø', icon: 'üõ°Ô∏è', template: 1 }
          ]
        }
      },
      '‰∫ßÂìÅÈóÆÈ¢ò': {
        'ÈÖçÈÄÅÈÄ†ÊàêÊçüÂùè': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíå‰∫ßÂìÅ‰ø°ÊÅØ' },
            { id: 'check_channel', name: 'Âà§Êñ≠Ë¥≠‰π∞Ê∏†ÈÅì', description: 'Âà§Êñ≠ÊòØÂê¶‰∏∫ÂÆòÁΩëËÆ¢Âçï' },
            { id: 'check_device_status', name: 'Ê£ÄÊü•ËÆæÂ§áÁä∂ÊÄÅ', description: 'ËØ¢ÈóÆËÆæÂ§áÊòØÂê¶ËøòËÉΩÊ≠£Â∏∏ËøêË°å' },
            { id: 'process_damage', name: 'Â§ÑÁêÜÊçüÂùè', description: 'ÈÉ®ÂàÜÈÄÄÊ¨æÊàñÊç¢Ë¥ß' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'guide_platform', name: 'ÂºïÂØºÂπ≥Âè∞Âí®ËØ¢', icon: 'üîó', template: 2 },
            { id: 'partial_refund', name: 'ÈÉ®ÂàÜÈÄÄÊ¨æ', icon: 'üí∞', template: 4 },
            { id: 'exchange', name: 'Êç¢Ë¥ß', icon: 'üîÑ', template: 5 }
          ]
        },
        '‰∫ßÂìÅ‰ΩìÈ™åÈóÆÈ¢òÔºàÈùûÂìÅË¥®ÈóÆÈ¢òÔºâ': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíå‰∫ßÂìÅ‰ø°ÊÅØ' },
            { id: 'request_media', name: 'ËØ∑Ê±ÇÂ™í‰Ωì', description: 'ËØ∑Ê±ÇÊèê‰æõ‰∫ßÂìÅÂºÇÂ∏∏ÁöÑÁÖßÁâáÊàñËßÜÈ¢ë' },
            { id: 'negotiate_solution', name: 'ÂçèÂïÜËß£ÂÜ≥ÊñπÊ°à', description: 'ÈÉ®ÂàÜÈÄÄÊ¨æÊàñÈÄÄË¥ß' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'partial_refund', name: 'ÈÉ®ÂàÜÈÄÄÊ¨æ', icon: 'üí∞', template: 2 },
            { id: 'guide_platform_return', name: 'ÂºïÂØºÂπ≥Âè∞ÈÄÄË¥ß', icon: 'üîó', template: 3 }
          ]
        },
        '‰∏çÂΩ±Âìç‰∏ªÂäüËÉΩÁöÑÈóÆÈ¢òÔºàÂìÅË¥®&Èùû‰∏ªÂäüËÉΩÈóÆÈ¢òÔºâ': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíå‰∫ßÂìÅ‰ø°ÊÅØ' },
            { id: 'request_media', name: 'ËØ∑Ê±ÇÂ™í‰Ωì', description: 'ËØ∑Ê±ÇÊèê‰æõ‰∫ßÂìÅÂºÇÂ∏∏ÁöÑÁÖßÁâáÊàñËßÜÈ¢ë' },
            { id: 'assess_damage', name: 'ËØÑ‰º∞ÊçüÂùèÁ®ãÂ∫¶', description: 'Á°ÆÂÆöÊçüÂùèÁ®ãÂ∫¶' },
            { id: 'process_issue', name: 'Â§ÑÁêÜÈóÆÈ¢ò', description: 'ÈÉ®ÂàÜÈÄÄÊ¨æ„ÄÅÊç¢Ë¥ßÊàñÈÄÄË¥ß' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'partial_refund', name: 'ÈÉ®ÂàÜÈÄÄÊ¨æ', icon: 'üí∞', template: 2 },
            { id: 'exchange', name: 'Êç¢Ë¥ß', icon: 'üîÑ', template: 4 }
          ]
        },
        '‰∫ßÂìÅÂäüËÉΩÂìÅË¥®ÈóÆÈ¢ò': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíå‰∫ßÂìÅ‰ø°ÊÅØ' },
            { id: 'request_media', name: 'ËØ∑Ê±ÇÂ™í‰Ωì', description: 'ËØ∑Ê±ÇÊèê‰æõ‰∫ßÂìÅÂºÇÂ∏∏ÁöÑÁÖßÁâáÊàñËßÜÈ¢ë' },
            { id: 'provide_troubleshooting', name: 'Êèê‰æõÊéíÈîôÊ≠•È™§', description: 'Êèê‰æõÊéíÈîôÊ≠•È™§' },
            { id: 'process_issue', name: 'Â§ÑÁêÜÈóÆÈ¢ò', description: 'Êç¢Ë¥ßÊàñÈÄÄË¥ß' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'provide_troubleshooting', name: 'Êèê‰æõÊéíÈîôÊ≠•È™§', icon: 'üîß', template: 2 },
            { id: 'exchange', name: 'Êç¢Ë¥ß', icon: 'üîÑ', template: 4 }
          ]
        },
        'ÈÖç‰ª∂Ë¥®ÈáèÈóÆÈ¢ò': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíå‰∫ßÂìÅ‰ø°ÊÅØ' },
            { id: 'request_media', name: 'ËØ∑Ê±ÇÂ™í‰Ωì', description: 'ËØ∑Ê±ÇÊèê‰æõ‰∫ßÂìÅÂºÇÂ∏∏ÁöÑÁÖßÁâáÊàñËßÜÈ¢ë' },
            { id: 'check_stock', name: 'Ê£ÄÊü•Â∫ìÂ≠ò', description: 'Ê£ÄÊü•ÈÖç‰ª∂Â∫ìÂ≠ò' },
            { id: 'process_accessory', name: 'Â§ÑÁêÜÈÖç‰ª∂ÈóÆÈ¢ò', description: 'Ë°•Âèë„ÄÅÈÉ®ÂàÜÈÄÄÊ¨æÊàñÊç¢Ë¥ß' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'send_accessory', name: 'Ë°•ÂèëÈÖç‰ª∂', icon: 'üì¶', template: 2 },
            { id: 'partial_refund', name: 'ÈÉ®ÂàÜÈÄÄÊ¨æ', icon: 'üí∞', template: 5 }
          ]
        },
        'ÈÖç‰ª∂ÈùûË¥®ÈáèÈóÆÈ¢ò': {
          nodes: [
            { id: 'check_order', name: 'Ê£ÄÊü•ËÆ¢Âçï‰ø°ÊÅØ', description: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØÂíå‰∫ßÂìÅ‰ø°ÊÅØ' },
            { id: 'request_media', name: 'ËØ∑Ê±ÇÂ™í‰Ωì', description: 'ËØ∑Ê±ÇÊèê‰æõ‰∫ßÂìÅÂºÇÂ∏∏ÁöÑÁÖßÁâáÊàñËßÜÈ¢ë' },
            { id: 'check_detachable', name: 'Ê£ÄÊü•ÂèØÊãÜÂç∏ÊÄß', description: 'Âà§Êñ≠ÈÖç‰ª∂ÊòØÂê¶ÂèØÊãÜÂç∏' },
            { id: 'provide_solution', name: 'Êèê‰æõËß£ÂÜ≥ÊñπÊ°à', description: 'Êèê‰æõË¥≠‰π∞ÈìæÊé•Êàñ‰ºòÊÉ†Âà∏' }
          ],
          actions: [
            { id: 'ask_order_info', name: 'ËØ¢ÈóÆËÆ¢Âçï‰ø°ÊÅØ', icon: '‚ùì', template: 1 },
            { id: 'provide_link', name: 'Êèê‰æõË¥≠‰π∞ÈìæÊé•', icon: 'üîó', template: 2 },
            { id: 'provide_coupon', name: 'Êèê‰æõ‰ºòÊÉ†Âà∏', icon: 'üé´', template: 3 }
          ]
        },
        'ÂÆâÂÖ®ÈóÆÈ¢ò': {
          nodes: [
            { id: 'verify_safety', name: 'Ê†∏ÂÆûÂÆâÂÖ®ÈóÆÈ¢ò', description: 'Ê†∏ÂÆûÂÆâÂÖ®ÈóÆÈ¢òËØ¶ÊÉÖ' },
            { id: 'process_refund', name: 'Â§ÑÁêÜÈÄÄÊ¨æ', description: 'ÂçèÂïÜ‰ªÖÈÄÄÊ¨æ' }
          ],
          actions: [
            { id: 'full_refund', name: '‰ªÖÈÄÄÊ¨æ', icon: 'üíµ', template: 1 }
          ]
        }
      }
    };

    // ÂàùÂßãÂåñÂ∫îÁî®
    function initApp() {
      bindEvents();
      initTabs();
      loadCustomerInfo();
      extractOrderInfo();
      initLogisticsDisplay();
      identifyScenarioAndNode();
    }

    // ÂàùÂßãÂåñTabÂàáÊç¢
    function initTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
    }

    // ÂàáÊç¢Tab
    function switchTab(tabName) {
      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === tabName) {
          btn.classList.add('active');
        }
      });
      
      // Êõ¥Êñ∞ÂÜÖÂÆπÊòæÁ§∫
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      const targetTab = document.getElementById(`${tabName}-tab`);
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      // Â¶ÇÊûúÂàáÊç¢Âà∞Âø´Êç∑ÂõûÂ§çtabÔºåÊõ¥Êñ∞Âä®‰ΩúÈÄâÈ°π
      if (tabName === 'quick-reply') {
        updateQuickReplyActions();
      }
    }

    // ÊèêÂèñËÆ¢Âçï‰ø°ÊÅØ
    function extractOrderInfo() {
      const ticketData = appState.ticketData;
      const subject = ticketData.subject || '';
      const description = ticketData.description || '';
      const content = subject + ' ' + description;
      
      // ÊèêÂèñËÆ¢ÂçïÂè∑ÔºàÁÆÄÂçïÂåπÈÖçÔºâ
      const orderMatch = content.match(/ËÆ¢Âçï[Âè∑|Âè∑]?[Ôºö:Ôºö]?\s*([A-Z0-9]+)/i) || 
                         content.match(/order[Ôºö:Ôºö]?\s*([A-Z0-9]+)/i) ||
                         content.match(/#([0-9]+)/);
      if (orderMatch) {
        appState.orderInfo.orderNumber = orderMatch[1];
      }
      
      // ÊèêÂèñË¥≠‰π∞Ê∏†ÈÅì
      if (content.includes('Amazon') || content.includes('amazon')) {
        appState.orderInfo.channel = 'Amazon';
      } else if (content.includes('Walmart') || content.includes('walmart')) {
        appState.orderInfo.channel = 'Walmart';
      } else if (content.includes('ÂÆòÁΩë') || content.includes('DREOÂÆòÁΩë')) {
        appState.orderInfo.channel = 'DREOÂÆòÁΩë';
      }
      
      // ÊèêÂèñ‰∫ßÂìÅÂûãÂè∑
      const productMatch = content.match(/DR-[A-Z0-9]+/gi);
      if (productMatch) {
        const uniqueProducts = [...new Set(productMatch)];
        appState.orderInfo.products = uniqueProducts;
        appState.products = uniqueProducts.map(model => ({
          model: model,
          name: `‰∫ßÂìÅ ${model}`,
          image: `https://via.placeholder.com/50?text=${model}`
        }));
      }
      
      // Êõ¥Êñ∞UI
      updateOrderInfoDisplay();
      updateProductsDisplay();
      initLogisticsDisplay();
    }

    // ÂàùÂßãÂåñÁâ©ÊµÅ‰ø°ÊÅØÊòæÁ§∫
    function initLogisticsDisplay() {
      const carrierDisplay = document.getElementById('logisticsCarrierDisplay');
      const numberDisplay = document.getElementById('logisticsNumberDisplay');
      const statusDisplay = document.getElementById('logisticsStatusDisplay');
      
      if (carrierDisplay) {
        const carrier = document.getElementById('logisticsCarrier').value || '';
        carrierDisplay.textContent = carrier || '-';
      }
      if (numberDisplay) {
        const number = document.getElementById('logisticsNumber').value || '';
        numberDisplay.textContent = number || '-';
      }
      if (statusDisplay) {
        const status = document.getElementById('logisticsStatus').value || '';
        statusDisplay.textContent = status || '-';
      }
    }

    // Êõ¥Êñ∞ËÆ¢Âçï‰ø°ÊÅØÊòæÁ§∫
    function updateOrderInfoDisplay() {
      const orderChannelEl = document.getElementById('orderChannel');
      const orderNumberEl = document.getElementById('orderNumber');
      const orderDateEl = document.getElementById('orderDate');
      const orderProductsEl = document.getElementById('orderProducts');
      
      if (orderChannelEl) orderChannelEl.textContent = appState.orderInfo.channel || '-';
      if (orderNumberEl) orderNumberEl.textContent = appState.orderInfo.orderNumber || '-';
      if (orderDateEl) orderDateEl.textContent = appState.orderInfo.orderDate || '-';
      
      if (orderProductsEl) {
        if (appState.orderInfo.products && appState.orderInfo.products.length > 0) {
          orderProductsEl.innerHTML = appState.orderInfo.products.join(', ');
        } else {
          orderProductsEl.textContent = '-';
        }
      }
    }

    // Êõ¥Êñ∞‰∫ßÂìÅ‰ø°ÊÅØÊòæÁ§∫
    function updateProductsDisplay() {
      const container = document.getElementById('productsList');
      if (!container) return;
      
      if (!appState.products || appState.products.length === 0) {
        container.innerHTML = '<div class="empty-state">ÊöÇÊó†‰∫ßÂìÅ‰ø°ÊÅØ</div>';
        return;
      }
      
      container.innerHTML = appState.products.map(product => `
        <div class="product-item">
          <img src="${product.image}" alt="${product.model}" class="product-image" onerror="this.src='https://via.placeholder.com/50?text=Product'">
          <div class="product-info">
            <div class="product-model">${product.model}</div>
            <div class="product-name">${product.name}</div>
          </div>
        </div>
      `).join('');
    }

    // Âä†ËΩΩÂÆ¢Êà∑‰ø°ÊÅØ
    function loadCustomerInfo() {
      appState.customerInfo = demoCustomerData;
      
      // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
      const customerNameEl = document.getElementById('customerName');
      const customerEmailEl = document.getElementById('customerEmail');
      const customerDreoIdEl = document.getElementById('customerDreoId');
      const customerIdEl = document.getElementById('customerId');
      
      if (customerNameEl) customerNameEl.textContent = demoCustomerData.name;
      if (customerEmailEl) customerEmailEl.textContent = demoCustomerData.email;
      if (customerDreoIdEl) customerDreoIdEl.textContent = demoCustomerData.dreoId;
      if (customerIdEl) customerIdEl.textContent = demoCustomerData.customerId;
      
      // Êõ¥Êñ∞ÂéÜÂè≤ËÆ¢Âçï
      renderTable('orderHistory', ['ËÆ¢ÂçïÁºñÂè∑', '‰∫ßÂìÅ', 'Ëä±Ë¥πÈáëÈ¢ù', 'ÂïÜÂ∫ó', '‰∏ãÂçïÊó∂Èó¥'], 
        demoCustomerData.orders.map(o => [o.orderNumber, o.products, o.amount, o.store, o.date]));
      
      // Êõ¥Êñ∞IoTËÆæÂ§á
      renderTable('iotDevices', ['SN', 'Model', 'ÂìÅÁ±ª', 'ÊúÄÊó©ÈÖçÁΩëÊó∂Èó¥', 'ÊúÄËøëÈÖçÁΩëÊó∂Èó¥', 'ÊúÄËøëÊéßÂà∂Êó∂Èó¥', 'ÂàÜ‰∫´Ë¥¶Âè∑'],
        demoCustomerData.iotDevices.map(d => [d.sn, d.model, d.category, d.firstConnect, d.lastConnect, d.lastControl, d.sharedAccounts]));
      
      // Êõ¥Êñ∞ÂéÜÂè≤Â∑•Âçï
      renderTable('ticketHistory', ['Â∑•ÂçïID', 'Â∑•ÂçïÊ†áÈ¢ò'],
        demoCustomerData.ticketHistory.map(t => [t.ticketId, t.title]));
      
      // Êõ¥Êñ∞ÂéÜÂè≤Êç¢Ë¥ß
      renderTable('exchangeHistory', ['Model', 'RMAÂçï'],
        demoCustomerData.exchangeHistory.map(e => [e.model, e.rma]));
      
      // Êõ¥Êñ∞ÂéÜÂè≤ÈÄÄÊ¨æ
      renderTable('refundHistory', ['Model', 'ÈÄÄË¥ßÂçï'],
        demoCustomerData.refundHistory.map(r => [r.model, r.returnNumber]));
      
      // Êõ¥Êñ∞Ë¥®‰øù‰ø°ÊÅØ
      renderTable('warrantyInfo', ['Model', 'Ê∏†ÈÅìÁ±ªÂûã', 'ÈîÄÂîÆÊ∏†ÈÅì', 'ÂìÅÁ±ª', 'Ë¥®‰øùÂºÄÂßãÊó∂Èó¥', 'Ë¥®‰øùÁªìÊùüÊó∂Èó¥', 'Êèê‰∫§Êó∂Èó¥'],
        demoCustomerData.warrantyInfo.map(w => [w.model, w.channelType, w.salesChannel, w.category, w.startDate, w.endDate, w.submitDate]));
    }

    // Ê∏≤ÊüìË°®Ê†º
    function renderTable(containerId, headers, rows) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      if (!rows || rows.length === 0) {
        container.innerHTML = '<div class="empty-state">ÊöÇÊó†Êï∞ÊçÆ</div>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr>';
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      rows.forEach(row => {
        html += '<tr>';
        row.forEach(cell => {
          html += `<td>${cell || '-'}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ÁªëÂÆö‰∫ã‰ª∂
    function bindEvents() {
      // ÊâìÂºÄÂ∑•ÂÖ∑ÂåÖÊåâÈíÆ
      const openToolkitBtn = document.getElementById('openToolkitBtn');
      if (openToolkitBtn) {
        openToolkitBtn.addEventListener('click', () => {
          const panel = document.getElementById('toolkitPanel');
          const btn = document.getElementById('openToolkitBtn');
          
          if (panel.classList.contains('show')) {
            // ÂÖ≥Èó≠Â∑•ÂÖ∑ÂåÖ
            panel.classList.remove('show');
            btn.classList.remove('active');
          } else {
            // ÊâìÂºÄÂ∑•ÂÖ∑ÂåÖ
            panel.classList.add('show');
            btn.classList.add('active');
            // È¶ñÊ¨°ÊâìÂºÄÊó∂ËØÜÂà´Âú∫ÊôØÂíåËäÇÁÇπ
            if (!appState.scenario) {
              identifyScenarioAndNode();
            }
          }
        });
      }
      
      // ÂÖ≥Èó≠Â∑•ÂÖ∑ÂåÖÊåâÈíÆ
      const closeToolkitBtn = document.getElementById('closeToolkitBtn');
      if (closeToolkitBtn) {
        closeToolkitBtn.addEventListener('click', () => {
          const panel = document.getElementById('toolkitPanel');
          const btn = document.getElementById('openToolkitBtn');
          panel.classList.remove('show');
          if (btn) btn.classList.remove('active');
        });
      }
      
      // ÁîüÊàêÂõûÂ§çÈÇÆ‰ª∂ÊåâÈíÆÔºàÂø´Êç∑ÂõûÂ§çtabÔºâ
      const quickGenerateBtn = document.getElementById('quickGenerateBtn');
      if (quickGenerateBtn) {
        quickGenerateBtn.addEventListener('click', generateEmail);
      }
      
      // Â§çÂà∂ÈÇÆ‰ª∂ÊåâÈíÆ
      const copyEmailBtn = document.getElementById('copyEmailBtn');
      if (copyEmailBtn) {
        copyEmailBtn.addEventListener('click', copyEmail);
      }
      
      // ÊèíÂÖ•ÈÇÆ‰ª∂ÊåâÈíÆ
      const insertEmailBtn = document.getElementById('insertEmailBtn');
      if (insertEmailBtn) {
        insertEmailBtn.addEventListener('click', insertEmail);
      }
      
      // ÊèíÂÖ•ÂèòÈáèÊåâÈíÆ
      const insertVariableBtn = document.getElementById('insertVariableBtn');
      if (insertVariableBtn) {
        insertVariableBtn.addEventListener('click', showVariableMenu);
      }
      
      // ÁºñËæëÂ∑•ÂçïÂú∫ÊôØÊåâÈíÆ
      const editScenarioBtn = document.getElementById('editScenarioBtn');
      if (editScenarioBtn) {
        editScenarioBtn.addEventListener('click', () => {
          const isEditing = editScenarioBtn.getAttribute('data-editing') === 'true';
          if (isEditing) {
            cancelScenarioEdit();
          } else {
            enterScenarioEditMode();
          }
        });
      }
      const saveScenarioBtn = document.getElementById('saveScenarioBtn');
      if (saveScenarioBtn) {
        saveScenarioBtn.addEventListener('click', saveScenario);
      }
      const cancelScenarioBtn = document.getElementById('cancelScenarioBtn');
      if (cancelScenarioBtn) {
        cancelScenarioBtn.addEventListener('click', cancelScenarioEdit);
      }
      const editScenarioSelect = document.getElementById('editScenario');
      if (editScenarioSelect) {
        editScenarioSelect.addEventListener('change', updateSubScenarioOptions);
      }

      // ÁºñËæëËÆ¢Âçï‰ø°ÊÅØÊåâÈíÆ
      const editOrderBtn = document.getElementById('editOrderBtn');
      if (editOrderBtn) {
        editOrderBtn.addEventListener('click', () => {
          const isEditing = editOrderBtn.getAttribute('data-editing') === 'true';
          if (isEditing) {
            cancelOrderEdit();
          } else {
            enterOrderEditMode();
          }
        });
      }
      const saveOrderBtn = document.getElementById('saveOrderBtn');
      if (saveOrderBtn) {
        saveOrderBtn.addEventListener('click', saveOrder);
      }
      const cancelOrderBtn = document.getElementById('cancelOrderBtn');
      if (cancelOrderBtn) {
        cancelOrderBtn.addEventListener('click', cancelOrderEdit);
      }

      // ÁºñËæë‰∫ßÂìÅ‰ø°ÊÅØÊåâÈíÆ
      const editProductsBtn = document.getElementById('editProductsBtn');
      if (editProductsBtn) {
        editProductsBtn.addEventListener('click', () => {
          const isEditing = editProductsBtn.getAttribute('data-editing') === 'true';
          if (isEditing) {
            cancelProductsEdit();
          } else {
            enterProductsEditMode();
          }
        });
      }

      // ÁºñËæëÁâ©ÊµÅ‰ø°ÊÅØÊåâÈíÆ
      const editLogisticsBtn = document.getElementById('editLogisticsBtn');
      if (editLogisticsBtn) {
        editLogisticsBtn.addEventListener('click', () => {
          const isEditing = editLogisticsBtn.getAttribute('data-editing') === 'true';
          if (isEditing) {
            cancelLogisticsEdit();
          } else {
            enterLogisticsEditMode();
          }
        });
      }
      const saveLogisticsBtn = document.getElementById('saveLogisticsBtn');
      if (saveLogisticsBtn) {
        saveLogisticsBtn.addEventListener('click', saveLogistics);
      }
      const cancelLogisticsBtn = document.getElementById('cancelLogisticsBtn');
      if (cancelLogisticsBtn) {
        cancelLogisticsBtn.addEventListener('click', cancelLogisticsEdit);
      }
    }

    // ÁºñËæëÂ∑•ÂçïÂú∫ÊôØ
    function enterScenarioEditMode() {
      const editMode = document.getElementById('scenarioEditMode');
      const badge = document.getElementById('scenarioBadge');
      const details = document.getElementById('scenarioDetails');
      const editBtn = document.getElementById('editScenarioBtn');
      
      if (editMode && badge && details && editBtn) {
        // ÊòæÁ§∫ÁºñËæëÊ®°Âºè
        editMode.style.display = 'block';
        badge.style.display = 'none';
        details.style.display = 'none';
        editBtn.textContent = 'ÂèñÊ∂à';
        editBtn.setAttribute('data-editing', 'true');
        
        // ËÆæÁΩÆÂΩìÂâçÂÄº
        const currentScenario = appState.scenario || 'ÂîÆÂâçÂí®ËØ¢';
        const currentSubScenario = appState.subScenario || '';
        const scenarioSelect = document.getElementById('editScenario');
        const subScenarioSelect = document.getElementById('editSubScenario');
        
        if (scenarioSelect) scenarioSelect.value = currentScenario;
        updateSubScenarioOptions();
        if (subScenarioSelect && currentSubScenario) {
          subScenarioSelect.value = currentSubScenario;
        }
      }
    }

    function updateSubScenarioOptions() {
      const scenarioSelect = document.getElementById('editScenario');
      const subScenarioSelect = document.getElementById('editSubScenario');
      if (!scenarioSelect || !subScenarioSelect) return;
      
      const scenario = scenarioSelect.value;
      const subScenarios = scenarioConfig[scenario] ? Object.keys(scenarioConfig[scenario]) : [];
      
      subScenarioSelect.innerHTML = '';
      subScenarios.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub;
        option.textContent = sub;
        subScenarioSelect.appendChild(option);
      });
    }

    function saveScenario() {
      const scenario = document.getElementById('editScenario').value;
      const subScenario = document.getElementById('editSubScenario').value;
      
      appState.scenario = scenario;
      appState.subScenario = subScenario;
      
      updateScenarioDisplay(scenario, subScenario);
      updateProcessNodeDisplay(appState.currentNode || { id: '', description: '' });
      updateQuickReplyActions();
      
      cancelScenarioEdit();
    }

    function cancelScenarioEdit() {
      const editMode = document.getElementById('scenarioEditMode');
      const badge = document.getElementById('scenarioBadge');
      const details = document.getElementById('scenarioDetails');
      const editBtn = document.getElementById('editScenarioBtn');
      
      if (editMode && badge && details && editBtn) {
        editMode.style.display = 'none';
        badge.style.display = '';
        details.style.display = '';
        editBtn.textContent = 'ÁºñËæë';
        editBtn.removeAttribute('data-editing');
      }
    }

    // ÁºñËæëËÆ¢Âçï‰ø°ÊÅØ
    function enterOrderEditMode() {
      const channelValue = document.getElementById('orderChannel');
      const numberValue = document.getElementById('orderNumber');
      const dateValue = document.getElementById('orderDate');
      const productsValue = document.getElementById('orderProducts');
      const editBtn = document.getElementById('editOrderBtn');
      
      if (channelValue && numberValue && dateValue && productsValue) {
        // ÈöêËóèÊòæÁ§∫ÂÄºÔºåÊòæÁ§∫ËæìÂÖ•Ê°Ü
        channelValue.style.display = 'none';
        numberValue.style.display = 'none';
        dateValue.style.display = 'none';
        productsValue.style.display = 'none';
        
        document.getElementById('editOrderChannel').style.display = '';
        document.getElementById('editOrderNumber').style.display = '';
        document.getElementById('editOrderDate').style.display = '';
        document.getElementById('editOrderProducts').style.display = '';
        document.getElementById('orderEditActions').style.display = 'flex';
        
        // ËÆæÁΩÆÂΩìÂâçÂÄº
        document.getElementById('editOrderChannel').value = appState.orderInfo.channel || '';
        document.getElementById('editOrderNumber').value = appState.orderInfo.orderNumber || '';
        document.getElementById('editOrderDate').value = appState.orderInfo.orderDate || '';
        document.getElementById('editOrderProducts').value = (appState.orderInfo.products || []).join(', ');
        
        editBtn.textContent = 'ÂèñÊ∂à';
        editBtn.setAttribute('data-editing', 'true');
      }
    }

    function saveOrder() {
      const channel = document.getElementById('editOrderChannel').value.trim();
      const number = document.getElementById('editOrderNumber').value.trim();
      const date = document.getElementById('editOrderDate').value.trim();
      const products = document.getElementById('editOrderProducts').value.split(',').map(p => p.trim()).filter(p => p);
      
      appState.orderInfo.channel = channel;
      appState.orderInfo.orderNumber = number;
      appState.orderInfo.orderDate = date;
      appState.orderInfo.products = products;
      
      updateOrderInfoDisplay();
      cancelOrderEdit();
    }

    function cancelOrderEdit() {
      const channelValue = document.getElementById('orderChannel');
      const numberValue = document.getElementById('orderNumber');
      const dateValue = document.getElementById('orderDate');
      const productsValue = document.getElementById('orderProducts');
      const editBtn = document.getElementById('editOrderBtn');
      
      if (channelValue && numberValue && dateValue && productsValue) {
        channelValue.style.display = '';
        numberValue.style.display = '';
        dateValue.style.display = '';
        productsValue.style.display = '';
        
        document.getElementById('editOrderChannel').style.display = 'none';
        document.getElementById('editOrderNumber').style.display = 'none';
        document.getElementById('editOrderDate').style.display = 'none';
        document.getElementById('editOrderProducts').style.display = 'none';
        document.getElementById('orderEditActions').style.display = 'none';
        
        editBtn.textContent = 'ÁºñËæë';
        editBtn.removeAttribute('data-editing');
      }
    }

    // ÁºñËæë‰∫ßÂìÅ‰ø°ÊÅØ
    function enterProductsEditMode() {
      const container = document.getElementById('productsList');
      const editBtn = document.getElementById('editProductsBtn');
      if (!container || !editBtn) return;
      
      const currentModels = appState.products && appState.products.length > 0 
        ? appState.products.map(p => p.model).join(', ')
        : '';
      
      container.innerHTML = `
        <div class="edit-mode">
          <div class="info-row">
            <span class="info-label">‰∫ßÂìÅÂûãÂè∑Ôºö</span>
            <input type="text" id="editProductsInput" class="info-input" value="${currentModels}" placeholder="ËæìÂÖ•‰∫ßÂìÅÂûãÂè∑ÔºåÂ§ö‰∏™Áî®ÈÄóÂè∑ÂàÜÈöî">
          </div>
          <div class="edit-actions">
            <button class="btn btn-primary btn-small" id="saveProductsBtn">‰øùÂ≠ò</button>
            <button class="btn btn-secondary btn-small" id="cancelProductsBtn">ÂèñÊ∂à</button>
          </div>
        </div>
      `;
      
      editBtn.textContent = 'ÂèñÊ∂à';
      editBtn.setAttribute('data-editing', 'true');
      
      document.getElementById('saveProductsBtn').addEventListener('click', saveProducts);
      document.getElementById('cancelProductsBtn').addEventListener('click', cancelProductsEdit);
    }

    function saveProducts() {
      const input = document.getElementById('editProductsInput');
      if (!input) return;
      
      const models = input.value.split(',').map(m => m.trim()).filter(m => m);
      appState.products = models.map(model => ({
        model: model,
        name: `‰∫ßÂìÅ ${model}`,
        image: `https://via.placeholder.com/50?text=${model}`
      }));
      appState.orderInfo.products = models;
      
      updateProductsDisplay();
      updateOrderInfoDisplay();
      cancelProductsEdit();
    }

    function cancelProductsEdit() {
      const editBtn = document.getElementById('editProductsBtn');
      if (editBtn) {
        editBtn.textContent = 'ÁºñËæë';
        editBtn.removeAttribute('data-editing');
      }
      updateProductsDisplay();
    }

    // ÁºñËæëÁâ©ÊµÅ‰ø°ÊÅØ
    function enterLogisticsEditMode() {
      const carrierDisplay = document.getElementById('logisticsCarrierDisplay');
      const numberDisplay = document.getElementById('logisticsNumberDisplay');
      const statusDisplay = document.getElementById('logisticsStatusDisplay');
      const editBtn = document.getElementById('editLogisticsBtn');
      
      if (carrierDisplay && numberDisplay && statusDisplay) {
        // ÈöêËóèÊòæÁ§∫ÂÄºÔºåÊòæÁ§∫ËæìÂÖ•Ê°Ü
        carrierDisplay.style.display = 'none';
        numberDisplay.style.display = 'none';
        statusDisplay.style.display = 'none';
        
        document.getElementById('logisticsCarrier').style.display = '';
        document.getElementById('logisticsNumber').style.display = '';
        document.getElementById('logisticsStatus').style.display = '';
        document.getElementById('logisticsEditActions').style.display = 'flex';
        
        // ËÆæÁΩÆÂΩìÂâçÂÄº
        const carrier = document.getElementById('logisticsCarrier').value || '';
        const number = document.getElementById('logisticsNumber').value || '';
        const status = document.getElementById('logisticsStatus').value || '';
        
        editBtn.textContent = 'ÂèñÊ∂à';
        editBtn.setAttribute('data-editing', 'true');
      }
    }

    function saveLogistics() {
      const carrier = document.getElementById('logisticsCarrier').value.trim();
      const number = document.getElementById('logisticsNumber').value.trim();
      const status = document.getElementById('logisticsStatus').value.trim();
      
      document.getElementById('logisticsCarrierDisplay').textContent = carrier || '-';
      document.getElementById('logisticsNumberDisplay').textContent = number || '-';
      document.getElementById('logisticsStatusDisplay').textContent = status || '-';
      
      cancelLogisticsEdit();
    }

    function cancelLogisticsEdit() {
      const carrierDisplay = document.getElementById('logisticsCarrierDisplay');
      const numberDisplay = document.getElementById('logisticsNumberDisplay');
      const statusDisplay = document.getElementById('logisticsStatusDisplay');
      const editBtn = document.getElementById('editLogisticsBtn');
      
      if (carrierDisplay && numberDisplay && statusDisplay) {
        carrierDisplay.style.display = '';
        numberDisplay.style.display = '';
        statusDisplay.style.display = '';
        
        document.getElementById('logisticsCarrier').style.display = 'none';
        document.getElementById('logisticsNumber').style.display = 'none';
        document.getElementById('logisticsStatus').style.display = 'none';
        document.getElementById('logisticsEditActions').style.display = 'none';
        
        editBtn.textContent = 'ÁºñËæë';
        editBtn.removeAttribute('data-editing');
      }
    }

    // ÊòæÁ§∫ÂèòÈáèËèúÂçï
    function showVariableMenu() {
      const variables = [
        { name: 'ÂÆ¢Êà∑ÂßìÂêç', value: '{{customerName}}' },
        { name: 'ËÆ¢ÂçïÂè∑', value: '{{orderNumber}}' },
        { name: '‰∫ßÂìÅÂûãÂè∑', value: '{{productModel}}' },
        { name: 'Â∑•ÂçïÂè∑', value: '{{ticketId}}' }
      ];
      
      const variable = prompt('ÈÄâÊã©Ë¶ÅÊèíÂÖ•ÁöÑÂèòÈáè:\n1. ÂÆ¢Êà∑ÂßìÂêç\n2. ËÆ¢ÂçïÂè∑\n3. ‰∫ßÂìÅÂûãÂè∑\n4. Â∑•ÂçïÂè∑', '1');
      const editor = document.getElementById('emailEditor');
      if (editor && variable) {
        const index = parseInt(variable) - 1;
        if (index >= 0 && index < variables.length) {
          const cursorPos = editor.selectionStart;
          const textBefore = editor.value.substring(0, cursorPos);
          const textAfter = editor.value.substring(cursorPos);
          editor.value = textBefore + variables[index].value + textAfter;
          editor.focus();
          editor.setSelectionRange(cursorPos + variables[index].value.length, cursorPos + variables[index].value.length);
        }
      }
    }

    // Êõ¥Êñ∞Âø´Êç∑ÂõûÂ§çÂä®‰ΩúÈÄâÈ°π
    function updateQuickReplyActions() {
      const container = document.getElementById('quickReplyActions');
      if (!container) return;
      
      if (!appState.scenario || !appState.subScenario) {
        container.innerHTML = '<div class="empty-state">ËØ∑ÂÖàÂú®Â∑•Âçï‰ø°ÊÅØtab‰∏≠ËØÜÂà´Âú∫ÊôØ</div>';
        return;
      }
      
      const config = scenarioConfig[appState.scenario]?.[appState.subScenario];
      if (!config || !config.actions) {
        container.innerHTML = '<div class="empty-state">ÊöÇÊó†ÂèØÁî®Âä®‰Ωú</div>';
        return;
      }
      
      // Ê∏ÖÁ©∫ÂÆπÂô®ÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
      container.innerHTML = '';
      
      config.actions.forEach((action, index) => {
        const option = document.createElement('div');
        option.className = 'action-item';
        if (index === 0 || action.id === appState.selectedAction?.id) {
          option.classList.add('selected');
          appState.selectedAction = action;
        }
        option.innerHTML = `
          <input type="radio" name="quickAction" id="quick_action_${action.id}" value="${action.id}" ${index === 0 || action.id === appState.selectedAction?.id ? 'checked' : ''}>
          <label for="quick_action_${action.id}">
            <span>${action.icon}</span>
            <span>${action.name}</span>
          </label>
        `;
        
        option.addEventListener('click', () => {
          option.querySelector('input').checked = true;
          document.querySelectorAll('#quickReplyActions .action-item').forEach(opt => {
            opt.classList.remove('selected');
          });
          option.classList.add('selected');
          appState.selectedAction = action;
          // ÈáçÁΩÆÈÇÆ‰ª∂Ë¥®ÈáèÂèçÈ¶àÁªÑ‰ª∂Áä∂ÊÄÅ
          resetFeedbackState();
        });
        
        container.appendChild(option);
      });
    }

    // ËØÜÂà´Âú∫ÊôØÂíåÊµÅÁ®ãËäÇÁÇπ
    async function identifyScenarioAndNode() {
      showLoading();
      hideMainContent();
      
      try {
        // Ê®°ÊãüAPIË∞ÉÁî®ËØÜÂà´Âú∫ÊôØ
        const scenario = await identifyScenario(appState.ticketData);
        appState.scenario = scenario.scenario;
        appState.subScenario = scenario.subScenario;
        
        // ËØÜÂà´ÊµÅÁ®ãËäÇÁÇπ
        const node = await identifyProcessNode(scenario.scenario, scenario.subScenario, appState.ticketData);
        appState.processNode = node;
        
        // Êõ¥Êñ∞UI
        updateScenarioDisplay(scenario.scenario, scenario.subScenario);
        updateProcessNodeDisplay(node);
        
        hideLoading();
        showMainContent();
      } catch (error) {
        console.error('ËØÜÂà´Âú∫ÊôØÂíåËäÇÁÇπÂ§±Ë¥•:', error);
        hideLoading();
        alert('ËØÜÂà´Â§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'));
      }
    }

    // ËØÜÂà´Âú∫ÊôØÔºàÊ®°ÊãüAIËØÜÂà´Ôºâ
    async function identifyScenario(ticketData) {
      // Ê®°ÊãüAPIÂª∂Ëøü
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const subject = ticketData.subject || '';
      const description = ticketData.description || '';
      const content = (subject + ' ' + description).toLowerCase();
      
      // ÂÖ≥ÈîÆËØçÂåπÈÖçËØÜÂà´Âú∫ÊôØ
      if (content.includes('ÂäüËÉΩ') || content.includes('ÂèÇÊï∞') || content.includes('ËßÑÊ†º') || 
          content.includes('function') || content.includes('specification')) {
        return { scenario: 'ÂîÆÂâçÂí®ËØ¢', subScenario: '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢' };
      } else if (content.includes('ÊîøÁ≠ñ') || content.includes('Ë¥®‰øù') || content.includes('‰øù‰øÆ') || 
                 content.includes('ÈÄÄË¥ß') || content.includes('Êç¢Ë¥ß') || content.includes('ÈÄÄÊ¨æ') ||
                 content.includes('policy') || content.includes('warranty')) {
        return { scenario: 'ÂîÆÂâçÂí®ËØ¢', subScenario: 'ÊúçÂä°ÊîøÁ≠ñÂí®ËØ¢' };
      } else if (content.includes('ÂèñÊ∂à') || content.includes('cancel')) {
        return { scenario: 'ËÆ¢ÂçïÈóÆÈ¢ò', subScenario: 'ÈúÄÂèñÊ∂àËÆ¢Âçï' };
      } else if (content.includes('Áâ©ÊµÅ') || content.includes('Âø´ÈÄí') || content.includes('shipping') || 
                 content.includes('delivery')) {
        if (content.includes('‰∏¢Â§±') || content.includes('lost') || content.includes('missing')) {
          return { scenario: 'ËÆ¢ÂçïÈóÆÈ¢ò', subScenario: 'ÂåÖË£π‰∏¢Â§±' };
        }
        return { scenario: 'ËÆ¢ÂçïÈóÆÈ¢ò', subScenario: 'Âí®ËØ¢ËÆ¢ÂçïÁâ©ÊµÅ' };
      } else if (content.includes('‰æøÂÆú') || content.includes('cheap') || content.includes('price')) {
        return { scenario: 'ËÆ¢ÂçïÈóÆÈ¢ò', subScenario: 'Ë¥≠‰π∞ÂêéÂèëÁé∞ÂÖ∂‰ªñÊ∏†ÈÅìÊõ¥‰æøÂÆú' };
      } else if (content.includes('Âª∂‰øù') || content.includes('warranty')) {
        return { scenario: 'ÂîÆÂêéÊúçÂä°', subScenario: 'Âª∂‰øùÊó∂Èïø‰∏çÁ¨¶' };
      } else if (content.includes('ÊçüÂùè') || content.includes('damage') || content.includes('broken')) {
        if (content.includes('ÈÖçÈÄÅ') || content.includes('delivery')) {
          return { scenario: '‰∫ßÂìÅÈóÆÈ¢ò', subScenario: 'ÈÖçÈÄÅÈÄ†ÊàêÊçüÂùè' };
        }
        return { scenario: '‰∫ßÂìÅÈóÆÈ¢ò', subScenario: '‰∏çÂΩ±Âìç‰∏ªÂäüËÉΩÁöÑÈóÆÈ¢òÔºàÂìÅË¥®&Èùû‰∏ªÂäüËÉΩÈóÆÈ¢òÔºâ' };
      } else if (content.includes('‰ΩìÈ™å') || content.includes('experience') || content.includes('ËÆæËÆ°') || 
                 content.includes('design')) {
        return { scenario: '‰∫ßÂìÅÈóÆÈ¢ò', subScenario: '‰∫ßÂìÅ‰ΩìÈ™åÈóÆÈ¢òÔºàÈùûÂìÅË¥®ÈóÆÈ¢òÔºâ' };
      } else if (content.includes('‰∏çÂºÄÊú∫') || content.includes('‰∏çÂä†ÁÉ≠') || content.includes('Ê≤°ÊúâÈ£é') ||
                 content.includes('not working') || content.includes('not heating')) {
        return { scenario: '‰∫ßÂìÅÈóÆÈ¢ò', subScenario: '‰∫ßÂìÅÂäüËÉΩÂìÅË¥®ÈóÆÈ¢ò' };
      } else if (content.includes('ÈÖç‰ª∂') || content.includes('accessory') || content.includes('ÈÅ•ÊéßÂô®')) {
        if (content.includes('Êé•Ëß¶‰∏çËâØ') || content.includes('ÊåâÈîÆÂ§±ÁÅµ') || content.includes('malfunction')) {
          return { scenario: '‰∫ßÂìÅÈóÆÈ¢ò', subScenario: 'ÈÖç‰ª∂Ë¥®ÈáèÈóÆÈ¢ò' };
        }
        return { scenario: '‰∫ßÂìÅÈóÆÈ¢ò', subScenario: 'ÈÖç‰ª∂ÈùûË¥®ÈáèÈóÆÈ¢ò' };
      } else if (content.includes('ÁáÉÁÉß') || content.includes('ÁÅ´Ëä±') || content.includes('ÂÆâÂÖ®') ||
                 content.includes('burn') || content.includes('spark') || content.includes('safety')) {
        return { scenario: '‰∫ßÂìÅÈóÆÈ¢ò', subScenario: 'ÂÆâÂÖ®ÈóÆÈ¢ò' };
      }
      
      // ÈªòËÆ§ËøîÂõû
      return { scenario: 'ÂîÆÂâçÂí®ËØ¢', subScenario: '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢' };
    }

    // ËØÜÂà´ÊµÅÁ®ãËäÇÁÇπÔºàÊ®°ÊãüAIËØÜÂà´Ôºâ
    async function identifyProcessNode(scenario, subScenario, ticketData) {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const config = scenarioConfig[scenario]?.[subScenario];
      if (!config || !config.nodes || config.nodes.length === 0) {
        return { id: 'unknown', name: 'Êú™Áü•ËäÇÁÇπ', description: 'Êó†Ê≥ïËØÜÂà´ÂΩìÂâçËäÇÁÇπ' };
      }
      
      const description = ticketData.description || '';
      const content = description.toLowerCase();
      
      // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÂåÖÂê´‰∫ßÂìÅ‰ø°ÊÅØ
      if (scenario === 'ÂîÆÂâçÂí®ËØ¢' && subScenario === '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢') {
        const hasProductInfo = /‰∫ßÂìÅ|ÂûãÂè∑|ËßÑÊ†º|model/.test(content);
        if (!hasProductInfo) {
          return config.nodes[0]; // Ê£ÄÊü•Â∑•ÂçïÂÜÖÂÆπ
        } else {
          return config.nodes[2]; // Êü•ËØ¢Áü•ËØÜÂ∫ì
        }
      }
      
      // ÈªòËÆ§ËøîÂõûÁ¨¨‰∏Ä‰∏™ËäÇÁÇπ
      return config.nodes[0];
    }

    // Êõ¥Êñ∞Âú∫ÊôØÊòæÁ§∫
    function updateScenarioDisplay(scenario, subScenario) {
      const badge = document.getElementById('scenarioBadge');
      const details = document.getElementById('scenarioDetails');
      
      if (badge) badge.textContent = `${scenario} - ${subScenario}`;
      if (badge) badge.className = 'scenario-badge';
      
      let detailsText = '';
      if (scenario === 'ÂîÆÂâçÂí®ËØ¢') {
        if (subScenario === '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢') {
        //   detailsText = 'Áî®Êà∑Âí®ËØ¢‰∫ßÂìÅÂäüËÉΩ„ÄÅÂèÇÊï∞ÊàñËßÑÊ†º‰ø°ÊÅØÔºåÈúÄË¶ÅÊèê‰æõ‰∫ßÂìÅËØ¥ÊòéÊàñËØ¢ÈóÆÊõ¥Â§ö‰∫ßÂìÅ‰ø°ÊÅØ„ÄÇ';
        } else if (subScenario === 'ÊúçÂä°ÊîøÁ≠ñÂí®ËØ¢') {
          detailsText = 'Áî®Êà∑Âí®ËØ¢ÊúçÂä°ÊîøÁ≠ñÔºåÂåÖÊã¨Ë¥®‰øùÊîøÁ≠ñ„ÄÅÈÄÄÊç¢Ë¥ßÊîøÁ≠ñÁ≠âÔºåÈúÄË¶ÅÊèê‰æõÁõ∏ÂÖ≥ÊîøÁ≠ñËØ¥Êòé„ÄÇ';
        }
      } else if (scenario === 'ËÆ¢ÂçïÈóÆÈ¢ò') {
        detailsText = 'Áî®Êà∑Âí®ËØ¢ËÆ¢ÂçïÁõ∏ÂÖ≥ÈóÆÈ¢òÔºåÈúÄË¶ÅÊ†πÊçÆËÆ¢ÂçïÁä∂ÊÄÅÂíåË¥≠‰π∞Ê∏†ÈÅìËøõË°åÂ§ÑÁêÜ„ÄÇ';
      } else if (scenario === '‰∫ßÂìÅÈóÆÈ¢ò') {
        detailsText = 'Áî®Êà∑ÂèçÈ¶à‰∫ßÂìÅÈóÆÈ¢òÔºåÈúÄË¶ÅÊ†πÊçÆÈóÆÈ¢òÁ±ªÂûãÊèê‰æõÁõ∏Â∫îÁöÑËß£ÂÜ≥ÊñπÊ°à„ÄÇ';
      } else if (scenario === 'ÂîÆÂêéÊúçÂä°') {
        detailsText = 'Áî®Êà∑Âí®ËØ¢ÂîÆÂêéÊúçÂä°Áõ∏ÂÖ≥ÈóÆÈ¢òÔºåÈúÄË¶ÅÊ†∏ÂÆûÂπ∂Â§ÑÁêÜ„ÄÇ';
      }
      
      if (details) details.textContent = detailsText;
    }

    // Êõ¥Êñ∞ÊµÅÁ®ãËäÇÁÇπÊòæÁ§∫
    function updateProcessNodeDisplay(node) {
      const quickReplyRecommendation = document.getElementById('quickReplyRecommendation');
      
      // ÁîüÊàêÊé®ËçêÂ§ÑÁêÜÊñπÂºèÔºàÁÆÄÁü≠Ôºâ
      let recommendText = '';
      if (node.id === 'check_content' || node.id === 'check_order') {
        recommendText = 'Âª∫ËÆÆÔºöÂÖàÁ°ÆËÆ§Áî®Êà∑ÊòØÂê¶Â∑≤Êèê‰æõÂÆåÊï¥‰ø°ÊÅØÔºåÂ¶ÇÊú™Êèê‰æõÂàôÂèëÈÄÅËØ¢ÈóÆÈÇÆ‰ª∂„ÄÇ';
      } else if (node.id === 'query_kb' || node.id === 'query_policy' || node.id === 'query_logistics') {
        recommendText = 'Âª∫ËÆÆÔºöÊü•ËØ¢Áü•ËØÜÂ∫ìÊàñÁ≥ªÁªüËé∑ÂèñÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂáÜÂ§áÂõûÂ§çÂÜÖÂÆπ„ÄÇ';
      } else if (node.id === 'extract_info' || node.id === 'extract_policy') {
        recommendText = 'Âª∫ËÆÆÔºö‰ªéÂ∑•ÂçïÊàñÁü•ËØÜÂ∫ì‰∏≠ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØÔºåÊï¥ÁêÜÊàêÊ∏ÖÊô∞ÁöÑÂõûÂ§ç„ÄÇ';
      } else if (node.id === 'organize_info' || node.id === 'organize_policy') {
        recommendText = 'Âª∫ËÆÆÔºöÊï¥ÁêÜÂπ∂Ê†ºÂºèÂåñ‰ø°ÊÅØÔºåÁ°Æ‰øùÂõûÂ§çÂÜÖÂÆπÂáÜÁ°Æ„ÄÅ‰∏ì‰∏ö„ÄÇ';
      } else if (node.id === 'send_email' || node.id === 'inform_customer') {
        recommendText = 'Âª∫ËÆÆÔºö‰ΩøÁî®ÂêàÈÄÇÁöÑÈÇÆ‰ª∂Ê®°ÊùøÔºåÂèëÈÄÅÂõûÂ§çÁªôÁî®Êà∑„ÄÇ';
      } else if (node.id === 'process_cancel' || node.id === 'process_damage' || node.id === 'process_issue') {
        recommendText = 'Âª∫ËÆÆÔºöÊ†πÊçÆËÆ¢ÂçïÁä∂ÊÄÅÂíåÁî®Êà∑ÈúÄÊ±ÇÔºåÈÄâÊã©ÂêàÈÄÇÁöÑÂ§ÑÁêÜÊñπÊ°àÔºàÈÄÄÊ¨æ/Êç¢Ë¥ß/ÈÄÄË¥ßÁ≠âÔºâ„ÄÇ';
      } else {
        recommendText = 'Âª∫ËÆÆÔºöÊ†πÊçÆÂΩìÂâçÊÉÖÂÜµÈÄâÊã©ÂêàÈÄÇÁöÑ‰∏ã‰∏ÄÊ≠•Âä®‰ΩúÔºåÁ°Æ‰øùÂèäÊó∂ÂìçÂ∫îÁî®Êà∑ÈúÄÊ±Ç„ÄÇ';
      }
      
      if (quickReplyRecommendation) {
        quickReplyRecommendation.textContent = recommendText;
      }
    }

    // Êõ¥Êñ∞Âä®‰ΩúÈÄâÈ°π
    function updateActionOptions(scenario, subScenario, node) {
      const container = document.getElementById('actionOptions');
      if (!container) return;
      
      container.innerHTML = '';
      
      const config = scenarioConfig[scenario]?.[subScenario];
      if (!config || !config.actions) return;
      
      // Ê†πÊçÆÂΩìÂâçËäÇÁÇπËøáÊª§ÂèØÁî®Âä®‰ΩúÔºàÁÆÄÂåñÈÄªËæëÔºâ
      let availableActions = config.actions;
      
      // Â¶ÇÊûúÂ∑≤ÊúâÈÄâ‰∏≠ÁöÑÂä®‰Ωú‰∏îÂú®ÂèØÁî®Âä®‰ΩúÂàóË°®‰∏≠Ôºå‰øùÊåÅÈÄâ‰∏≠ÔºõÂê¶ÂàôÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™Âä®‰Ωú
      if (availableActions.length > 0) {
        const existingSelectedAction = availableActions.find(action => action.id === appState.selectedAction?.id);
        if (!existingSelectedAction) {
          appState.selectedAction = availableActions[0];
        }
      }
      
      availableActions.forEach((action, index) => {
        const option = document.createElement('div');
        option.className = 'action-item';
        // Â¶ÇÊûúÂΩìÂâçÂä®‰ΩúÊòØÂ∑≤ÈÄâ‰∏≠ÁöÑÂä®‰ΩúÔºåÂàôÈÄâ‰∏≠ÂÆÉ
        const isSelected = action.id === appState.selectedAction?.id;
        if (isSelected) {
          option.classList.add('selected');
        }
        option.innerHTML = `
          <input type="radio" name="action" id="action_${action.id}" value="${action.id}" ${isSelected ? 'checked' : ''}>
          <label for="action_${action.id}">
            <span>${action.icon}</span>
            <span>${action.name}</span>
          </label>
        `;
        
        option.addEventListener('click', () => {
          option.querySelector('input').checked = true;
          document.querySelectorAll('#actionOptions .action-item').forEach(opt => {
            opt.classList.remove('selected');
          });
          option.classList.add('selected');
          appState.selectedAction = action;
          // ÈáçÁΩÆÈÇÆ‰ª∂Ë¥®ÈáèÂèçÈ¶àÁªÑ‰ª∂Áä∂ÊÄÅ
          resetFeedbackState();
        });
        
        container.appendChild(option);
      });
    }

    // ÁîüÊàêÂõûÂ§çÈÇÆ‰ª∂
    async function generateEmail() {
      if (!appState.selectedAction) {
        alert('ËØ∑ÂÖàÈÄâÊã©‰∏ã‰∏ÄÊ≠•Âä®‰Ωú');
        return;
      }
      
      const btn = document.getElementById('quickGenerateBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span>ÁîüÊàê‰∏≠...';
      }
      
      try {
        // Ë∞ÉÁî®AI APIÁîüÊàêÈÇÆ‰ª∂ÔºàÊ®°ÊãüÔºâ
        const email = await callAIGenerateEmail(
          appState.scenario,
          appState.subScenario,
          appState.processNode,
          appState.selectedAction,
          appState.ticketData,
          appState.orderInfo,
          appState.products
        );
        
        appState.generatedEmail = email;
        
        // ÊòæÁ§∫ÈÇÆ‰ª∂ÂÜÖÂÆπÂà∞ÁºñËæëÂô®
        const editor = document.getElementById('emailEditor');
        if (editor) {
          editor.value = email;
        }
        
        if (btn) {
          btn.innerHTML = '<span>‚ú®</span>ÁîüÊàêÂõûÂ§çÈÇÆ‰ª∂';
          btn.disabled = false;
        }
      } catch (error) {
        console.error('ÁîüÊàêÈÇÆ‰ª∂Â§±Ë¥•:', error);
        alert('ÁîüÊàêÈÇÆ‰ª∂Â§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'));
        if (btn) {
          btn.innerHTML = '<span>‚ú®</span>ÁîüÊàêÂõûÂ§çÈÇÆ‰ª∂';
          btn.disabled = false;
        }
      }
    }

    // Ë∞ÉÁî®AIÁîüÊàêÈÇÆ‰ª∂ÔºàÊ®°ÊãüAPIË∞ÉÁî®Ôºâ
    async function callAIGenerateEmail(scenario, subScenario, node, action, ticketData, orderInfo, products) {
      // Ê®°ÊãüAPIÂª∂Ëøü
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Ê®°ÊãüÈÇÆ‰ª∂ÁîüÊàêÔºàÂÆûÈôÖÂ∫îËØ•Ë∞ÉÁî®ÂêéÁ´ØAI APIÔºâ
      const customerName = ticketData.requester?.name || 'Â∞äÊï¨ÁöÑÂÆ¢Êà∑';
      const ticketId = ticketData.id;
      const orderNumber = orderInfo.orderNumber || '[ËÆ¢ÂçïÂè∑]';
      const productList = products.map(p => p.model).join(', ') || '[‰∫ßÂìÅÂûãÂè∑]';
      
      let emailContent = '';
      
      if (scenario === 'ÂîÆÂâçÂí®ËØ¢') {
        if (subScenario === '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢') {
          if (action.id === 'ask_info') {
          emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Regarding your inquiry about product functionality, to better provide you with accurate product information, we need the following details:

1. Product name or model number
2. Specific features or parameters you would like to know
3. Your usage scenario or requirements

Please provide the above information, and we will provide you with detailed product specifications as soon as possible.

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
        } else if (action.id === 'provide_info') {
          emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Based on your inquiry, we have prepared the following product specifications:

„ÄêProduct Information„Äë
- Product Model: ${productList}

„ÄêFeatures„Äë
- Feature 1: [Detailed Description]
- Feature 2: [Detailed Description]
- Feature 3: [Detailed Description]

„ÄêTechnical Specifications„Äë
- Parameter 1: [Value]
- Parameter 2: [Value]

„ÄêUsage Instructions„Äë
[Usage Instructions]

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
          }
        } else if (subScenario === 'ÊúçÂä°ÊîøÁ≠ñÂí®ËØ¢') {
          if (action.id === 'provide_policy') {
          emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Regarding your inquiry about service policies, we would like to provide the following information:

„ÄêWarranty Policy„Äë
- Warranty Period: 1 year
- Warranty Coverage: Main components
- Warranty Conditions: Under normal use

„ÄêReturn & Exchange Policy„Äë
- Return Period: Within 7 days
- Exchange Conditions: Product quality issues
- Refund Method: Original payment method

„ÄêOther Policies„Äë
[Other policy information]

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
          } else if (action.id === 'partial_refund') {
          emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Regarding your refund request, we have approved a partial refund.

„ÄêRefund Information„Äë
- Refund Amount: [Amount]
- Refund Method: Original payment method
- Processing Time: 3-5 business days

The refund will be returned to your original payment account. Please check your account.

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
          } else if (action.id === 'exchange') {
          emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Regarding your exchange request, we have approved the exchange.

„ÄêExchange Process„Äë
1. Please return the product to: [Address]
2. We will arrange shipment after receiving the product
3. Estimated processing time: 5-7 business days

„ÄêImportant Notes„Äë
- Please keep the original packaging
- Please include the order number or ticket number

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
          } else if (action.id === 'return') {
          emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Regarding your return request, we have approved the return and refund.

„ÄêReturn Process„Äë
1. Please return the product to: [Address]
2. We will arrange refund after receiving the product
3. Refund Amount: [Amount]
4. Refund Method: Original payment method
5. Estimated processing time: 5-7 business days

„ÄêImportant Notes„Äë
- Please keep the original packaging
- Please include the order number or ticket number

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
          } else if (action.id === 'full_refund') {
          emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Regarding your refund request, we have approved a full refund.

„ÄêRefund Information„Äë
- Refund Amount: [Amount]
- Refund Method: Original payment method
- Processing Time: 3-5 business days

The refund will be returned to your original payment account. Please check your account.

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
          }
        }
      } else if (scenario === 'ËÆ¢ÂçïÈóÆÈ¢ò') {
        emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

Regarding your order inquiry (Order #${orderNumber}), we are processing your request.

[Action-specific content based on selected action]

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
      } else if (scenario === '‰∫ßÂìÅÈóÆÈ¢ò') {
        emailContent = `Dear ${customerName},

Thank you for contacting our customer service team.

We understand your concern regarding the product issue. We are here to help you resolve this matter.

„ÄêOrder Information„Äë
- Order Number: ${orderNumber}
- Product Model: ${productList}

[Action-specific content based on selected action]

If you have any questions, please feel free to contact us.

Best regards,
Customer Service Team
Ticket #${ticketId}`;
      }
      
      return emailContent || 'ÈÇÆ‰ª∂ÂõûÂ§çÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ';
    }

    // ÊóßÁöÑÈÇÆ‰ª∂Êìç‰ΩúÂáΩÊï∞ÔºàÂ∑≤Ë¢´‰∏ãÊñπÁöÑÊñ∞ÁâàÊú¨Ë¶ÜÁõñÔºâ
    /*
    function copyEmail() {
      const editor = document.getElementById('emailEditor');
      const email = editor ? editor.value : appState.generatedEmail;
      
      if (!email) {
        alert('ËØ∑ÂÖàÁîüÊàêÈÇÆ‰ª∂');
        return;
      }
      
      navigator.clipboard.writeText(email).then(() => {
        const btn = document.getElementById('copyEmailBtn');
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span>‚úì</span>Â∑≤Â§çÂà∂';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        }
      }).catch(err => {
        console.error('Â§çÂà∂Â§±Ë¥•:', err);
        alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
      });
    }

    function insertEmail() {
      const editor = document.getElementById('emailEditor');
      const email = editor ? editor.value : appState.generatedEmail;
      
      if (!email) {
        alert('ËØ∑ÂÖàÁîüÊàêÈÇÆ‰ª∂');
        return;
      }
      
      const textarea = document.getElementById('replyTextarea');
      if (textarea) {
        textarea.value = email;
        textarea.focus();
      }
      
      const btn = document.getElementById('insertEmailBtn');
      if (btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span>‚úì</span>Â∑≤ÊèíÂÖ•';
        setTimeout(() => {
          btn.innerHTML = originalText;
        }, 2000);
      }
    }
    */

    // Â∑•ÂÖ∑ÂáΩÊï∞
    function showLoading() {
      document.getElementById('loadingState').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingState').classList.add('hidden');
    }

    function showMainContent() {
      document.getElementById('mainContent').classList.remove('hidden');
    }

    function hideMainContent() {
      document.getElementById('mainContent').classList.add('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // --- Âø´Êç∑Â§ÑÁêÜÔºàÂØπËØùÂºè UIÔºâÈÄªËæë ---

    // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®ÂΩìÂâçÈÄâÊã©ÁöÑÂä®‰Ωú
    let currentSelectedAction = null;

    // ‰∏ÄÈîÆÂàÜÊûêÂäüËÉΩ
    async function startNewAnalysis() {
      const analysisBtn = document.getElementById('analysisBtn');
      const analysisResult = document.getElementById('analysisResult');
      const emailPreviewContainer = document.getElementById('emailPreviewContainer');
      
      // Á¶ÅÁî®ÊåâÈíÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      analysisBtn.disabled = true;
      analysisBtn.innerHTML = '<span class="loading-spinner"></span><span>ÂàÜÊûê‰∏≠...</span>';
      
      // ÈöêËóèÈÇÆ‰ª∂È¢ÑËßà
      emailPreviewContainer.classList.add('hidden');
      
      try {
        // Ë∞ÉÁî®ÂéüÊúâÁöÑËØÜÂà´ÈÄªËæë
        const scenario = await identifyScenario(appState.ticketData);
        appState.scenario = scenario.scenario;
        appState.subScenario = scenario.subScenario;
        
        const node = await identifyProcessNode(scenario.scenario, scenario.subScenario, appState.ticketData);
        appState.processNode = node;
        
        // Êõ¥Êñ∞Â∑•Âçï‰ø°ÊÅØTabÁöÑÊòæÁ§∫Ôºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºâ
        updateScenarioDisplay(scenario.scenario, scenario.subScenario);
        updateProcessNodeDisplay(node);
        
        // ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØÁî®‰∫éÂ±ïÁ§∫
        const orderInfo = appState.orderInfo || {};
        const products = appState.products || [];
        const productNames = products.map(p => p.model).join(', ') || 'Êú™ËØÜÂà´';
        
        // Ê£ÄÊü•‰ø°ÊÅØÂÆåÊï¥ÊÄß
        const hasProductInfo = products.length > 0 && productNames !== 'Êú™ËØÜÂà´';
        const hasOrderInfo = orderInfo.orderNumber && orderInfo.orderNumber !== 'Êú™ËØÜÂà´';
        
        // Êõ¥Êñ∞ÂàÜÊûêÁªìÊûúÊòæÁ§∫
        document.getElementById('scenarioBadgeQuick').textContent = `${scenario.scenario} - ${scenario.subScenario}`;
        document.getElementById('scenarioDetailsQuick').textContent = '';
        document.getElementById('extractedOrderNumber').textContent = orderInfo.orderNumber || 'Êú™ËØÜÂà´';
        document.getElementById('extractedChannel').textContent = orderInfo.channel || 'Êú™ËØÜÂà´';
        document.getElementById('extractedOrderDate').textContent = orderInfo.orderDate || 'Êú™ËØÜÂà´';
        document.getElementById('extractedProduct').textContent = productNames;
        
        // ÁîüÊàêÊô∫ËÉΩÂª∫ËÆÆ
        let recommendation = '';
        if (scenario.scenario === '‰∫ßÂìÅÈóÆÈ¢ò') {
          if (!hasProductInfo) {
            recommendation = 'ÂΩìÂâçÁî®Êà∑Êú™Êèê‰æõ‰∫ßÂìÅ‰ø°ÊÅØÔºåÊó†Ê≥ïÁõ¥Êé•Êèê‰æõËß£ÂÜ≥ÊñπÊ°àÔºåÂª∫ËÆÆÂÖàÈÇÆ‰ª∂ËØ¢ÈóÆÁî®Êà∑ÊàñÊâãÂä®Ë°•ÂÖÖ‰∫ßÂìÅ‰ø°ÊÅØÂêéÂÜçËøõ‰∏ÄÊ≠•ÂõûÂ§ç„ÄÇ';
          } else if (!hasOrderInfo) {
            recommendation = 'ÂΩìÂâçÁî®Êà∑Êú™Êèê‰æõËÆ¢Âçï‰ø°ÊÅØÔºåÂª∫ËÆÆÂÖàÈÇÆ‰ª∂ËØ¢ÈóÆÁî®Êà∑ËÆ¢ÂçïÂè∑ÊàñÊâãÂä®Ë°•ÂÖÖËÆ¢Âçï‰ø°ÊÅØÂêéÂÜçËøõ‰∏ÄÊ≠•ÂõûÂ§ç„ÄÇ';
          } else {
            recommendation = 'Â∑≤ÊèêÂèñÂà∞ÂÆåÊï¥ÁöÑËÆ¢ÂçïÂíå‰∫ßÂìÅ‰ø°ÊÅØÔºåÂèØ‰ª•Ê†πÊçÆÂΩìÂâçËäÇÁÇπÈÄâÊã©‰∏ã‰∏ÄÊ≠•Âä®‰ΩúÔºàÂ¶ÇÊèê‰æõÊéíÈîôÊ≠•È™§„ÄÅÂ§ÑÁêÜÈÄÄÊ¨æÁ≠âÔºâ„ÄÇ';
          }
        } else if (scenario.scenario === 'ËÆ¢ÂçïÈóÆÈ¢ò') {
          if (!hasOrderInfo) {
            recommendation = 'ÂΩìÂâçÁî®Êà∑Êú™Êèê‰æõËÆ¢Âçï‰ø°ÊÅØÔºåÊó†Ê≥ïÊü•ËØ¢ËÆ¢ÂçïÁä∂ÊÄÅÔºåÂª∫ËÆÆÂÖàÈÇÆ‰ª∂ËØ¢ÈóÆÁî®Êà∑ËÆ¢ÂçïÂè∑ÊàñÊâãÂä®Ë°•ÂÖÖËÆ¢Âçï‰ø°ÊÅØÂêéÂÜçËøõ‰∏ÄÊ≠•ÂõûÂ§ç„ÄÇ';
          } else {
            recommendation = 'Â∑≤ÊèêÂèñÂà∞ËÆ¢Âçï‰ø°ÊÅØÔºåÂèØ‰ª•Ê†πÊçÆËÆ¢ÂçïÁä∂ÊÄÅÂíåÁî®Êà∑ÈúÄÊ±ÇÈÄâÊã©ÂêàÈÄÇÁöÑÂ§ÑÁêÜÊñπÊ°à„ÄÇ';
          }
        } else if (scenario.scenario === 'ÂîÆÂâçÂí®ËØ¢') {
          if (!hasProductInfo && (scenario.subScenario === '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢')) {
            recommendation = 'ÂΩìÂâçÁî®Êà∑Êú™Êèê‰æõ‰∫ßÂìÅ‰ø°ÊÅØÔºåÊó†Ê≥ïÊèê‰æõÂáÜÁ°ÆÁöÑ‰∫ßÂìÅÂäüËÉΩËØ¥ÊòéÔºåÂª∫ËÆÆÂÖàÈÇÆ‰ª∂ËØ¢ÈóÆÁî®Êà∑‰∫ßÂìÅÂûãÂè∑ÊàñÊâãÂä®Ë°•ÂÖÖ‰∫ßÂìÅ‰ø°ÊÅØÂêéÂÜçËøõ‰∏ÄÊ≠•ÂõûÂ§ç„ÄÇ';
          } else {
            recommendation = 'ÂèØ‰ª•Ê†πÊçÆÁî®Êà∑Âí®ËØ¢ÂÜÖÂÆπÊèê‰æõÁõ∏Â∫îÁöÑ‰∫ßÂìÅ‰ø°ÊÅØÊàñÊúçÂä°ÊîøÁ≠ñËØ¥Êòé„ÄÇ';
          }
        } else {
          recommendation = 'Ê†πÊçÆÂΩìÂâçÊÉÖÂÜµÈÄâÊã©ÂêàÈÄÇÁöÑ‰∏ã‰∏ÄÊ≠•Âä®‰ΩúÔºåÁ°Æ‰øùÂèäÊó∂ÂìçÂ∫îÁî®Êà∑ÈúÄÊ±Ç„ÄÇ';
        }
        
        document.getElementById('suggestionText').textContent = recommendation;
        
        // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
        analysisResult.classList.remove('hidden');
        
        // ÊûÑÂª∫ÂΩìÂâçÊï∞ÊçÆÂø´ÁÖß
        const currentData = {
          scenario: `${scenario.scenario}${scenario.subScenario ? ' - ' + scenario.subScenario : ''}`,
          processNode: node.name || 'Êú™ËØÜÂà´',
          orderNumber: orderInfo.orderNumber || 'Êú™ËØÜÂà´',
          channel: orderInfo.channel || 'Êú™ËØÜÂà´',
          orderDate: orderInfo.orderDate || 'Êú™ËØÜÂà´',
          products: productNames
        };
        
        // Ëé∑Âèñ‰∏ä‰∏ÄÊ¨°Êõ¥Êñ∞Êï∞ÊçÆÔºàÂ¶ÇÊûúÊúâÔºâ
        const lastUpdate = appState.updateHistory.length > 0 ? appState.updateHistory[0] : null;
        
        // ÁîüÊàêÊõ¥Êñ∞Êó•Âøó
        const updateLog = generateUpdateLog(lastUpdate, currentData, 'ÂàÜÊûê');
        
        // ÊØèÊ¨°ÂàÜÊûêÈÉΩ‰øùÂ≠òÊõ¥Êñ∞ÂéÜÂè≤
        const updateHistoryItem = {
          id: Date.now(),
          updateTime: new Date().toLocaleString('zh-CN'),
          updateLog: updateLog || 'Êó†Êõ¥Êñ∞',
          updateType: 'AIÁîüÊàê',
          lastData: currentData // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆÂø´ÁÖßÔºåÁî®‰∫é‰∏ãÊ¨°ÊØîËæÉ
        };
        
        appState.updateHistory.unshift(updateHistoryItem); // Ê∑ªÂä†Âà∞ÂºÄÂ§¥ÔºåÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢
        
        // ÊòæÁ§∫ÁºñËæë‰ø°ÊÅØÂíåÊõ¥Êñ∞ÂéÜÂè≤ÊåâÈíÆÔºàÈ¶ñÊ¨°ÂàÜÊûêÂêéÊòæÁ§∫Ôºâ
        const analysisActionButtons = document.getElementById('analysisActionButtons');
        if (analysisActionButtons) {
          analysisActionButtons.style.display = 'inline-block';
        }
        
        // Ëé∑ÂèñÊé®ËçêÂä®‰ΩúÂπ∂Êõ¥Êñ∞Âä®‰ΩúÂàóË°®
        const config = scenarioConfig[appState.scenario]?.[appState.subScenario];
        updateActionsGrid(config, hasProductInfo, hasOrderInfo);
        
      } catch (error) {
        console.error(error);
        alert('ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÔºö' + error.message);
      } finally {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        analysisBtn.disabled = false;
        analysisBtn.innerHTML = '<span>‚ú®</span><span>‰∏ÄÈîÆÂàÜÊûê</span>';
      }
    }

    // ÁîüÊàêÊõ¥Êñ∞Êó•Âøó
    function generateUpdateLog(lastUpdate, currentData, updateType) {
      if (!lastUpdate) {
        // È¶ñÊ¨°Êõ¥Êñ∞ÔºåËÆ∞ÂΩïÊâÄÊúâ‰ø°ÊÅØ
        const updates = [];
        if (currentData.scenario && currentData.scenario !== 'Êú™ËØÜÂà´') {
          updates.push(`Âú∫ÊôØÔºö${currentData.scenario}`);
        }
        if (currentData.processNode && currentData.processNode !== 'Êú™ËØÜÂà´') {
          updates.push(`Â§ÑÁêÜËøõÂ∫¶Ôºö${currentData.processNode}`);
        }
        if (currentData.orderNumber && currentData.orderNumber !== 'Êú™ËØÜÂà´') {
          updates.push(`ËÆ¢ÂçïÂè∑Ôºö${currentData.orderNumber}`);
        }
        if (currentData.channel && currentData.channel !== 'Êú™ËØÜÂà´') {
          updates.push(`Ë¥≠‰π∞Ê∏†ÈÅìÔºö${currentData.channel}`);
        }
        if (currentData.orderDate && currentData.orderDate !== 'Êú™ËØÜÂà´') {
          updates.push(`ËÆ¢ÂçïÊó•ÊúüÔºö${currentData.orderDate}`);
        }
        if (currentData.products && currentData.products !== 'Êú™ËØÜÂà´') {
          updates.push(`‰∫ßÂìÅÂûãÂè∑Ôºö${currentData.products}`);
        }
        return updates.length > 0 ? updates.join('Ôºõ') : 'Êó†';
      }
      
      // Ëé∑Âèñ‰∏ä‰∏ÄÊ¨°ÁöÑÊï∞ÊçÆÂø´ÁÖß
      const lastData = lastUpdate.lastData || {};
      const updates = [];
      
      // ÊØîËæÉÂú∫ÊôØ
      if (lastData.scenario !== currentData.scenario && currentData.scenario !== 'Êú™ËØÜÂà´') {
        updates.push(`Âú∫ÊôØÔºö${lastData.scenario || 'Êú™ËÆæÁΩÆ'} ‚Üí ${currentData.scenario}`);
      }
      
      // ÊØîËæÉÂ§ÑÁêÜËøõÂ∫¶
      if (lastData.processNode !== currentData.processNode && currentData.processNode !== 'Êú™ËØÜÂà´') {
        updates.push(`Â§ÑÁêÜËøõÂ∫¶Ôºö${lastData.processNode || 'Êú™ËÆæÁΩÆ'} ‚Üí ${currentData.processNode}`);
      }
      
      // ÊØîËæÉËÆ¢ÂçïÂè∑
      if (lastData.orderNumber !== currentData.orderNumber && currentData.orderNumber !== 'Êú™ËØÜÂà´') {
        updates.push(`ËÆ¢ÂçïÂè∑Ôºö${lastData.orderNumber || 'Êú™ËÆæÁΩÆ'} ‚Üí ${currentData.orderNumber}`);
      }
      
      // ÊØîËæÉË¥≠‰π∞Ê∏†ÈÅì
      if (lastData.channel !== currentData.channel && currentData.channel !== 'Êú™ËØÜÂà´') {
        updates.push(`Ë¥≠‰π∞Ê∏†ÈÅìÔºö${lastData.channel || 'Êú™ËÆæÁΩÆ'} ‚Üí ${currentData.channel}`);
      }
      
      // ÊØîËæÉËÆ¢ÂçïÊó•Êúü
      if (lastData.orderDate !== currentData.orderDate && currentData.orderDate !== 'Êú™ËØÜÂà´') {
        updates.push(`ËÆ¢ÂçïÊó•ÊúüÔºö${lastData.orderDate || 'Êú™ËÆæÁΩÆ'} ‚Üí ${currentData.orderDate}`);
      }
      
      // ÊØîËæÉ‰∫ßÂìÅÂûãÂè∑
      if (lastData.products !== currentData.products && currentData.products !== 'Êú™ËØÜÂà´') {
        updates.push(`‰∫ßÂìÅÂûãÂè∑Ôºö${lastData.products || 'Êú™ËÆæÁΩÆ'} ‚Üí ${currentData.products}`);
      }
      
      return updates.length > 0 ? updates.join('Ôºõ') : 'Êó†Êõ¥Êñ∞';
    }
    
    // Ëé∑ÂèñÂΩìÂâçÊï∞ÊçÆÂø´ÁÖß
    function getCurrentDataSnapshot() {
      const orderInfo = appState.orderInfo || {};
      const products = appState.products || [];
      const productNames = products.map(p => p.model).join(', ') || 'Êú™ËØÜÂà´';
      
      return {
        scenario: `${appState.scenario || ''}${appState.subScenario ? ' - ' + appState.subScenario : ''}` || 'Êú™ËØÜÂà´',
        processNode: appState.processNode?.name || 'Êú™ËØÜÂà´',
        orderNumber: orderInfo.orderNumber || 'Êú™ËØÜÂà´',
        channel: orderInfo.channel || 'Êú™ËØÜÂà´',
        orderDate: orderInfo.orderDate || 'Êú™ËØÜÂà´',
        products: productNames
      };
    }

    // Êõ¥Êñ∞Âä®‰ΩúÁΩëÊ†º
    function updateActionsGrid(config, hasProductInfo, hasOrderInfo) {
      const actionsContainer = document.getElementById('actionsContainer');
      if (!actionsContainer) return;
      
      actionsContainer.innerHTML = '';
      
      // Â¶ÇÊûú‰ø°ÊÅØ‰∏çÂÆåÊï¥Ôºå‰ºòÂÖàÊòæÁ§∫Ë°•ÂÖÖ‰ø°ÊÅØÈÄâÈ°π
      const needInfo = (!hasProductInfo && appState.scenario === '‰∫ßÂìÅÈóÆÈ¢ò') || 
                       (!hasOrderInfo && appState.scenario === 'ËÆ¢ÂçïÈóÆÈ¢ò') ||
                       (!hasProductInfo && appState.scenario === 'ÂîÆÂâçÂí®ËØ¢' && appState.subScenario === '‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢');
      
      // Ê£ÄÊü•Âú∫ÊôØÈÖçÁΩÆ‰∏≠ÊòØÂê¶Â∑≤ÁªèÂåÖÂê´ËØ¢ÈóÆÁ±ªÁöÑÂä®‰Ωú
      const hasAskAction = config && config.actions && config.actions.some(action => 
        action.id === 'ask_info' || action.name.includes('ËØ¢ÈóÆ')
      );
      
      // Êî∂ÈõÜÊâÄÊúâÂä®‰Ωú
      const allActions = [];
      
      // Â¶ÇÊûú‰ø°ÊÅØ‰∏çÂÆåÊï¥‰∏îÂú∫ÊôØÈÖçÁΩÆ‰∏≠Ê≤°ÊúâËØ¢ÈóÆÁ±ªÂä®‰ΩúÔºåÊâçÊ∑ªÂä†ÈÄöÁî®ÁöÑËØ¢ÈóÆÂÆ¢Êà∑ÊåâÈíÆ
      if (needInfo && !hasAskAction) {
        allActions.push({ id: 'ask_info', name: '‚ùì ËØ¢ÈóÆÂÆ¢Êà∑', isRecommended: false });
      }
      
      // Ê∑ªÂä†Âú∫ÊôØÈÖçÁΩÆÁöÑÂä®‰Ωú
      if (config && config.actions) {
        config.actions.forEach((action, index) => {
          allActions.push({
            ...action,
            displayName: action.name,
            isRecommended: false // ÂÖàÈÉΩËÆæ‰∏∫falseÔºåÂêéÈù¢ÂÜçÁ°ÆÂÆöÊé®ËçêÂä®‰Ωú
          });
        });
      }
      
      // Á°ÆÂÆöÊé®ËçêÂä®‰ΩúÔºö‰ªÖ‰øùÁïô‰∏Ä‰∏™Êé®ËçêÂä®‰Ωú
      // ‰ºòÂÖàÈÄâÊã©ÊúârecommendedÂ≠óÊÆµ‰∏î‰∏∫trueÁöÑÂä®‰ΩúÔºåÂê¶ÂàôÈÄâÊã©Á¨¨‰∏Ä‰∏™Âä®‰Ωú
      let recommendedAction = null;
      if (allActions.length > 0) {
        // ÂÖàÊü•ÊâæÊòéÁ°ÆÊ†áËÆ∞‰∏∫Êé®ËçêÁöÑÂä®‰Ωú
        recommendedAction = allActions.find(action => action.recommended === true);
        // Â¶ÇÊûúÊ≤°ÊúâÊòéÁ°ÆÊ†áËÆ∞ÁöÑÔºåÂàôÈÄâÊã©Á¨¨‰∏Ä‰∏™Âä®‰Ωú
        if (!recommendedAction) {
          recommendedAction = allActions[0];
        }
        // Ê†áËÆ∞‰∏∫Êé®ËçêÂä®‰ΩúÔºàÁ°Æ‰øùÂè™Êúâ‰∏Ä‰∏™Ôºâ
        recommendedAction.isRecommended = true;
      }
      
      // ÂàÜÁ¶ªÊé®ËçêÂä®‰ΩúÂíåÂÖ∂‰ªñÂä®‰ΩúÔºàÊé®ËçêÂä®‰Ωú‰ªÖ‰øùÁïô‰∏Ä‰∏™Ôºâ
      const recommendedActions = recommendedAction ? [recommendedAction] : [];
      const otherActions = allActions.filter(action => action !== recommendedAction);
      
      // ÂàõÂª∫Êé®ËçêÂä®‰ΩúÂàÜÁªÑ
      if (recommendedActions.length > 0) {
        const recommendedGroup = document.createElement('div');
        recommendedGroup.className = 'action-group';
        
        const recommendedTitle = document.createElement('div');
        recommendedTitle.className = 'action-group-title recommended';
        const recommendedTitleText = document.createElement('span');
        recommendedTitleText.textContent = '‚≠ê Êé®ËçêÂ§ÑÁêÜ';
        recommendedTitle.appendChild(recommendedTitleText);
        recommendedGroup.appendChild(recommendedTitle);
        
        const recommendedGrid = document.createElement('div');
        recommendedGrid.className = 'actions-grid';
        
        recommendedActions.forEach(action => {
          const card = document.createElement('div');
          card.className = 'action-card';
          if (appState.selectedAction && action.id === appState.selectedAction.id) {
            card.classList.add('selected');
          }
          card.textContent = action.displayName || action.name;
          card.onclick = () => selectAction(action);
          recommendedGrid.appendChild(card);
        });
        
        recommendedGroup.appendChild(recommendedGrid);
        actionsContainer.appendChild(recommendedGroup);
      }
      
      // ÂàõÂª∫ÂÖ∂‰ªñÂä®‰ΩúÂàÜÁªÑÔºàÈªòËÆ§Êî∂Ëµ∑Ôºâ
      if (otherActions.length > 0) {
        const otherGroup = document.createElement('div');
        otherGroup.className = 'action-group collapsed'; // ÈªòËÆ§Ê∑ªÂä†collapsedÁ±ª
        
        const otherTitle = document.createElement('div');
        otherTitle.className = 'action-group-title';
        const titleText = document.createElement('span');
        titleText.textContent = `ÂÖ∂‰ªñÂ§ÑÁêÜ (${otherActions.length})`;
        otherTitle.appendChild(titleText);
        
        const toggleIcon = document.createElement('span');
        toggleIcon.className = 'toggle-icon';
        toggleIcon.textContent = '‚ñº';
        otherTitle.appendChild(toggleIcon);
        
        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Êù•ÂàáÊç¢Â±ïÂºÄ/Êî∂Ëµ∑
        otherTitle.onclick = () => {
          otherGroup.classList.toggle('collapsed');
        };
        
        otherGroup.appendChild(otherTitle);
        
        const otherGrid = document.createElement('div');
        otherGrid.className = 'actions-grid';
        
        otherActions.forEach(action => {
          const card = document.createElement('div');
          card.className = 'action-card';
          if (appState.selectedAction && action.id === appState.selectedAction.id) {
            card.classList.add('selected');
          }
          card.textContent = action.displayName || action.name;
          card.onclick = () => selectAction(action);
          otherGrid.appendChild(card);
        });
        
        otherGroup.appendChild(otherGrid);
        actionsContainer.appendChild(otherGroup);
      }
      
      // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÂä®‰ΩúÔºåÊòæÁ§∫ÊèêÁ§∫
      if (recommendedActions.length === 0 && otherActions.length === 0) {
        const emptyGroup = document.createElement('div');
        emptyGroup.className = 'action-group';
        
        const emptyGrid = document.createElement('div');
        emptyGrid.className = 'actions-grid';
        
        const emptyCard = document.createElement('div');
        emptyCard.className = 'action-card disabled';
        emptyCard.textContent = 'ÊöÇÊó†ÂèØÁî®Âä®‰Ωú';
        emptyGrid.appendChild(emptyCard);
        
        emptyGroup.appendChild(emptyGrid);
        actionsContainer.appendChild(emptyGroup);
      }
    }

    // ÊóßÁöÑÂØπËØùÂºèÂáΩÊï∞ÔºàÂ∑≤Â∫üÂºÉÔºâ
    /*
    function handleSupplement() {
      addChatMessage('user', 'Ë°•ÂÖÖ‰ø°ÊÅØ');
      addChatMessage('ai', 'ËØ∑ÈÄâÊã©Ë°•ÂÖÖÊñπÂºèÔºö', [
        { text: '‚úèÔ∏è ÊâãÂä®Ë°•ÂÖÖ', handler: () => {
             addChatMessage('user', 'ÊâãÂä®Ë°•ÂÖÖ');
             // ÂàáÊç¢Âà∞Â∑•Âçï‰ø°ÊÅØTab
             switchTab('ticket-info');
             addChatMessage('ai', 'ËØ∑ÂàáÊç¢Âà∞‚ÄúÂ∑•Âçï‰ø°ÊÅØ‚ÄùÊ†áÁ≠æÈ°µÊâãÂä®ÁºñËæëÁõ∏ÂÖ≥Â≠óÊÆµ„ÄÇÁºñËæëÂÆåÊàêÂêéÔºåËØ∑ÂÜçÊ¨°ÁÇπÂáª‚ÄúÁîüÊàêÈÇÆ‰ª∂‚Äù„ÄÇ', [
               { text: '‚ú® ÁîüÊàêÈÇÆ‰ª∂', primary: true, handler: handleGenerateEmail }
             ]);
        }},
        { text: '‚ùì ËØ¢ÈóÆÂÆ¢Êà∑', handler: () => {
            addChatMessage('user', 'ËØ¢ÈóÆÂÆ¢Êà∑');
            // Áõ¥Êé•ÁîüÊàêËØ¢ÈóÆÈÇÆ‰ª∂
            generateAndShowEmail('ask_info'); 
        }}
      ]);
    }

    function handleGenerateEmail() {
      addChatMessage('user', 'ÁîüÊàêÈÇÆ‰ª∂');
      
      // Ëé∑ÂèñÂΩìÂâçÂú∫ÊôØÁöÑÊé®ËçêÂä®‰Ωú
      const config = scenarioConfig[appState.scenario]?.[appState.subScenario];
      if (!config || !config.actions) {
        addChatMessage('ai', 'ÂΩìÂâçÂú∫ÊôØÊ≤°ÊúâÈÖçÁΩÆÊé®ËçêÂä®‰Ωú„ÄÇ');
        return;
      }
      
      // ÊòæÁ§∫‰∏ã‰∏ÄÊ≠•Âä®‰ΩúÂª∫ËÆÆ
      let actionButtons = config.actions.map(action => ({
        text: action.name,
        handler: () => generateAndShowEmail(action.id, action)
      }));
      
      addChatMessage('ai', 'ËØ∑Á°ÆËÆ§‰∏ã‰∏ÄÊ≠•Âä®‰ΩúÔºö', actionButtons);
    }
    */
    
    // Ê£ÄÊü•ÈÇÆ‰ª∂ÂÜÖÂÆπÊòØÂê¶ÂÆåÊï¥
    function checkEmailCompleteness(email, scenario, subScenario, actionObj) {
      const missingFields = [];
      
      // Ê£ÄÊü•Â∏∏ËßÅÂç†‰ΩçÁ¨¶
      const placeholders = [
        { pattern: /\[ËÆ¢ÂçïÂè∑\]|\[ËÆ¢ÂçïÂè∑\]/i, field: 'ËÆ¢ÂçïÂè∑', check: () => {
          const orderInfo = appState.orderInfo || {};
          return !orderInfo.orderNumber || orderInfo.orderNumber === 'Êú™ËØÜÂà´' || orderInfo.orderNumber === '[ËÆ¢ÂçïÂè∑]';
        }},
        { pattern: /\[‰∫ßÂìÅÂûãÂè∑\]|\[‰∫ßÂìÅÂûãÂè∑\]/i, field: '‰∫ßÂìÅÂûãÂè∑', check: () => {
          const products = appState.products || [];
          return products.length === 0 || products.every(p => !p.model || p.model === 'Êú™ËØÜÂà´');
        }},
        { pattern: /\[Amount\]|\[ÈáëÈ¢ù\]/i, field: 'ÈÄÄÊ¨æÈáëÈ¢ù', check: () => {
          // ÂØπ‰∫éÈÄÄÊ¨æÁõ∏ÂÖ≥ÁöÑÂä®‰ΩúÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÈáëÈ¢ù‰ø°ÊÅØ
          if (actionObj && (actionObj.id === 'partial_refund' || actionObj.id === 'full_refund' || actionObj.id === 'return')) {
            return true; // ÈúÄË¶ÅÊâãÂä®Â°´ÂÜôÈáëÈ¢ù
          }
          return false;
        }},
        { pattern: /\[Address\]|\[Âú∞ÂùÄ\]/i, field: 'ÈÄÄË¥ßÂú∞ÂùÄ', check: () => {
          // ÂØπ‰∫éÈÄÄË¥ß/Êç¢Ë¥ßÁõ∏ÂÖ≥ÁöÑÂä®‰ΩúÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÂú∞ÂùÄ‰ø°ÊÅØ
          if (actionObj && (actionObj.id === 'exchange' || actionObj.id === 'return')) {
            return true; // ÈúÄË¶ÅÊâãÂä®Â°´ÂÜôÂú∞ÂùÄ
          }
          return false;
        }},
        { pattern: /\[Detailed Description\]|\[ËØ¶ÁªÜÊèèËø∞\]/i, field: '‰∫ßÂìÅÂäüËÉΩËØ¶ÁªÜÊèèËø∞', check: () => {
          // ÂØπ‰∫éÊèê‰æõ‰∫ßÂìÅ‰ø°ÊÅØÁöÑÂä®‰Ωú
          if (actionObj && actionObj.id === 'provide_info') {
            return true; // ÈúÄË¶ÅË°•ÂÖÖ‰∫ßÂìÅÂäüËÉΩÊèèËø∞
          }
          return false;
        }},
        { pattern: /\[Value\]|\[ÂÄº\]/i, field: 'ÊäÄÊúØÂèÇÊï∞ÂÄº', check: () => {
          // ÂØπ‰∫éÊèê‰æõ‰∫ßÂìÅ‰ø°ÊÅØÁöÑÂä®‰Ωú
          if (actionObj && actionObj.id === 'provide_info') {
            return true; // ÈúÄË¶ÅË°•ÂÖÖÊäÄÊúØÂèÇÊï∞
          }
          return false;
        }},
        { pattern: /\[Usage Instructions\]|\[‰ΩøÁî®ËØ¥Êòé\]/i, field: '‰ΩøÁî®ËØ¥Êòé', check: () => {
          // ÂØπ‰∫éÊèê‰æõ‰∫ßÂìÅ‰ø°ÊÅØÁöÑÂä®‰Ωú
          if (actionObj && actionObj.id === 'provide_info') {
            return true; // ÈúÄË¶ÅË°•ÂÖÖ‰ΩøÁî®ËØ¥Êòé
          }
          return false;
        }},
        { pattern: /\[Other policy information\]|\[ÂÖ∂‰ªñÊîøÁ≠ñ‰ø°ÊÅØ\]/i, field: 'ÂÖ∂‰ªñÊîøÁ≠ñ‰ø°ÊÅØ', check: () => {
          // ÂØπ‰∫éÊîøÁ≠ñÂí®ËØ¢ÁöÑÂä®‰Ωú
          if (actionObj && actionObj.id === 'provide_policy') {
            return true; // ÂèØËÉΩÈúÄË¶ÅË°•ÂÖÖÂÖ∂‰ªñÊîøÁ≠ñ‰ø°ÊÅØ
          }
          return false;
        }},
        { pattern: /\[Action-specific content based on selected action\]/i, field: 'Âä®‰ΩúÁâπÂÆöÂÜÖÂÆπ', check: () => {
          // Â¶ÇÊûúÂåÖÂê´Ëøô‰∏™Âç†‰ΩçÁ¨¶ÔºåËØ¥ÊòéÈúÄË¶ÅË°•ÂÖÖÂä®‰ΩúÁâπÂÆöÂÜÖÂÆπ
          return email.includes('[Action-specific content based on selected action]');
        }}
      ];
      
      // Ê£ÄÊü•ÊØè‰∏™Âç†‰ΩçÁ¨¶
      placeholders.forEach(placeholder => {
        if (placeholder.pattern.test(email) && placeholder.check()) {
          missingFields.push(placeholder.field);
        }
      });
      
      return missingFields;
    }

    // ÁîüÊàêÂπ∂ÊòæÁ§∫ÈÇÆ‰ª∂ÔºàÂÜÖÈÉ®ÂáΩÊï∞Ôºå‰æõ selectAction Âíå regenerateEmail Ë∞ÉÁî®Ôºâ
    async function generateAndDisplayEmail(action, isRegenerate = false) {
      const emailPreviewContainer = document.getElementById('emailPreviewContainer');
      const emailPreview = document.getElementById('emailPreview');
      
      // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      emailPreview.value = 'Ê≠£Âú®ÁîüÊàêÈÇÆ‰ª∂...';
      emailPreviewContainer.classList.remove('hidden');
      
      // Ê∑ªÂä†ÈÇÆ‰ª∂ÂÜÖÂÆπÂèòÂåñÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÊ∑ªÂä†Ôºâ
      if (emailPreview && !emailPreview.hasAttribute('data-listener-added')) {
        emailPreview.addEventListener('input', () => {
          // ÂΩìÁî®Êà∑‰øÆÊîπÈÇÆ‰ª∂ÂÜÖÂÆπÊó∂ÔºåÂÆûÊó∂Êõ¥Êñ∞ actionEmails
          if (appState.selectedAction) {
            appState.actionEmails[appState.selectedAction.id] = emailPreview.value;
            appState.generatedEmail = emailPreview.value;
          }
        });
        emailPreview.setAttribute('data-listener-added', 'true');
      }
      
      try {
        const email = await callAIGenerateEmail(
          appState.scenario,
          appState.subScenario,
          appState.processNode,
          action,
          appState.ticketData,
          appState.orderInfo,
          appState.products
        );
        
        appState.generatedEmail = email;
        // ‰øùÂ≠òËØ•Âä®‰ΩúÁöÑÈÇÆ‰ª∂ÂÜÖÂÆπ
        appState.actionEmails[action.id] = email;
        
        // ÊòæÁ§∫ÈÇÆ‰ª∂ÂÜÖÂÆπ
        emailPreview.value = email;
        
        // ËÆ∞ÂΩïÈÇÆ‰ª∂ÁîüÊàêÂéÜÂè≤ÔºàAIÁîüÊàêÔºâ
        const historyItem = {
          id: Date.now(),
          generateTime: new Date().toLocaleString('zh-CN'),
          updateType: 'AIÁîüÊàê',
          action: action.name || 'Êú™Áü•Âä®‰Ωú',
          scenario: `${appState.scenario || ''}${appState.subScenario ? ' - ' + appState.subScenario : ''}`,
          content: email,
          sent: false,
          copied: false
        };
        appState.emailHistory.unshift(historyItem); // Ê∑ªÂä†Âà∞ÂºÄÂ§¥ÔºåÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢
        appState.currentHistoryId = historyItem.id; // ‰øùÂ≠òÂΩìÂâçÂéÜÂè≤ËÆ∞ÂΩïÁöÑID
        
        // ÊòæÁ§∫ÂèçÈ¶àÂå∫Âüü
        const feedbackContainer = document.getElementById('emailFeedbackContainer');
        if (feedbackContainer) {
          feedbackContainer.classList.remove('hidden');
          // ÈáçÁΩÆÂèçÈ¶àÁä∂ÊÄÅ
          resetFeedbackState();
        }
        
      } catch (error) {
        console.error(error);
        emailPreview.value = 'ÁîüÊàêÈÇÆ‰ª∂Â§±Ë¥•Ôºö' + error.message;
        // ÈöêËóèÂèçÈ¶àÂå∫ÂüüÔºàÁîüÊàêÂ§±Ë¥•Êó∂Ôºâ
        const feedbackContainer = document.getElementById('emailFeedbackContainer');
        if (feedbackContainer) {
          feedbackContainer.classList.add('hidden');
        }
      }
    }

    // ÈÄâÊã©Âä®‰ΩúÂπ∂ÁîüÊàêÈÇÆ‰ª∂
    async function selectAction(action) {
      currentSelectedAction = action;
      appState.selectedAction = action; // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÂä®‰Ωú
      
      // ÈáçÁΩÆÈÇÆ‰ª∂Ë¥®ÈáèÂèçÈ¶àÁªÑ‰ª∂Áä∂ÊÄÅ
      resetFeedbackState();
      
      // Êõ¥Êñ∞Âä®‰ΩúÂç°ÁâáÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
      const actionsContainer = document.getElementById('actionsContainer');
      if (actionsContainer) {
        // ÁßªÈô§ÊâÄÊúâÂç°ÁâáÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
        actionsContainer.querySelectorAll('.action-card').forEach(card => {
          card.classList.remove('selected');
        });
        // ÊâæÂà∞ÂØπÂ∫îÁöÑÂä®‰ΩúÂç°ÁâáÂπ∂Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
        const cards = actionsContainer.querySelectorAll('.action-card');
        cards.forEach(card => {
          const cardText = card.textContent.trim();
          const actionName = action.displayName || action.name;
          // ÂåπÈÖçÈÄªËæëÔºö‰ºòÂÖàÂåπÈÖçdisplayNameÊàñnameÔºåÂÖ∂Ê¨°ÂåπÈÖçidÔºàÂØπ‰∫éËØ¢ÈóÆÂÆ¢Êà∑Á≠âÁâπÊÆäÂä®‰ΩúÔºâ
          if (cardText === actionName || 
              cardText === action.name ||
              (action.id === 'ask_info' && (cardText.includes('ËØ¢ÈóÆÂÆ¢Êà∑') || cardText.includes('ËØ¢ÈóÆ')))) {
            card.classList.add('selected');
          }
        });
      }
      
      const emailPreviewContainer = document.getElementById('emailPreviewContainer');
      const emailPreview = document.getElementById('emailPreview');
      
      // Ê£ÄÊü•ËØ•Âä®‰ΩúÊòØÂê¶Â∑≤ÁªèÁîüÊàêËøáÈÇÆ‰ª∂
      if (appState.actionEmails[action.id]) {
        // Â¶ÇÊûúÂ∑≤ÁîüÊàêËøáÔºåÁõ¥Êé•ÊòæÁ§∫‰πãÂâçÁöÑÈÇÆ‰ª∂
        const savedEmail = appState.actionEmails[action.id];
        appState.generatedEmail = savedEmail;
        emailPreview.value = savedEmail;
        emailPreviewContainer.classList.remove('hidden');
        
        // Ê∑ªÂä†ÈÇÆ‰ª∂ÂÜÖÂÆπÂèòÂåñÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÊ∑ªÂä†Ôºâ
        if (emailPreview && !emailPreview.hasAttribute('data-listener-added')) {
          emailPreview.addEventListener('input', () => {
            // ÂΩìÁî®Êà∑‰øÆÊîπÈÇÆ‰ª∂ÂÜÖÂÆπÊó∂ÔºåÂÆûÊó∂Êõ¥Êñ∞ actionEmails
            if (appState.selectedAction) {
              appState.actionEmails[appState.selectedAction.id] = emailPreview.value;
              appState.generatedEmail = emailPreview.value;
            }
          });
          emailPreview.setAttribute('data-listener-added', 'true');
        }
        
        // ÊòæÁ§∫ÂèçÈ¶àÂå∫Âüü
        const feedbackContainer = document.getElementById('emailFeedbackContainer');
        if (feedbackContainer) {
          feedbackContainer.classList.remove('hidden');
        }
      } else {
        // Â¶ÇÊûúÊú™ÁîüÊàêËøáÔºåÁîüÊàêÊñ∞ÈÇÆ‰ª∂
        await generateAndDisplayEmail(action);
      }
    }

    // ÈáçÊñ∞ÁîüÊàêÂΩìÂâçÂä®‰ΩúÁöÑÈÇÆ‰ª∂
    async function regenerateEmail() {
      if (!appState.selectedAction) {
        alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÈÇÆ‰ª∂Âä®‰Ωú');
        return;
      }
      
      await generateAndDisplayEmail(appState.selectedAction, true);
    }

    // ÂèëÈÄÅÈÇÆ‰ª∂
    function sendEmail() {
      const emailPreview = document.getElementById('emailPreview');
      const emailContent = emailPreview ? emailPreview.value : appState.generatedEmail;
      
      if (!emailContent) {
        alert('ÈÇÆ‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫ÔºåÊó†Ê≥ïÂèëÈÄÅ');
        return;
      }
      
      // ‰∫åÊ¨°Á°ÆËÆ§ÂºπÁ™ó
      if (confirm('Á°ÆÂÆöË¶ÅÂèëÈÄÅËøôÂ∞ÅÈÇÆ‰ª∂ÂêóÔºü\n\nÂèëÈÄÅÂêéÂ∞ÜÊó†Ê≥ïÊí§ÂõûÔºåËØ∑Á°ÆËÆ§ÈÇÆ‰ª∂ÂÜÖÂÆπÊó†ËØØ„ÄÇ')) {
        // Á°ÆËÆ§ÂèëÈÄÅ
        const textarea = document.getElementById('replyTextarea');
        if (textarea) {
          textarea.value = emailContent;
          textarea.focus();
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçÈÇÆ‰ª∂ÂÜÖÂÆπ
        appState.generatedEmail = emailContent;
        
        // Êõ¥Êñ∞ÂΩìÂâçÂä®‰ΩúÁöÑÈÇÆ‰ª∂ÂÜÖÂÆπÔºàÂ¶ÇÊûúÂΩìÂâçÊúâÈÄâ‰∏≠ÁöÑÂä®‰ΩúÔºâ
        if (appState.selectedAction) {
          appState.actionEmails[appState.selectedAction.id] = emailContent;
        }
        
        // Ê£ÄÊü•ÈÇÆ‰ª∂ÊòØÂê¶Ë¢´‰øÆÊîπËøá
        let isModified = false;
        if (appState.currentHistoryId !== undefined) {
          const historyItem = appState.emailHistory.find(item => item.id === appState.currentHistoryId);
          if (historyItem && historyItem.content !== emailContent) {
            isModified = true;
          }
        }
        
        // Â¶ÇÊûúÈÇÆ‰ª∂Ë¢´‰øÆÊîπËøáÔºåÊ∑ªÂä†‰∏ÄÊù°ÊâãÂä®‰øÆÊîπÁöÑÈÇÆ‰ª∂ÂéÜÂè≤
        if (isModified) {
          const currentAction = currentSelectedAction || { name: 'Êú™Áü•Âä®‰Ωú' };
          const historyItem = {
            id: Date.now(),
            generateTime: new Date().toLocaleString('zh-CN'),
            updateType: 'ÊâãÂä®‰øÆÊîπ',
            action: currentAction.name || 'Êú™Áü•Âä®‰Ωú',
            scenario: `${appState.scenario || ''}${appState.subScenario ? ' - ' + appState.subScenario : ''}`,
            content: emailContent,
            sent: true,
            copied: false
          };
          appState.emailHistory.unshift(historyItem); // Ê∑ªÂä†Âà∞ÂºÄÂ§¥ÔºåÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢
          appState.currentHistoryId = historyItem.id; // Êõ¥Êñ∞ÂΩìÂâçÂéÜÂè≤ËÆ∞ÂΩïÁöÑID
        } else {
          // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÁä∂ÊÄÅ
          if (appState.currentHistoryId !== undefined) {
            const historyItem = appState.emailHistory.find(item => item.id === appState.currentHistoryId);
            if (historyItem) {
              historyItem.sent = true;
              historyItem.content = emailContent; // Êõ¥Êñ∞ÂÜÖÂÆπ
            }
          }
        }
        
        alert('ÈÇÆ‰ª∂Â∑≤ÂèëÈÄÅ');
      }
    }

    // Ê†áËÆ∞ÈÇÆ‰ª∂‰∏∫ÂèØÁî®
    function markEmailUsable() {
      const usableBtn = document.querySelector('.feedback-btn-usable');
      const unusableBtn = document.querySelector('.feedback-btn-unusable');
      const feedbackInputContainer = document.getElementById('feedbackInputContainer');
      
      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      if (usableBtn) {
        usableBtn.classList.add('active');
      }
      if (unusableBtn) {
        unusableBtn.classList.remove('active');
      }
      
      // ÈöêËóèÂèçÈ¶àËæìÂÖ•Ê°Ü
      if (feedbackInputContainer) {
        feedbackInputContainer.classList.add('hidden');
      }
      
      // ‰øùÂ≠òÂèçÈ¶àÁä∂ÊÄÅ
      const feedback = {
        status: 'usable',
        feedback: '',
        timestamp: new Date().toLocaleString('zh-CN')
      };
      
      appState.emailFeedback = feedback;
      
      // Â∞ÜÂèçÈ¶à‰øùÂ≠òÂà∞ÂΩìÂâçÂä®‰Ωú‰∏ãÊúÄÊñ∞ÁîüÊàêÁöÑAIÈÇÆ‰ª∂ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠
      const currentAction = appState.selectedAction;
      if (currentAction) {
        // ÊâæÂà∞ÂΩìÂâçÂä®‰Ωú‰∏ãÊâÄÊúâAIÁîüÊàêÁöÑÈÇÆ‰ª∂ÔºåÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÔºåÂèñÊúÄÊñ∞ÁöÑ
        const aiEmails = appState.emailHistory.filter(item => 
          (item.updateType || 'AIÁîüÊàê') === 'AIÁîüÊàê' && 
          item.action === currentAction.name
        );
        
        if (aiEmails.length > 0) {
          // emailHistoryÂ∑≤ÁªèÊòØÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÁöÑÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢ÔºâÔºåÊâÄ‰ª•Áõ¥Êé•ÂèñÁ¨¨‰∏Ä‰∏™
          aiEmails[0].feedback = feedback;
        }
      }
      
      // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂèëÈÄÅÂèçÈ¶àÂà∞ÊúçÂä°Âô®ÁöÑÈÄªËæë
      console.log('ÈÇÆ‰ª∂Ê†áËÆ∞‰∏∫ÂèØÁî®', appState.emailFeedback);
      
      // ÂèØÈÄâÔºöÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      // alert('Â∑≤Ê†áËÆ∞‰∏∫ÂèØÁî®');
    }

    // Ê†áËÆ∞ÈÇÆ‰ª∂‰∏∫‰∏çÂèØÁî®
    function markEmailUnusable() {
      const usableBtn = document.querySelector('.feedback-btn-usable');
      const unusableBtn = document.querySelector('.feedback-btn-unusable');
      const feedbackInputContainer = document.getElementById('feedbackInputContainer');
      
      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      if (usableBtn) {
        usableBtn.classList.remove('active');
      }
      if (unusableBtn) {
        unusableBtn.classList.add('active');
      }
      
      // ÊòæÁ§∫ÂèçÈ¶àËæìÂÖ•Ê°Ü
      if (feedbackInputContainer) {
        feedbackInputContainer.classList.remove('hidden');
        const feedbackInput = document.getElementById('feedbackInput');
        if (feedbackInput) {
          // Â¶ÇÊûúÂ≠òÂú®‰πãÂâçÁöÑÂèçÈ¶àÂÜÖÂÆπÔºåÂ°´ÂÖÖÂà∞ËæìÂÖ•Ê°Ü
          if (appState.emailFeedback && appState.emailFeedback.status === 'unusable' && appState.emailFeedback.feedback) {
            feedbackInput.value = appState.emailFeedback.feedback;
          } else {
            feedbackInput.value = '';
          }
          // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
          setTimeout(() => feedbackInput.focus(), 100);
        }
      }
    }

    // Êèê‰∫§ÂèçÈ¶à
    function submitFeedback() {
      const feedbackInput = document.getElementById('feedbackInput');
      const feedbackText = feedbackInput ? feedbackInput.value.trim() : '';
      
      if (!feedbackText) {
        alert('ËØ∑Â°´ÂÜôËØ¶ÁªÜÂèçÈ¶àÂÜÖÂÆπ');
        return;
      }
      
      // ‰øùÂ≠òÂèçÈ¶àÁä∂ÊÄÅ
      const feedback = {
        status: 'unusable',
        feedback: feedbackText,
        timestamp: new Date().toLocaleString('zh-CN'),
        emailId: appState.currentHistoryId,
        emailContent: appState.generatedEmail,
        action: appState.selectedAction ? appState.selectedAction.name : 'Êú™Áü•Âä®‰Ωú',
        scenario: `${appState.scenario || ''}${appState.subScenario ? ' - ' + appState.subScenario : ''}`
      };
      
      appState.emailFeedback = feedback;
      
      // Â∞ÜÂèçÈ¶à‰øùÂ≠òÂà∞ÂΩìÂâçÂä®‰Ωú‰∏ãÊúÄÊñ∞ÁîüÊàêÁöÑAIÈÇÆ‰ª∂ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠
      const currentAction = appState.selectedAction;
      if (currentAction) {
        // ÊâæÂà∞ÂΩìÂâçÂä®‰Ωú‰∏ãÊâÄÊúâAIÁîüÊàêÁöÑÈÇÆ‰ª∂ÔºåÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÔºåÂèñÊúÄÊñ∞ÁöÑ
        const aiEmails = appState.emailHistory.filter(item => 
          (item.updateType || 'AIÁîüÊàê') === 'AIÁîüÊàê' && 
          item.action === currentAction.name
        );
        
        if (aiEmails.length > 0) {
          // emailHistoryÂ∑≤ÁªèÊòØÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÁöÑÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢ÔºâÔºåÊâÄ‰ª•Áõ¥Êé•ÂèñÁ¨¨‰∏Ä‰∏™
          aiEmails[0].feedback = feedback;
        }
      }
      
      // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂèëÈÄÅÂèçÈ¶àÂà∞ÊúçÂä°Âô®ÁöÑÈÄªËæë
      console.log('Êèê‰∫§ÂèçÈ¶à', appState.emailFeedback);
      
      // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      alert('ÂèçÈ¶àÂ∑≤Êèê‰∫§ÔºåÊÑüË∞¢ÊÇ®ÁöÑÂèçÈ¶àÔºÅ');
      
      // Êèê‰∫§Âêé‰øùÊåÅ"‰∏çÂèØÁî®"ÊåâÈíÆÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÔºåÂè™ÈöêËóèËæìÂÖ•Ê°Ü
      const feedbackInputContainer = document.getElementById('feedbackInputContainer');
      if (feedbackInputContainer) {
        feedbackInputContainer.classList.add('hidden');
      }
      
      // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂÜÖÂÆπ
      if (feedbackInput) {
        feedbackInput.value = '';
      }
      
      // ‰øùÊåÅ"‰∏çÂèØÁî®"ÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅÔºå‰∏çÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
    }

    // ÂèñÊ∂àÂèçÈ¶à
    function cancelFeedback() {
      resetFeedbackState();
    }

    // ÈáçÁΩÆÂèçÈ¶àÁä∂ÊÄÅ
    function resetFeedbackState() {
      const usableBtn = document.querySelector('.feedback-btn-usable');
      const unusableBtn = document.querySelector('.feedback-btn-unusable');
      const feedbackInputContainer = document.getElementById('feedbackInputContainer');
      const feedbackInput = document.getElementById('feedbackInput');
      
      // ÁßªÈô§ÊåâÈíÆÊøÄÊ¥ªÁä∂ÊÄÅ
      if (usableBtn) {
        usableBtn.classList.remove('active');
      }
      if (unusableBtn) {
        unusableBtn.classList.remove('active');
      }
      
      // ÈöêËóèÂèçÈ¶àËæìÂÖ•Ê°Ü
      if (feedbackInputContainer) {
        feedbackInputContainer.classList.add('hidden');
      }
      
      // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
      if (feedbackInput) {
        feedbackInput.value = '';
      }
    }

    // Â§çÂà∂ÈÇÆ‰ª∂
    function copyEmail() {
      const emailPreview = document.getElementById('emailPreview');
      const emailContent = emailPreview ? emailPreview.value : appState.generatedEmail;
      
      if (emailContent) {
        navigator.clipboard.writeText(emailContent).then(() => {
          alert('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
          
          // Êõ¥Êñ∞ÂΩìÂâçÈÇÆ‰ª∂ÂÜÖÂÆπ
          appState.generatedEmail = emailContent;
          
          // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÁä∂ÊÄÅ
          if (appState.currentHistoryId !== undefined) {
            const historyItem = appState.emailHistory.find(item => item.id === appState.currentHistoryId);
            if (historyItem) {
              historyItem.copied = true;
              historyItem.content = emailContent; // Êõ¥Êñ∞ÂÜÖÂÆπ
            }
          }
        }).catch(err => {
          console.error('Â§çÂà∂Â§±Ë¥•Ôºö', err);
          alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
        });
      }
    }

    // ÊòæÁ§∫Êõ¥Êñ∞ÂéÜÂè≤
    function showUpdateHistory() {
      const modal = document.getElementById('updateHistoryModal');
      const tableBody = document.getElementById('updateHistoryTableBody');
      const emptyDiv = document.getElementById('updateHistoryEmpty');
      
      if (appState.updateHistory.length === 0) {
        tableBody.innerHTML = '';
        emptyDiv.style.display = 'block';
      } else {
        emptyDiv.style.display = 'none';
        tableBody.innerHTML = appState.updateHistory.map(item => {
          // ËΩ¨‰πâHTMLÁâπÊÆäÂ≠óÁ¨¶
          const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };
          
          return `
            <tr>
              <td>${escapeHtml(item.updateTime)}</td>
              <td>
                <span class="update-type-badge ${item.updateType === 'AIÁîüÊàê' ? 'ai-update' : 'manual-update'}">
                  ${escapeHtml(item.updateType === 'AIÊõ¥Êñ∞' ? 'AIÁîüÊàê' : item.updateType === 'ÊâãÂä®Êõ¥Êñ∞' ? 'ÊâãÂä®‰øÆÊîπ' : item.updateType)}
                </span>
              </td>
              <td>
                <div class="update-log">${escapeHtml(item.updateLog)}</div>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      modal.style.display = 'flex';
    }

    // ÂÖ≥Èó≠Êõ¥Êñ∞ÂéÜÂè≤ÂºπÁ™ó
    function closeUpdateHistoryModal() {
      const modal = document.getElementById('updateHistoryModal');
      modal.style.display = 'none';
    }

    // ÊòæÁ§∫ÈÇÆ‰ª∂ÂéÜÂè≤
    function showEmailHistory() {
      const modal = document.getElementById('emailHistoryModal');
      const tableBody = document.getElementById('emailHistoryTableBody');
      const emptyDiv = document.getElementById('emailHistoryEmpty');
      
      // ËΩ¨‰πâHTMLÁâπÊÆäÂ≠óÁ¨¶
      const escapeHtml = (text) => {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      };
      
      // Ëé∑ÂèñÁ≠õÈÄâÊù°‰ª∂
      const searchInput = document.getElementById('emailHistorySearchInput');
      const actionFilter = document.getElementById('emailHistoryActionFilter');
      const scenarioFilter = document.getElementById('emailHistoryScenarioFilter');
      const sourceFilter = document.getElementById('emailHistorySourceFilter');
      
      const searchText = searchInput ? searchInput.value.trim().toLowerCase() : '';
      const selectedAction = actionFilter ? actionFilter.value : '';
      const selectedScenario = scenarioFilter ? scenarioFilter.value : '';
      const selectedSource = sourceFilter ? sourceFilter.value : '';
      
      // ÂàùÂßãÂåñÁ≠õÈÄâ‰∏ãÊãâÊ°Ü
      if (actionFilter) {
        const actions = [...new Set(appState.emailHistory.map(item => item.action))];
        actionFilter.innerHTML = '<option value="">ÂÖ®ÈÉ®Âä®‰Ωú</option>' + 
          actions.map(action => `<option value="${escapeHtml(action)}">${escapeHtml(action)}</option>`).join('');
        if (selectedAction) {
          actionFilter.value = selectedAction;
        }
      }
      
      if (scenarioFilter) {
        const scenarios = [...new Set(appState.emailHistory.map(item => item.scenario || '').filter(s => s))];
        scenarioFilter.innerHTML = '<option value="">ÂÖ®ÈÉ®Âú∫ÊôØ</option>' + 
          scenarios.map(scenario => `<option value="${escapeHtml(scenario)}">${escapeHtml(scenario)}</option>`).join('');
        if (selectedScenario) {
          scenarioFilter.value = selectedScenario;
        }
      }
      
      // Á≠õÈÄâÈÇÆ‰ª∂ÂéÜÂè≤
      const filteredHistory = appState.emailHistory.filter(item => {
        // ÊêúÁ¥¢ÂÜÖÂÆπ
        if (searchText && !item.content.toLowerCase().includes(searchText)) {
          return false;
        }
        // Á≠õÈÄâÂä®‰Ωú
        if (selectedAction && item.action !== selectedAction) {
          return false;
        }
        // Á≠õÈÄâÂú∫ÊôØ
        if (selectedScenario && item.scenario && !item.scenario.includes(selectedScenario)) {
          return false;
        }
        // Á≠õÈÄâÊù•Ê∫ê
        if (selectedSource) {
          const updateType = item.updateType || 'AIÁîüÊàê';
          if (selectedSource === 'AIÁîüÊàê' && updateType !== 'AIÁîüÊàê') {
            return false;
          }
          if (selectedSource === 'ÊâãÂä®‰øÆÊîπ' && updateType !== 'ÊâãÂä®‰øÆÊîπ') {
            return false;
          }
        }
        return true;
      });
      
      if (filteredHistory.length === 0) {
        tableBody.innerHTML = '';
        emptyDiv.style.display = 'block';
      } else {
        emptyDiv.style.display = 'none';
        
        tableBody.innerHTML = filteredHistory.map(item => {
          
          const contentPreview = item.content.length > 50 
            ? item.content.substring(0, 50) + '...' 
            : item.content;
          const escapedContent = escapeHtml(item.content);
          const escapedPreview = escapeHtml(contentPreview);
          
          // Êù•Ê∫êÔºåÈªòËÆ§‰∏∫AIÁîüÊàêÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
          const updateType = item.updateType || 'AIÁîüÊàê';
          const updateTypeClass = updateType === 'AIÁîüÊàê' ? 'ai-update' : 'manual-update';
          
          return `
            <tr>
              <td>${escapeHtml(item.generateTime)}</td>
              <td>
                <span class="update-type-badge ${updateTypeClass}">
                  ${escapeHtml(updateType)}
                </span>
              </td>
              <td>${escapeHtml(item.action)}</td>
              <td>${escapeHtml(item.scenario || '-')}</td>
              <td>
                <span class="email-history-content" title="${escapedContent.replace(/"/g, '&quot;')}" onclick="showFullEmailContent(${item.id})">
                  ${escapedPreview}
                </span>
              </td>
              <td>
                <span class="email-history-status ${item.sent ? 'yes' : 'no'}">
                  ${item.sent ? 'ÊòØ' : 'Âê¶'}
                </span>
              </td>
              <td>
                ${(item.updateType || 'AIÁîüÊàê') === 'AIÁîüÊàê' && item.feedback && item.feedback.status ? 
                  `<span class="email-history-feedback" style="cursor: pointer; color: ${item.feedback.status === 'usable' ? '#065f46' : '#991b1b'};" onclick="showEmailFeedback(${item.id})" title="${escapeHtml(item.feedback.feedback || 'ÁÇπÂáªÊü•ÁúãË¥®ÈáèÂèçÈ¶à')}">
                    ${item.feedback.status === 'usable' ? 'ÂèØÁî®' : '‰∏çÂèØÁî®'}${item.feedback.feedback && item.feedback.feedback.length > 0 ? ' - ' + escapeHtml(item.feedback.feedback.length > 20 ? item.feedback.feedback.substring(0, 20) + '...' : item.feedback.feedback) : ''}
                  </span>` : 
                  (item.updateType || 'AIÁîüÊàê') === 'AIÁîüÊàê' ? '-' : '-'
                }
              </td>
            </tr>
          `;
        }).join('');
      }
      
      modal.style.display = 'flex';
      
      // ÁªëÂÆöÁ≠õÈÄâ‰∫ã‰ª∂
      if (searchInput) {
        searchInput.oninput = () => showEmailHistory();
      }
      if (actionFilter) {
        actionFilter.onchange = () => showEmailHistory();
      }
      if (scenarioFilter) {
        scenarioFilter.onchange = () => showEmailHistory();
      }
      if (sourceFilter) {
        sourceFilter.onchange = () => showEmailHistory();
      }
    }
    
    // ÊòæÁ§∫ÈÇÆ‰ª∂Ë¥®ÈáèÂèçÈ¶àËØ¶ÊÉÖ
    function showEmailFeedback(historyId) {
      const historyItem = appState.emailHistory.find(item => item.id === historyId);
      if (historyItem && historyItem.feedback) {
        const feedback = historyItem.feedback;
        const feedbackText = feedback.feedback || 'Êó†ËØ¶ÁªÜÂèçÈ¶à';
        const statusText = feedback.status === 'usable' ? 'ÂèØÁî®' : '‰∏çÂèØÁî®';
        const statusColor = feedback.status === 'usable' ? '#065f46' : '#991b1b';
        
        alert(`Ë¥®ÈáèÂèçÈ¶àÔºö${statusText}\n\nËØ¶ÁªÜÂèçÈ¶àÔºö${feedbackText}\n\nÂèçÈ¶àÊó∂Èó¥Ôºö${feedback.timestamp || 'Êú™Áü•'}`);
      }
    }

    // ÂÖ≥Èó≠ÈÇÆ‰ª∂ÂéÜÂè≤ÂºπÁ™ó
    function closeEmailHistoryModal() {
      const modal = document.getElementById('emailHistoryModal');
      modal.style.display = 'none';
    }

    // ÊòæÁ§∫ÂÆåÊï¥ÈÇÆ‰ª∂ÂÜÖÂÆπ
    function showFullEmailContent(historyId) {
      const historyItem = appState.emailHistory.find(item => item.id === historyId);
      if (historyItem) {
        // ÂàõÂª∫‰∏Ä‰∏™Êõ¥Â•ΩÁöÑÊòæÁ§∫ÊñπÂºèÔºå‰ΩøÁî®ÊñáÊú¨Âå∫Âüü
        const textarea = document.createElement('textarea');
        textarea.value = historyItem.content;
        textarea.style.width = '600px';
        textarea.style.height = '400px';
        textarea.style.padding = '10px';
        textarea.style.fontSize = '13px';
        textarea.style.fontFamily = 'monospace';
        textarea.readOnly = true;
        
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.zIndex = '20000';
        modal.style.left = '0';
        modal.style.top = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        
        const content = document.createElement('div');
        content.style.backgroundColor = '#fff';
        content.style.borderRadius = '8px';
        content.style.padding = '20px';
        content.style.position = 'relative';
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'ÂÖ≥Èó≠';
        closeBtn.style.marginTop = '10px';
        closeBtn.style.padding = '8px 16px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.onclick = () => document.body.removeChild(modal);
        
        content.appendChild(textarea);
        content.appendChild(closeBtn);
        modal.appendChild(content);
        modal.onclick = (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };
        
        document.body.appendChild(modal);
        textarea.select();
      }
    }

    // Â∫îÁî®ÂêØÂä®
    document.addEventListener('DOMContentLoaded', () => {
      initApp();
    });

    // ÁºñËæë‰ø°ÊÅØÂºπÁ™óÁõ∏ÂÖ≥ÂáΩÊï∞
    function openEditInfoModal() {
      const modal = document.getElementById('editInfoModal');
      modal.style.display = 'flex';
      // ÈªòËÆ§ÊòæÁ§∫Á¨¨‰∏Ä‰∏™tabÔºàÂ∑•ÂçïÂú∫ÊôØÔºâ
      switchEditTab('scenario');
    }

    function closeEditInfoModal() {
      const modal = document.getElementById('editInfoModal');
      modal.style.display = 'none';
    }

    function switchEditTab(tabName) {
      // Êõ¥Êñ∞tabÊåâÈíÆÁä∂ÊÄÅ
      const tabButtons = document.querySelectorAll('.edit-tab-btn');
      tabButtons.forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Âä†ËΩΩÂØπÂ∫îtabÁöÑÂÜÖÂÆπ
      const fieldsContainer = document.getElementById('editTabContent');
      let html = '';

      if (tabName === 'scenario') {
        // Â∑•ÂçïÂú∫ÊôØ
        html = `
          <div class="edit-field-group">
            <label class="edit-field-label">Âú∫ÊôØÔºö</label>
            <select id="editScenarioField" class="edit-field-input">
              <option value="ÂîÆÂâçÂí®ËØ¢">ÂîÆÂâçÂí®ËØ¢</option>
              <option value="ËÆ¢ÂçïÈóÆÈ¢ò">ËÆ¢ÂçïÈóÆÈ¢ò</option>
              <option value="‰∫ßÂìÅÈóÆÈ¢ò">‰∫ßÂìÅÈóÆÈ¢ò</option>
              <option value="ÂîÆÂêéÊúçÂä°">ÂîÆÂêéÊúçÂä°</option>
            </select>
          </div>
          <div class="edit-field-group">
            <label class="edit-field-label">Â≠êÂú∫ÊôØÔºö</label>
            <select id="editSubScenarioField" class="edit-field-input"></select>
          </div>
        `;
        fieldsContainer.innerHTML = html;
        // ËÆæÁΩÆÂΩìÂâçÂÄº
        setTimeout(() => {
          const scenarioSelect = document.getElementById('editScenarioField');
          const subScenarioSelect = document.getElementById('editSubScenarioField');
          if (appState.scenario) {
            scenarioSelect.value = appState.scenario;
            updateSubScenarioOptions(scenarioSelect.value, subScenarioSelect);
            if (appState.subScenario) {
              subScenarioSelect.value = appState.subScenario;
            }
          }
          scenarioSelect.addEventListener('change', function() {
            updateSubScenarioOptions(this.value, subScenarioSelect);
          });
        }, 0);
      } else if (tabName === 'order') {
        // ËÆ¢Âçï‰ø°ÊÅØ
        const orderInfo = appState.orderInfo || {};
        html = `
          <div class="edit-field-group">
            <label class="edit-field-label">Ë¥≠‰π∞Ê∏†ÈÅìÔºö</label>
            <input type="text" id="editChannelField" class="edit-field-input" value="${orderInfo.channel || ''}" placeholder="ËæìÂÖ•Ë¥≠‰π∞Ê∏†ÈÅì">
          </div>
          <div class="edit-field-group">
            <label class="edit-field-label">ËÆ¢ÂçïÂè∑Ôºö</label>
            <input type="text" id="editOrderNumberField" class="edit-field-input" value="${orderInfo.orderNumber || ''}" placeholder="ËæìÂÖ•ËÆ¢ÂçïÂè∑">
          </div>
          <div class="edit-field-group">
            <label class="edit-field-label">ËÆ¢ÂçïÊó•ÊúüÔºö</label>
            <input type="date" id="editOrderDateField" class="edit-field-input" value="${orderInfo.orderDate || ''}">
          </div>
          <div class="edit-field-group">
            <label class="edit-field-label">ËÆ¢Âçï‰∫ßÂìÅÔºö</label>
            <input type="text" id="editOrderProductsField" class="edit-field-input" value="${(orderInfo.products || []).join(', ') || ''}" placeholder="ËæìÂÖ•ËÆ¢Âçï‰∫ßÂìÅÔºåÂ§ö‰∏™Áî®ÈÄóÂè∑ÂàÜÈöî">
          </div>
        `;
        fieldsContainer.innerHTML = html;
      } else if (tabName === 'product') {
        // ‰∫ßÂìÅ‰ø°ÊÅØ
        const products = appState.products || [];
        const productModels = products.map(p => p.model).join(', ') || '';
        html = `
          <div class="edit-field-group">
            <label class="edit-field-label">‰∫ßÂìÅÂûãÂè∑Ôºö</label>
            <input type="text" id="editProductModelsField" class="edit-field-input" value="${productModels}" placeholder="ËæìÂÖ•‰∫ßÂìÅÂûãÂè∑ÔºåÂ§ö‰∏™Áî®ÈÄóÂè∑ÂàÜÈöî">
          </div>
        `;
        fieldsContainer.innerHTML = html;
      } else if (tabName === 'logistics') {
        // Áâ©ÊµÅ‰ø°ÊÅØ
        const logistics = appState.logistics || {};
        html = `
          <div class="edit-field-group">
            <label class="edit-field-label">Áâ©ÊµÅÊâøËøêÂïÜÔºö</label>
            <input type="text" id="editLogisticsCarrierField" class="edit-field-input" value="${logistics.carrier || ''}" placeholder="ËæìÂÖ•Áâ©ÊµÅÊâøËøêÂïÜ">
          </div>
          <div class="edit-field-group">
            <label class="edit-field-label">Áâ©ÊµÅÂçïÂè∑Ôºö</label>
            <input type="text" id="editLogisticsNumberField" class="edit-field-input" value="${logistics.number || ''}" placeholder="ËæìÂÖ•Áâ©ÊµÅÂçïÂè∑">
          </div>
          <div class="edit-field-group">
            <label class="edit-field-label">ÂΩìÂâçÁä∂ÊÄÅÔºö</label>
            <input type="text" id="editLogisticsStatusField" class="edit-field-input" value="${logistics.status || ''}" placeholder="ËæìÂÖ•ÂΩìÂâçÁä∂ÊÄÅ">
          </div>
        `;
        fieldsContainer.innerHTML = html;
      }
    }

    function updateSubScenarioOptions(scenario, selectElement) {
      const subScenarios = {
        'ÂîÆÂâçÂí®ËØ¢': ['‰∫ßÂìÅÂäüËÉΩÂí®ËØ¢', '‰ª∑Ê†ºÂí®ËØ¢', 'ÈÖçÈÄÅÂí®ËØ¢', 'ÈÄÄÊç¢Ë¥ßÊîøÁ≠ñÂí®ËØ¢', 'ÂÖ∂‰ªñÂí®ËØ¢'],
        'ËÆ¢ÂçïÈóÆÈ¢ò': ['ËÆ¢ÂçïÊü•ËØ¢', 'ËÆ¢Âçï‰øÆÊîπ', 'ËÆ¢ÂçïÂèñÊ∂à', 'ÈÄÄÊ¨æÈóÆÈ¢ò', 'ÂÖ∂‰ªñËÆ¢ÂçïÈóÆÈ¢ò'],
        '‰∫ßÂìÅÈóÆÈ¢ò': ['‰∫ßÂìÅË¥®ÈáèÈóÆÈ¢ò', '‰∫ßÂìÅÂäüËÉΩÊïÖÈöú', '‰∫ßÂìÅ‰ΩøÁî®ÈóÆÈ¢ò', 'ÈÖç‰ª∂ÈóÆÈ¢ò', 'ÂÖ∂‰ªñ‰∫ßÂìÅÈóÆÈ¢ò'],
        'ÂîÆÂêéÊúçÂä°': ['Áª¥‰øÆÊúçÂä°', 'ÈÄÄÊç¢Ë¥ßÊúçÂä°', 'ÊäÄÊúØÊîØÊåÅ', 'ÂÖ∂‰ªñÊúçÂä°']
      };

      selectElement.innerHTML = '';
      const options = subScenarios[scenario] || [];
      options.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub;
        option.textContent = sub;
        selectElement.appendChild(option);
      });
    }

    function saveEditInfo() {
      // Ëé∑ÂèñÂΩìÂâçÊøÄÊ¥ªÁöÑtab
      const activeTabBtn = document.querySelector('.edit-tab-btn.active');
      if (!activeTabBtn) {
        alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁºñËæëÁöÑÂÜÖÂÆπÁ±ªÂûã');
        return;
      }
      const contentType = activeTabBtn.dataset.tab;

      try {
        if (contentType === 'scenario') {
          const scenario = document.getElementById('editScenarioField').value;
          const subScenario = document.getElementById('editSubScenarioField').value;
          appState.scenario = scenario;
          appState.subScenario = subScenario;
          updateScenarioDisplay(scenario, subScenario);
          // Êõ¥Êñ∞Âø´Êç∑ÂõûÂ§çÈ°µÈù¢ÁöÑÊòæÁ§∫
          document.getElementById('scenarioBadgeQuick').textContent = `${scenario} - ${subScenario}`;
          // ÈáçÊñ∞ËØÜÂà´ÊµÅÁ®ãËäÇÁÇπ
          identifyProcessNode(scenario, subScenario, appState.ticketData).then(node => {
            appState.processNode = node;
            updateProcessNodeDisplay(node);
            // Êõ¥Êñ∞Âä®‰ΩúÁΩëÊ†º
            const config = scenarioConfig[scenario]?.[subScenario];
            const hasProductInfo = appState.products && appState.products.length > 0;
            const hasOrderInfo = appState.orderInfo && appState.orderInfo.orderNumber && appState.orderInfo.orderNumber !== 'Êú™ËØÜÂà´';
            updateActionsGrid(config, hasProductInfo, hasOrderInfo);
          }).catch(err => {
            console.error('ËØÜÂà´ÊµÅÁ®ãËäÇÁÇπÂ§±Ë¥•Ôºö', err);
          });
        } else if (contentType === 'order') {
          const channel = document.getElementById('editChannelField').value;
          const orderNumber = document.getElementById('editOrderNumberField').value;
          const orderDate = document.getElementById('editOrderDateField').value;
          const products = document.getElementById('editOrderProductsField').value.split(',').map(p => p.trim()).filter(p => p);
          
          if (!appState.orderInfo) appState.orderInfo = {};
          appState.orderInfo.channel = channel;
          appState.orderInfo.orderNumber = orderNumber;
          appState.orderInfo.orderDate = orderDate;
          appState.orderInfo.products = products;
          
          updateOrderInfoDisplay();
          // Êõ¥Êñ∞Âø´Êç∑ÂõûÂ§çÈ°µÈù¢ÁöÑÊòæÁ§∫
          document.getElementById('extractedOrderNumber').textContent = orderNumber || '-';
          document.getElementById('extractedChannel').textContent = channel || '-';
          document.getElementById('extractedOrderDate').textContent = orderDate || '-';
        } else if (contentType === 'product') {
          const productModels = document.getElementById('editProductModelsField').value.split(',').map(p => p.trim()).filter(p => p);
          appState.products = productModels.map(model => ({
            model: model,
            name: `‰∫ßÂìÅ ${model}`,
            image: ''
          }));
          if (!appState.orderInfo) appState.orderInfo = {};
          appState.orderInfo.products = productModels;
          
          updateProductsDisplay();
          // Êõ¥Êñ∞Âø´Êç∑ÂõûÂ§çÈ°µÈù¢ÁöÑÊòæÁ§∫
          document.getElementById('extractedProduct').textContent = productModels.join(', ') || '-';
        } else if (contentType === 'logistics') {
          const carrier = document.getElementById('editLogisticsCarrierField').value;
          const number = document.getElementById('editLogisticsNumberField').value;
          const status = document.getElementById('editLogisticsStatusField').value;
          
          if (!appState.logistics) appState.logistics = {};
          appState.logistics.carrier = carrier;
          appState.logistics.number = number;
          appState.logistics.status = status;
          
          // Êõ¥Êñ∞Áâ©ÊµÅ‰ø°ÊÅØÊòæÁ§∫ÔºàÂ¶ÇÊûúÂ∑•Âçï‰ø°ÊÅØTab‰∏≠ÊúâÊòæÁ§∫Ôºâ
          if (document.getElementById('logisticsCarrierDisplay')) {
            document.getElementById('logisticsCarrierDisplay').textContent = carrier || '-';
            document.getElementById('logisticsNumberDisplay').textContent = number || '-';
            document.getElementById('logisticsStatusDisplay').textContent = status || '-';
          }
        }

        // ‰øùÂ≠òÊõ¥Êñ∞ÂéÜÂè≤ÔºàÊâãÂä®ÁºñËæëÔºâ
        const currentData = getCurrentDataSnapshot();
        const lastUpdate = appState.updateHistory.length > 0 ? appState.updateHistory[0] : null;
        const updateLog = generateUpdateLog(lastUpdate, currentData, 'ÊâãÂä®ÁºñËæë');
        
        // Âè™ÊúâÂú®ÊúâÂÆûÈôÖÊõ¥Êñ∞Êó∂Êâç‰øùÂ≠òÔºàÊâãÂä®ÁºñËæëÂè™ËÆ∞ÂΩïÂèòÂåñÔºâ
        if (updateLog && updateLog !== 'Êó†' && updateLog !== null) {
          const updateHistoryItem = {
            id: Date.now(),
            updateTime: new Date().toLocaleString('zh-CN'),
            updateLog: updateLog,
            updateType: 'ÊâãÂä®‰øÆÊîπ',
            lastData: currentData // ‰øùÂ≠òÂΩìÂâçÊï∞ÊçÆÂø´ÁÖßÔºåÁî®‰∫é‰∏ãÊ¨°ÊØîËæÉ
          };
          
          appState.updateHistory.unshift(updateHistoryItem); // Ê∑ªÂä†Âà∞ÂºÄÂ§¥ÔºåÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢
        }

        closeEditInfoModal();
      } catch (error) {
        console.error('‰øùÂ≠òÂ§±Ë¥•Ôºö', error);
        alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message);
      }
    }

    // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
    window.onclick = function(event) {
      const modal = document.getElementById('editInfoModal');
      if (event.target === modal) {
        closeEditInfoModal();
      }
    }
  </script>

  <!-- ÁºñËæë‰ø°ÊÅØÂºπÁ™ó -->
  <div id="editInfoModal" class="edit-info-modal" style="display: none;">
    <div class="edit-info-modal-content">
      <div class="edit-info-modal-header">
        <h3>ÁºñËæëÂ∑•Âçï‰ø°ÊÅØ</h3>
        <span class="edit-info-modal-close" onclick="closeEditInfoModal()">&times;</span>
      </div>
      <div class="edit-info-modal-tabs">
        <button class="edit-tab-btn active" data-tab="scenario" onclick="switchEditTab('scenario')">
          <span class="tab-icon">üìã</span>
          <span>Â∑•ÂçïÂú∫ÊôØ</span>
        </button>
        <button class="edit-tab-btn" data-tab="order" onclick="switchEditTab('order')">
          <span class="tab-icon">üõí</span>
          <span>ËÆ¢Âçï‰ø°ÊÅØ</span>
        </button>
        <button class="edit-tab-btn" data-tab="product" onclick="switchEditTab('product')">
          <span class="tab-icon">üì¶</span>
          <span>‰∫ßÂìÅ‰ø°ÊÅØ</span>
        </button>
        <button class="edit-tab-btn" data-tab="logistics" onclick="switchEditTab('logistics')">
          <span class="tab-icon">üöö</span>
          <span>Áâ©ÊµÅ‰ø°ÊÅØ</span>
        </button>
      </div>
      <div class="edit-info-modal-body">
        <div id="editTabContent" class="edit-tab-content">
          <!-- TabÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
      </div>
      <div class="edit-info-modal-footer">
        <button class="btn btn-secondary" onclick="closeEditInfoModal()">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="saveEditInfo()">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- ÈÇÆ‰ª∂ÂéÜÂè≤ÂºπÁ™ó -->
  <div id="emailHistoryModal" class="email-history-modal" onclick="if(event.target.id === 'emailHistoryModal') closeEmailHistoryModal()">
    <div class="email-history-modal-content">
      <div class="email-history-modal-header">
        <h3>ÈÇÆ‰ª∂ÂéÜÂè≤</h3>
        <span class="email-history-modal-close" onclick="closeEmailHistoryModal()">&times;</span>
      </div>
      <!-- ÊêúÁ¥¢ÂíåÁ≠õÈÄâÂå∫Âüü -->
      <div class="email-history-filter" style="padding: 15px; border-bottom: 1px solid #e5e7eb;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <input type="text" id="emailHistorySearchInput" placeholder="ÊêúÁ¥¢ÈÇÆ‰ª∂ÂÜÖÂÆπ..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
          <select id="emailHistoryActionFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white;">
            <option value="">ÂÖ®ÈÉ®Âä®‰Ωú</option>
          </select>
          <select id="emailHistoryScenarioFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white;">
            <option value="">ÂÖ®ÈÉ®Âú∫ÊôØ</option>
          </select>
          <select id="emailHistorySourceFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white;">
            <option value="">ÂÖ®ÈÉ®Êù•Ê∫ê</option>
            <option value="AIÁîüÊàê">AIÁîüÊàê</option>
            <option value="ÊâãÂä®‰øÆÊîπ">ÊâãÂä®‰øÆÊîπ</option>
          </select>
        </div>
      </div>
      <div class="email-history-modal-body">
        <table class="email-history-table">
          <thead>
            <tr>
              <th style="width: 150px;">ÁîüÊàê/‰øùÂ≠òÊó∂Èó¥</th>
              <th style="width: 100px;">Êù•Ê∫ê</th>
              <th style="width: 120px;">ÈÇÆ‰ª∂Âä®‰Ωú</th>
              <th style="width: 180px;">ÈÇÆ‰ª∂Âú∫ÊôØ</th>
              <th style="width: 320px;">ÈÇÆ‰ª∂ÂÜÖÂÆπ</th>
              <th style="width: 100px;">ÊòØÂê¶ÂèëÈÄÅ</th>
              <th style="width: 100px;">Ë¥®ÈáèÂèçÈ¶à</th>
            </tr>
          </thead>
          <tbody id="emailHistoryTableBody">
          </tbody>
        </table>
        <div id="emailHistoryEmpty" class="email-history-empty" style="display: none;">
          ÊöÇÊó†ÈÇÆ‰ª∂ÂéÜÂè≤
        </div>
      </div>
    </div>
  </div>

  <!-- Êõ¥Êñ∞ÂéÜÂè≤ÂºπÁ™ó -->
  <div id="updateHistoryModal" class="email-history-modal" onclick="if(event.target.id === 'updateHistoryModal') closeUpdateHistoryModal()">
    <div class="email-history-modal-content">
      <div class="email-history-modal-header">
        <h3>Êõ¥Êñ∞ÂéÜÂè≤</h3>
        <span class="email-history-modal-close" onclick="closeUpdateHistoryModal()">&times;</span>
      </div>
      <div class="email-history-modal-body">
        <table class="email-history-table">
          <thead>
            <tr>
              <th style="width: 180px;">Êõ¥Êñ∞Êó∂Èó¥</th>
              <th style="width: 120px;">Êõ¥Êñ∞ÊñπÂºè</th>
              <th style="width: 600px;">Êõ¥Êñ∞‰ø°ÊÅØÊó•Âøó</th>
            </tr>
          </thead>
          <tbody id="updateHistoryTableBody">
          </tbody>
        </table>
        <div id="updateHistoryEmpty" class="email-history-empty" style="display: none;">
          ÊöÇÊó†Êõ¥Êñ∞ÂéÜÂè≤
        </div>
      </div>
    </div>
  </div>
</body>
</html>